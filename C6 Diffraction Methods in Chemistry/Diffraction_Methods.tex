\documentclass{article}

\usepackage{amsmath,geometry,graphicx,array,makecell,enumitem,bm,booktabs,multirow,pgfplots,bm,amssymb,mathtools,subcaption,cancel,adjustbox}
\usepackage[amsmath]{ntheorem}
\usepackage[hidelinks,naturalnames]{hyperref}
\usepackage[nameinlink,noabbrev]{cleveref}
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhead[L]{\itshape\nouppercase{\leftmark}}
\fancyhead[R]{C6 Diffraction Methods in Chemistry}


\title{Diffraction Methods in Chemistry}
\author{Yue Wu}

\geometry{a4paper,hmargin=1.1in,vmargin=1.2in}

\setlength{\parskip}{1em}
\tolerance=1000
\emergencystretch=1em
\hyphenpenalty=1000
\exhyphenpenalty=100
\righthyphenmin=3

\theoremstyle{plain}\theoremheaderfont{\normalfont\itshape}\theorembodyfont{\rmfamily}\theoremseparator{.}\newtheorem*{rem}{Remark}\newtheorem*{ex}{Example}\newtheorem*{proof}{Proof}\newtheorem*{altp}{Alternative proof}

\theoremstyle{plain}\theoremheaderfont{\normalfont\bfseries}\theorembodyfont{\rmfamily}\theoremseparator{.}\newtheorem{thm}{Theorem}[section]\newtheorem{lem}[thm]{Lemma}\newtheorem{prop}[thm]{Proposition}\newtheorem*{cor}{Corollary}\newtheorem{defn}[thm]{Definition}\newtheorem{clm}[thm]{Claim}\newtheorem{clminproof}{Claim}\newtheorem*{law}{Law}\newtheorem{pos}[thm]{Postulate}

\theoremstyle{break}\theoremheaderfont{\normalfont\itshape}\theorembodyfont{\rmfamily}\theoremseparator{.\medskip}\newtheorem*{proofskip}{Proof}\newtheorem*{exs}{Examples}\newtheorem*{rems}{Remarks}

\theoremstyle{break}\theoremheaderfont{\normalfont\bfseries}\theorembodyfont{\rmfamily}\theoremseparator{.\medskip}\newtheorem{lemskip}[thm]{Lemma}\newtheorem{defnskip}[thm]{Definition}\newtheorem{propskip}[thm]{Proposition}\newtheorem{thmskip}[thm]{Theorem}

\crefname{thm}{Theorem}{Theorems}\crefname{defn}{Definition}{Definitions}\crefname{lem}{Lemma}{Lemmas}\crefname{lemskip}{Lemma}{Lemmas}\crefname{cor}{Corollary}{Corollaries} \crefname{prop}{Proposition}{Propositions}\crefname{clm}{Claim}{Claims}\crefname{pos}{Postulate}{Postulates}

\setcounter{tocdepth}{2}
\numberwithin{equation}{section}
\counterwithin{figure}{section}

\newcommand{\qed}{\hfill\ensuremath{\Box}}
\newcommand{\unit}[1]{\ \mathrm{#1}}
\newcommand{\ii}{\mathrm{i}}
\newcommand{\ee}{\mathrm{e}}
\newcommand{\tp}{^\mathrm{T}}
\newcommand{\dd}[2][]{\mathrm{d}^{#1} #2\,}
\renewcommand{\d}[2][]{\mathrm{d}^{#1} #2}
\newcommand{\dv}[3][]{\frac{\mathrm{d}^{#1} #2}{{\mathrm{d} #3}^{#1}}}
\newcommand{\pdv}[3][]{\frac{\partial^{#1} #2}{{\partial #3}^{#1}}}
\newcommand{\vb}[1]{\bm{\mathrm{#1}}}
\newcommand{\vu}[1]{\hat{\bm{\mathrm{#1}}}}
\newcommand{\vdot}{\,\bm{\mathrm{\cdot}}\,}
\newcommand{\cross}{\bm{\times}}
\newcommand{\abs}[1]{\left| #1 \right|}
\newcommand{\norm}[1]{\left\| #1 \right\|}
\newcommand{\grad}{\vb{\nabla}}
\renewcommand{\div}{\vb{\nabla}\cdot}
\newcommand{\curl}{\vb{\nabla}\times}
\newcommand{\laplacian}{\nabla^2}
\renewcommand{\Re}{\operatorname{Re}}
\renewcommand{\Im}{\operatorname{Im}}
\newcommand{\eval}[1]{\left\langle #1 \right\rangle}
\DeclareMathOperator{\Var}{Var}

\newcommand{\tikzAngleOfLine}{\tikz@AngleOfLine}
    \def\tikz@AngleOfLine(#1)(#2)#3{%
    \pgfmathanglebetweenpoints{%
        \pgfpointanchor{#1}{center}}{%
        \pgfpointanchor{#2}{center}}
    \pgfmathsetmacro{#3}{\pgfmathresult}%
}

\tikzset{
    screw/.pic={
        \draw[very thick] (0,-0.2) arc (-26.565:45:0.4472);
        \draw[very thick] (0,0.2) arc (153.435:225:0.4472);
        \fill[black] (0,-0.2) arc (-26.565:26.565:0.4472)--(0,0.2) arc (153.435:206.565:0.4472);
    },
}


\pgfplotsset{compat=1.18}
\usetikzlibrary{calc, math, arrows.meta}

\begin{document}
    \setlength{\parindent}{0pt}
	\Huge\textsf{\textbf{Diffraction Methods in Chemistry}}
		
	\Large\textsf{\textbf{University of Cambridge Part II Natural Sciences Tripos}}

	\noindent\makebox[\linewidth]{\rule{\textwidth}{2pt}}

	\large\textsf{\textbf{Yue Wu}}
	\begin{itemize}[topsep=0pt,leftmargin=15pt]
		\item[] \textit{Yusuf Hamied Department of Chemistry\\
		Lensfield Road,\\
		Cambridge, CB2 1EW}\\

		\textit{yw628@cam.ac.uk}
	\end{itemize}
    \thispagestyle{empty}
    \pagenumbering{roman}
    \setlength{\parindent}{15pt}

    \newpage
    \begin{center}
		\textbf{\Large{Acknowledgements}}
	\end{center}
	\large
	Nothing in these lecture notes is original. They are largely based on the notes by Dr. Andrew Bond, who lectured this course in 2025. They are nowhere near accurate representations of what was actually lectured, and in particular, all errors are almost surely mine.

    \normalsize
    \newpage
	\tableofcontents
	\newpage
    \pagenumbering{arabic}

    \section{Diffraction}
    It might be familiar from physics that if you shine a beam of light on a diffraction grating, then a diffraction pattern will emerge. If you put a lens after the diffracted beam, they may be brought to a focus, and a magnified image of the diffraction grating will be seen, as shown in the figure.

    \begin{figure}
        \centering
        \begin{tikzpicture}[scale=0.7]
            \draw (0,0.5)--(5,0.5)--(11,-2);
            \draw (0,-0.5)--(5,-0.5)--(11,2);
            \draw[dashed] (2,0.5)--(5,1.5)--(11,-2);
            \draw[dashed] (2,-0.5)--(5,0.5)--(11,2);
            \draw[dashed] (2,-0.5)--(5,-1.5)--(11,2);
            \draw[dashed] (2,0.5)--(5,-0.5)--(11,-2);
            \draw[fill=gray!20] (5.0001,3) arc (170:190:17.276);
            \draw[fill=gray!20] (4.9999,-3) node[below]{lens} arc (-10:10:17.276);
            \foreach \i in {-5,...,5}{
                \draw[fill=black] (2,0.1*\i) circle (0.02);
                \draw[fill=black] (11,0.4*\i) circle (0.08);
            }
            \draw (6.2,-3)node[below,align=center]{focal \\ plane}--(6.2,3);
            \node at (2,-0.5)[below]{grating};
            \node at (11,-2)[below]{image};
        \end{tikzpicture}
        \caption{A magnified image of the diffraction grating is formed using a convex lens to focus the diffraction pattern.}
    \end{figure}

    Atoms in a crystal are, in some sense, very fine gratings. Can we use a similar method to image the atoms in a crystal directly? However, to form a diffraction pattern, we need the wavelength of the light to be in roughly the same length scale as the pattern we are trying to image. The atoms are on the order of Angstroms (\(10^{-10}\unit{m}\)), therefore, we need to use X-rays for diffraction at atomic length scales. However, there is no practical conventional lens for X-rays, because lenses are made of atoms too, so the imaging process does not work. What we have to do is to measure the intensity of the diffracted beams at different directions, and infer the atomic structure mathematically.

    This is, however, a hard thing to do. We will spend the vast majority of our lectures on how to translate the diffracted beam intensities into atomic structure.

    \subsection{Addition of Electromagnetic Waves}
    X-rays are electromagnetic waves, so they are described by Maxwell's equations, from which we can infer that the electromagnetic fields are essentially just oscillating electric and magnetic fields, travelling in some direction along the wavevector \(\vb{k}\) (the magnitude of \(\vb{k}\) also encodes the wavelength via \(\norm{\vb{k}}=2\pi/\lambda\)) with the speed of light \(c\).\footnote{In free space, \(\rho=0\) and \(\vb{J}=0\), so by Maxwell's equations
    \begin{equation}
        \curl(\curl\vb{E})=-\curl\pdv{\vb{B}}{t}=-\pdv{}{t}(\curl B)=-\pdv{}{t}\left(\mu_0\epsilon_0\pdv{\vb{E}}{t}\right)=-\mu_0\epsilon_0\pdv[2]{\vb{E}}{t}\,.
    \end{equation}
    By vector calculus identities, we also have
    \begin{equation}
        \curl(\curl\vb{E})=\grad(\div\vb{E})-\laplacian\vb{E}=-\laplacian\vb{E}\,,
    \end{equation}
    and hence
    \begin{equation}
        \laplacian\vb{E}=\mu_0\epsilon_0\pdv[2]{\vb{E}}{t}\,.
    \end{equation}
    This is the wave equation, with wave speed \(c=1/\sqrt{\mu_0\epsilon_0}\), with general complex solution
    \begin{equation}
        \vb{E}=\vb{E}_0\ee^{\ii(\vb{k}\cdot\vb{r}-\omega t)}
    \end{equation}
    for \(\vb{E}\in\mathbb{C}\) and \(\vb{k}^2 c^2=\omega^2\). By Maxwell's equations, we also have
    \begin{equation}
        \pdv{\vb{B}}{t}=-\curl\vb{E}=-\ii\vb{k}\times\vb{E}\,,
    \end{equation}
    and so
    \begin{equation}
        \vb{B}=\frac{\vb{k}}{\omega}\times\vb{E}\,.
    \end{equation}
    Therefore, \(\vb{E}\) and \(\vb{B}\) are both transverse waves that are in the same phase but perpendicular to each other.} We label the coordinate \(x\) along the propagation direction \(\vb{k}\), and consider the wave at some fixed time \(t\). Then the electric (or equivalently the magnetic) field strength is given by
    \begin{equation}
        \psi(x)=A\sin\left(\frac{2\pi x}{\lambda}+\phi\right)\,,
    \end{equation}
    where the real number \(A\) is the amplitude and \(\phi\) is the phase offset. However, it turns out that when considering oscillations, it is always easier to use complex numbers, so we will alternatively see the electric field as the real part of the complex wave
    \begin{equation}
        \psi(x)=A\exp\left(\frac{2\pi \ii x}{\lambda}\right)\,,
    \end{equation}
    where \(A=\abs{A}\ee^{\ii\phi}\) is now complex and includes both the amplitude \(\abs{A}\) and the initial phase offset \(\phi\).

    \begin{figure}
        \centering
        \begin{tikzpicture}[x={(-0.8cm,-0.4cm)},y={(0cm,1cm)},z={(0.7cm,-0.5cm)}]
            \draw[->] (-2,0)--(2,0)node[left,blue]{\(B\)};
            \draw[->] (0,-2)--(0,2)node[left,red]{\(E\)};
            \draw[->] (0,0,-0.5)--(0,0,5)node[right]{\(x\)};
            \draw[thick,domain=0:6.25, smooth, variable=\x,samples=50,blue] plot ({cos(0.8*\x r)}, {0}, {0.8*\x});
            \draw[thick,domain=0:6.25, smooth, variable=\x,samples=50,red] plot ({0}, {cos(0.8*\x r)}, {0.8*\x});
            \foreach \x in {0,...,12}{
                \draw (0,0,0.4*\x)--({cos(0.4*\x r)},0,0.4*\x);
                \draw (0,0,0.4*\x)--(0,{cos(0.4*\x r)},0.4*\x);
            }
        \end{tikzpicture}
        \caption{Electromagnetic wave propagating in space.}
    \end{figure}

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (0,0)--(6,0);
            \draw[fill=white] (1,0)node[below]{\(x_1\)} circle (0.05);
            \draw[fill=white] (1.6,0)node[below]{\(x_2\)} circle (0.05);
            \draw[fill=white] (2.6,0)node[below]{\(x_3\)} circle (0.05);
            \draw[fill=black] (5,0)node[below]{\(x\)} circle (0.05);
        \end{tikzpicture}
    \end{figure}

    Now what happens if we have multiple sources, each sending off electromagnetic waves of the same frequencies but with different amplitudes and phases? Let's consider the simple 1D case, where \(n\) sources are located at \(x_j\). We will let all \(n\) sources have a zero initial phase\footnote{It is a trivial generalisation for the sources to have different non-zero initial phases. We make such assumption because this is the only situation we will need for later discussion, and it makes my diagram cleaner. It is actually also trivial to generalise it to 3D by replacing \(x-x_j\) with \(\norm{\vb{x}-\vb{x}_j}\) in all the expressions below.}, so that the resulting wave at point \(x\) due to source \(j\) is given by
    \begin{equation}
        \psi_j(x)=A_j\exp\left(\frac{2\pi \ii(x-x_j)}{\lambda}\right)\,,
    \end{equation}
    where \(A_j\) is real because we have a zero initial phase. We will denote the phase of the wave due to source \(j\) at \(x\) as
    \begin{equation}
        \phi_j=\frac{2\pi(x-x_j)}{\lambda}\,.
    \end{equation}
    Then to work out the total wave, we only need to sum up the contributions from each source to get
    \begin{equation}
        \Psi_{\text{res}}(x)=\sum_jA_j\exp\left(\ii\phi_j\right)\,.
    \end{equation}
    It is easy to see that the phase angle of the resultant amplitude is
    \begin{equation}
        \Phi_{\text{res}}=\tan^{-1}\left[\frac{\sum_j A_j\sin \phi_j}{\sum_j A_j \cos\phi_j}\right]\,.
    \end{equation}

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (-0.5,0)--(4,0)node[right]{\(\Re\Psi\)};
            \draw[->] (0,-0.5)--(0,4)node[left]{\(\Im\Psi\)};
            \coordinate (A) at (0,0);
            \coordinate (B) at ($(A)+(35:1.5)$);
            \coordinate (C) at ($(B)+(55:1.7)$);
            \coordinate (D) at ($(C)+(92:1.9)$);
            \draw[->,thick] (A)--node[above]{\small\(A_1\)}(B);
            \draw[->,thick] (B)--node[left]{\small\(A_2\)}(C);
            \draw[->,thick] (C)--node[left]{\small\(A_3\)}(D);
            \draw[->,thick] (A)--node[left]{\(\abs{\Psi_{\text{res}}}\)}(D);
            \draw[dashed] (B)-- +(1,0);
            \draw[dashed] (C)-- +(1,0);

            \tikzAngleOfLine(A)(B){\AngleB}
            \draw (A)+(0.5,0) arc (0:\AngleB:0.5 cm) node[midway,right] {\(\phi_1\)};
            \tikzAngleOfLine(B)(C){\AngleC}
            \draw (B)+(0.5,0) arc (0:\AngleC:0.5 cm) node[midway,right] {\(\phi_2\)};
            \tikzAngleOfLine(C)(D){\AngleD}
            \draw (C)+(0.5,0) arc (0:\AngleD:0.5 cm) node[midway,right] {\(\phi_3\)};
        \end{tikzpicture}
    \end{figure}

    Now what if we move the measuring point \(x\) by an amount of \(\delta x\)? This will increase the phases of the wave from all the sources by
    \begin{equation}
        \delta\phi=\frac{2\pi\delta x}{\lambda}\,.
    \end{equation}
    The net result is that the resultant magnitude of the combined wave does not change, but the phase changes by \(\delta\phi\), as
    \begin{equation}
        \Psi'_{\text{res}}(x)=\sum_jA_j\exp(\ii(\phi_j+\delta\phi))=\ee^{\ii\delta\phi}\sum_jA_j\exp(\ii\phi_j)\,.
    \end{equation}
    
    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (-0.5,0)--(4,0)node[right]{\(\Re\Psi\)};
            \draw[->] (0,-0.5)--(0,4)node[right]{\(\Im\Psi\)};
            \coordinate (A) at (0,0);
            \coordinate (B) at ($(A)+(95:1.5)$);
            \coordinate (C) at ($(B)+(115:1.7)$);
            \coordinate (D) at ($(C)+(152:1.9)$);
            \coordinate (P) at ($(A)+(60:1)$);
            \coordinate (Q) at ($(B)+(60:1)$);
            \coordinate (R) at ($(C)+(60:1)$);
            \draw[->,thick] (A)--node[left]{\small\(A_1\)}(B);
            \draw[->,thick] (B)--node[left]{\small\(A_2\)}(C);
            \draw[->,thick] (C)--node[below]{\small\(A_3\)}(D);
            \draw[->,thick] (A)--node[left]{\(\abs{\Psi_{\text{res}}}\)}(D);
            \draw[dashed] (A)--(P);
            \draw[dashed] (Q)--(B)-- +(1,0);
            \draw[dashed] (R)--(C)-- +(1,0);
            \tikzAngleOfLine(A)(P){\AngleDelta}
            \tikzAngleOfLine(A)(B){\AngleB}
            \draw (A)+(60:0.5) arc (\AngleDelta:\AngleB:0.5 cm) node[midway,above] {\(\phi_1\)};
            \tikzAngleOfLine(B)(C){\AngleC}
            \draw (B)+(60:0.5) arc (\AngleDelta:\AngleC:0.5 cm) node[midway,above] {\(\phi_2\)};
            \tikzAngleOfLine(C)(D){\AngleD}
            \draw (C)+(60:0.5) arc (\AngleDelta:\AngleD:0.5 cm) node[midway,above] {\(\phi_3\)};
            \draw (A)+(0:0.5) arc (0:\AngleDelta:0.5 cm) node[midway,right] {\(\delta\phi\)};
            \draw (B)+(0:0.5) arc (0:\AngleDelta:0.5 cm) node[midway,right] {\(\delta\phi\)};
            \draw (C)+(0:0.5) arc (0:\AngleDelta:0.5 cm) node[midway,right] {\(\delta\phi\)};
        \end{tikzpicture}
        \caption{Movement of the measuring point results in a change of measured phase only.}
    \end{figure}

    What if we change the position of one of the sources \(x_k\)? This will in general lead to a change in the phase \(\phi_k\). Now both the phase and the amplitude of the resulting wave is different.

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (-0.5,0)--(4,0)node[right]{\(\Re\Psi\)};
            \draw[->] (0,-0.5)--(0,4)node[left]{\(\Im\Psi\)};
            \coordinate (A) at (0,0);
            \coordinate (B) at ($(A)+(35:1.5)$);
            \coordinate (C) at ($(B)+(55:1.7)$);
            \coordinate (D) at ($(C)+(150:1.9)$);
            \draw[->,thick] (A)--node[above]{\small\(A_1\)}(B);
            \draw[->,thick] (B)--node[left]{\small\(A_2\)}(C);
            \draw[->,thick] (C)--node[left]{\small\(A_3\)}(D);
            \draw[->,thick] (A)--node[left]{\(\abs{\Psi_{\text{res}}}\)}(D);
            \draw[dashed] (B)-- +(1,0);
            \draw[dashed] (C)-- +(1,0);

            \tikzAngleOfLine(A)(B){\AngleB}
            \draw (A)+(0.5,0) arc (0:\AngleB:0.5 cm) node[midway,right] {\(\phi_1\)};
            \tikzAngleOfLine(B)(C){\AngleC}
            \draw (B)+(0.5,0) arc (0:\AngleC:0.5 cm) node[midway,right] {\(\phi_2\)};
            \tikzAngleOfLine(C)(D){\AngleD}
            \draw (C)+(0.5,0) arc (0:\AngleD:0.5 cm) node[midway,above] {\(\phi_3\)};
        \end{tikzpicture}
        \caption{A change in the position of one of the sources leads to a change in both the magnitude and the phase measured.}
    \end{figure}

    \subsection{Diffraction of an Object}
    We would now like to consider the diffraction of an extended object. Suppose we have parallel incident beams from the direction \(\vu{s}_0\) illuminating the whole object, and we are measuring the diffracted beam at some distant point \(Q\). The dimension of this object is small compared to its distance to the measuring point \(Q\) so we can sensibly say that \(Q\) is at direction \(\vu{s}\) for all points in the object.\footnote{This type of diffraction is known as \textit{Fraunhofer diffraction}. If you are observing near the diffracting object, then the diffraction is \textit{Fresnel diffraction}.} Moreover, we assume that the effect of diffraction is weak, so the diffraction only happens once --- an already diffracted beam cannot be diffracted again. This is known as the \textit{kinematic approximation}.\footnote{If this assumption is false (as it will be for electron diffractions), we need to consider a more complicated \textit{dynamic scattering}.}
    
    To produce the diffraction pattern, we need to sum up the radiation scattered from all the points in the object. To do this, we first pick an arbitrary origin \(O\) in the object, and we need to figure out the intensity and phase difference between the beams diffracted in direction \(\vu{s}\) from \(O\) and from any other point \(P\) with position vector \(\vb{r}\).

    \begin{figure}
        \centering
        \begin{tikzpicture}
            \draw[fill=gray!30] plot[smooth cycle, tension=1] coordinates{(-1.3,0) (0.4,1.8) (2.5,0.25) (0.7,-1.7)};
            \draw (-3,-0.8)--(0,-0.8)--+(-50:2.5);
            \draw (-3,0.8)--(1,0.8)--+(-50:3.2);
            \draw[->,thick] (0,-0.8)node[below left=-2pt]{\small\(O\)}--node[left=-1pt]{\small\(\vb{r}\)}(1,0.8)node[above right=-2pt]{\small\(P\)};
            \draw (0,-0.8)--(0,0.8);
            \draw (0,-0.8)--+(40:1.795);
            \draw[->,thick] (0,-0.8)--(0.6,-0.8)node[right]{\small\(\vu{s}_0\)};
            \draw[->,thick] (0,-0.8)--+(-50:0.6)node[right]{\small\(\vu{s}\)};
            \draw[thick,red] (0,0.8)--node[above,red]{\small\(\vb{r}\vdot\vu{s}_0\)}(1,0.8);
            \draw[thick,blue] (1,0.8)--node[right,blue]{\small\(-\vb{r}\vdot\vu{s}\)}+(-50:0.583);
        \end{tikzpicture}
        \caption{Path difference for diffractions in a general object.}
        \label{object_diffraction}
    \end{figure}

    From \cref{object_diffraction}, it is easy to see that the beam diffracted from \(P\) and \(O\) has a path difference
    \begin{equation}
        \Delta x=\vb{r}\vdot\vu{s}_0-\vb{r}\vdot\vu{s}\,.
    \end{equation}
    In particular, a positive path difference means that the beam from \(P\) falls behind the beam from \(O\), leading to a negative phase difference, so
    \begin{equation}
        \Delta\phi=-\frac{2\pi\Delta x}{\lambda}=\frac{2\pi\vb{r}\vdot(\vu{s}-\vu{s}_0)}{\lambda}\,.
    \end{equation}
    The amplitude of the beam diffracted from \(O\) and \(P\) may also be different, since the object may be inhomogeneous. Let \(A(\vb{r})\) be a real function representing the diffraction amplitude, then by integrating over all points, the wave measured at point \(Q\) is
    \begin{equation}
        \Psi(\vu{s})=\int\dd[3]{\vb{r}}A(\vb{r})\exp\left(\frac{2\pi \ii\vb{r}\vdot(\vu{s}-\vu{s}_0)}{\lambda}\right)\,.
    \end{equation}
    The integral is over the object volume.

    We can define the \textit{scattering vector} \(\vb{S}\) by
    \begin{equation}
        \vb{S}\coloneqq\frac{\vu{s}-\vu{s}_0}{\lambda}\,.
    \end{equation}
    It is a vector bisecting the external angle between the incident and diffracted beam, as shown in the figure below. If we define the angle of deflection to be \(2\theta\), then the length of the scattering vector is
    \begin{equation}
        \norm{\vb{S}}=\frac{2\sin\theta}{\lambda}\,.
    \end{equation}
    The scattering vector has dimension \([\mathrm{L}]^{-1}\), so it exists in the reciprocal space, which might be familiar from Part IB Chemistry A.\footnote{In some derivation, one uses \textit{momentum transfer vector} \(\vb{Q}\) defined by
    \begin{equation}
        \vb{Q}=\frac{2\pi(\vu{s}-\vu{s}_0)}{\lambda}\,.
    \end{equation}
    instead of \(\vb{S}\).}
    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw (-2.5,0)--(2.5,0);
            \draw[very thick,->] (-2.5,0)--node[above]{\(\vu{s}_0\)}(0,0);
            \draw[very thick,->] (0,0)--node[above]{\(\vu{s}\)}(2,-1.5);
            \draw (-2.5,0)--(-0.5,-1.5)--(2,-1.5);
            \draw[very thick,->] (0,0)--node[left]{\(\lambda\vb{S}\)}(-0.4,-1.5);
            \draw (0.5,0) arc (0:-36.87:0.5);
            \node at (0.7,-0.2){\small \(2\theta\)};
        \end{tikzpicture}
        \caption{Construction of the scattering vector.}
    \end{figure}
    
    This allows us to simplify our expression of the measured wave as
    \begin{equation}
        \Psi(\vb{S})=\int\dd[3]{\vb{r}}A(\vb{r})\exp\left(2\pi \ii\vb{r}\vdot\vb{S}\right)\,.
    \end{equation}

    \subsection{Diffraction of X-rays from Electrons}
    We will now consider how X-rays interacts with matter. The interaction generally fall into two categories.
    \begin{itemize}[topsep=0pt]
        \item \textit{Elastic scattering.} This is our main focus. In an \textit{elastic scattering}, or \textit{Thomson scattering}, there is no net transfer of energy from the photon to the material. It can be thought of as some kind of resonance of the atomic electrons. When X-rays pass through the material, the oscillating electric field causes the atomic electrons to oscillate, which in turn emit X-rays in all directions. The incoming and outgoing rays retain a non-random phase relationship and are said to be \textit{coherent}.
        \item \textit{Inelastic processes.} \textit{Inelastic processes} involve energy transfer from the incoming X-rays to electrons in atoms. The simplest example is photoelectron emission, where an X-ray photon providing energy for an atom to eject a core-shell electron. The photons are then re-emitted with lower energy in an incoherent fashion. This incoherence means that they cannot interfere with each other to produce diffraction patterns. Other processes of this type may result from interaction with valence shell electrons or vibrations, all being incoherent. We are therefore not interested in inelastic processes at this stage --- we will return to this later.
    \end{itemize}

    The quantitative description of Thomson scattering strictly only applies to free electrons, but the results are found to be generally applicable to crystals under normal scattering conditions. Crucially, the amplitude of X-rays diffracted from some point is proportional to the local electron density \(\rho(\vb{r})\). Therefore,
    \begin{equation}
        \Psi(\vb{S})=\int\dd[3]{\vb{r}}\sigma\rho(\vb{r})\exp(2\pi \ii\vb{r}\vdot\vb{S})\,,
    \end{equation}
    where \(\sigma\) is the scattering power of a single electron. We can divide through this constant of proportionality to obtain the \textit{structure factor} \(F(\vb{S})\) given by
    \begin{equation}
        F(\vb{S})=\int\dd[3]{\vb{r}}\rho(\vb{r})\exp\left(2\pi \ii\vb{r}\vdot\vb{S}\right)\,.
    \end{equation}
    The limits of the two integrals above are both throughout the whole 3D space. Mathematically, \(F(\vb{S})\) is the \textit{Fourier transform} of the electron density \(\rho(\vb{r})\).
    \begin{defn}
        Let \(f:\mathbb{R}^n\to\mathbb{C}\) be a function. The \textit{Fourier transform} of \(f\) is \(\mathcal{F}[f]\equiv\tilde{f}:\mathbb{R}^n\to\mathbb{C}\) given by\footnote{You might be more familiar with the Fourier transform defined as
        \begin{equation}
            \tilde{f}=\frac{1}{\sqrt{2\pi}}\int\dd{x}f(x)\ee^{-ikx}\,,
        \end{equation}
        where the normalisation factor of \(1/\sqrt{2\pi}\) may or may not be there. It is just a matter of convention. However, this difference in convention is annoying since it results in slight tweaks in a lot of formulae.}
        \begin{equation}
            \tilde{f}(\vb{k})\coloneqq\int\dd[n]{\vb{x}}f(\vb{x})\ee^{2\pi \ii\vb{k}\vdot\vb{x}}\,.
        \end{equation}
    \end{defn}
    \begin{thm}
        Let \(\tilde{f}(\vb{k})\) be the Fourier transform of \(f(\vb{x})\). The \textit{inverse Fourier transform} that converts \(\tilde{f}\) back to \(f\) is given by
        \begin{equation}
            f(\vb{x})=\mathcal{F}^{-1}[\tilde{f}(\vb{k})]\coloneqq\int\dd[3]{\vb{k}}\tilde{f}(\vb{k})\ee^{-2\pi \ii\vb{k}\vdot\vb{x}}\,.
        \end{equation}
    \end{thm}
    \begin{proof}
        \begin{align}
            \mathcal{F}^{-1}[\tilde{f}](\vb{x})&=\int\dd[n]{\vb{k}}\ee^{-2\pi \ii\vb{k}\vdot\vb{x}}\int\dd[3]{\vb{s}}\ee^{2\pi \ii\vb{k}\vdot\vb{s}}f(\vb{s})\notag \\
            &=\int\dd[n]{\vb{s}}f(\vb{s})\int\dd[n]{\vb{k}}\ee^{2\pi \ii k\vdot(\vb{s}-\vb{x})}\notag\\
            &=\int\dd[n]{\vb{s}}f(\vb{s})\delta(\vb{s}-\vb{x})\notag\\
            &=f(\vb{x})\,.
        \end{align}\qed
    \end{proof}
    Hence to convert the \(F(\vb{S})\) back to \(\rho(\vb{r})\), one simply needs to perform the inverse Fourier transform
    \begin{equation}
        \rho(\vb{r})=\int\dd[3]{\vb{S}}F(\vb{S})\exp(-2\pi \ii\vb{r}\vdot\vb{S})\,.
    \end{equation}
    Again, the integral is throughout the whole 3D space, and it is omitted.

    This means that if we can determine the \(F(\vb{S})\), then we can easily reconstruct the electron density in a material, no matter how complex the structure is. (1) Measure the phases and the amplitudes of the diffracted beams. (2) Divide by single-electron scattering power \(\sigma\) to get \(F(\vb{S})\). (3) Do the inverse Fourier transform to obtain \(\rho(\vb{r})\). Simple as that! Three steps to solve any chemical structure in the world!

    This should be the happy ending of our story on X-ray diffraction.

    \newpage
    \section{The Phase Problem and the Patterson Function}
    \subsection{The Phase Problem}
    If the problem is really that simple, then this would be a one-lecture course instead of a 12-lecture one. There is a huge issue. We cannot measure the phase of an X-ray.

    To measure the magnitude and the phase of an electromagnetic wave, we would use an antenna. However, this requires the antenna to have its dimensions comparable to the radiation wavelength. The X-rays we used for diffraction are at atomic length scale --- that's why we can see the diffraction, but it is impossible to make an antenna at atomic length scale since antennas should be made from atoms! All we can measure in a diffraction experiment is the number of X-ray photons encountered in a given time, which is the diffracted \textit{intensity}. This is proportional to \(I=\abs{F(\vb{S})}^2\). The phase information is completely lost. This is referred to as the \textit{phase problem} in diffraction.

    Now the question is: is getting the correct phase important? If using a wrong phase of the diffracted beam has little impact on the electron density calculated, then this would not be a huge problem. We can calculate the modulus of \(F(\vb{S})\) by taking the square root of the intensity, and just plug in some random phases to calculate \(\rho(\vb{r})\). However, it turns out that getting the correct phase is extremely important --- it even plays a more important role than the magnitude to some extent. This can be illustrated by the following little experiment.

    Instead of doing Fourier transform of a electron density function, we do a Fourier transform on a picture. A black and white picture is also a function of the pixels, where the values of the function is the gray scale. We can transform it into the frequency domain, and then transform it back, and we get the original image. However, if we use some randomly generated phase values to replace the correct phase values in the Fourier transform of the image, and we transform it back, we see a complete mess. This is what will happen if we use random phase values for the structure factor --- we will get no valuable information. In fact, if we use some random value for the magnitudes of the Fourier transform, with the correct phase values, we can still vaguely see the shape of a cat.
    \begin{figure}[ht!]
        \begin{subfigure}[h]{0.3\linewidth}
            \includegraphics[width=\linewidth]{cat_norm.png}
            \caption{Correct magnitudes + correct phases}
        \end{subfigure}
        \hfill
        \begin{subfigure}[h]{0.3\linewidth}
            \includegraphics[width=\linewidth]{cat_rand_mod.png}
            \caption{Random magnitudes + correct phases}
        \end{subfigure}
        \hfill
        \begin{subfigure}[h]{0.3\linewidth}
            \includegraphics[width=\linewidth]{cat_rand_ph.png}
            \caption{Correct magnitudes + random phases}
        \end{subfigure}%
        \caption{The effect of using the wrong phases and magnitudes in an inverse Fourier transform.}
    \end{figure}

    Just for fun, we can extend this experiment further. We have two images: one is a benzene molecule and the other is a cat. What will happen if we use the magnitude value of one figure with the phase value of the other? The result is shown in (\ref{Fig:cat_and_benzene}), and you can see it is the phase that determines what we will see. In general, we don't want to see a cat if we are investigating the structure of benzene using diffraction, so it's not a good idea just to use a random set of phases when doing inverse Fourier transform.
    \begin{figure}[ht!]
        \begin{subfigure}[h]{0.45\linewidth}
            \centering
            \includegraphics[width=0.8\linewidth]{cat_with_ben.png}
            \caption{Magnitudes of cat + phases of benzene}
        \end{subfigure}
        \hfill
        \begin{subfigure}[h]{0.45\linewidth}
            \centering
            \includegraphics[width=0.8\linewidth]{ben_with_cat.png}
            \caption{Magnitudes of benzene + phases of cat}
        \end{subfigure}
        \caption{Phases govern what we see in an inverse Fourier transform. If you use the phases of a benzene, you see a benzene. If you use the phases of a cat, you see a cat.}
        \label{Fig:cat_and_benzene}
    \end{figure}

    Moral: phases are important, but we can't measure them. The main task of structure determination using X-ray diffraction is to deduce the phases of the structure factor. This is what we will spend the remaining 11 lectures on.

    \subsection{Patterson Function}
    Since all what we can get from measuring a diffraction pattern is the intensity \(I(\vb{S})=\abs{F(\vb{S})}^2\), let's see what its inverse Fourier transform gives us anyway.

    Before doing that, let's first introduce convolution and correlation.

    \begin{defn}
        For two functions \(f,g:\mathbb{R}^n\to\mathbb{C}\), their \textit{convolution} is
        \begin{equation}
            (f*g)(\vb{x})\coloneqq\int\dd[n]{\vb{s}}f(\vb{s})g(\vb{x}-\vb{s})\,,
        \end{equation}
        and their \textit{correlation} is
        \begin{equation}
            (f\otimes g)(\vb{x})\coloneqq\int\dd[n]{\vb{s}}f(\vb{s})^*g(\vb{x}+\vb{s})\,.
        \end{equation}
    \end{defn}
    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \begin{scope}[shift={(-4,2)}]
                \draw[blue,thick] (-2,0)--(-0.5,0)--(-0.5,1)--(0.5,1)--(0.5,0)--(2,0);
                \node at (1,1){\(f\)};
            \end{scope}
            \begin{scope}[shift={(4,2)}]
                \draw[red,thick] (-2,0)--(-0.5,0)--(-0.5,1)--(0.5,0)--(2,0);
                \node at (1,1){\(g\)};
            \end{scope}
            \begin{scope}[shift={(-4,0)}]
                \draw[thick] (-2,0)--(-1,0);
                \draw[thick] (1,0)--(2,0);
                \draw[thick,domain=-1:0, smooth, variable=\x,samples=50] plot ({\x}, {1-\x*\x});
                \draw[thick,domain=0:1, smooth, variable=\x,samples=50] plot ({\x}, {(1-\x)*(1-\x)});
                \node at (1,1){\(f*g\)};
                \draw[<->,cyan] (-0.5,0)--(-0.5,0.75);
                \draw[<->,green] (0,0)--(0,1);
                \draw[<->,orange] (0.5,0)--(0.5,0.25);
            \end{scope}
            \begin{scope}[shift={(-6,-1.5)},scale=0.5]
                \draw[red,thick,xshift=-1cm] (-1.5,0)--(-0.5,0)--(0.5,1)--(0.5,0)--(1.5,0);
                \draw[blue,thick] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,1)--(0.5,0)--(1.5,0);
            \end{scope}
            \begin{scope}[shift={(-5,-2.25)},scale=0.5]
                \draw[red,thick,xshift=-0.5cm] (-1.5,0)--(-0.5,0)--(0.5,1)--(0.5,0)--(1.5,0);
                \draw[blue,thick] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,1)--(0.5,0)--(1.5,0);
                \fill[cyan,fill opacity=0.2] (-0.5,0.5)--(0,1)--(0,0)--(-0.5,0);
            \end{scope}
            \begin{scope}[shift={(-4,-3)},scale=0.5]
                \draw[red,thick,fill=green, fill opacity=0.2] (-1.5,0)--(-0.5,0)--(0.5,1)--(0.5,0)--(1.5,0);
                \draw[blue,thick] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,1)--(0.5,0)--(1.5,0);
            \end{scope}
            \begin{scope}[shift={(-3,-2.25)},scale=0.5]
                \draw[red,thick,xshift=0.5cm] (-1.5,0)--(-0.5,0)--(0.5,1)--(0.5,0)--(1.5,0);
                \draw[blue,thick] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,1)--(0.5,0)--(1.5,0);
                \fill[orange, fill opacity=0.2] (0.5,0.5)--(0.5,0)--(0,0);
            \end{scope}
            \begin{scope}[shift={(-2,-1.5)},scale=0.5]
                \draw[red,thick,xshift=1cm] (-1.5,0)--(-0.5,0)--(0.5,1)--(0.5,0)--(1.5,0);
                \draw[blue,thick] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,1)--(0.5,0)--(1.5,0);
            \end{scope}

            \begin{scope}[shift={(4,0)}]
                \draw[thick] (-2,0)--(-1,0);
                \draw[thick] (1,0)--(2,0);
                \draw[thick,domain=0:1, smooth, variable=\x,samples=50] plot ({\x}, {1-\x*\x});
                \draw[thick,domain=-1:0, smooth, variable=\x,samples=50] plot ({\x}, {(1+\x)*(1+\x)});
                \node at (1,1){\(f\otimes g\)};
                \draw[<->,cyan] (-0.5,0)--(-0.5,0.25);
                \draw[<->,green] (0,0)--(0,1);
                \draw[<->,orange] (0.5,0)--(0.5,0.75);
            \end{scope}
            \begin{scope}[shift={(2,-1.5)},scale=0.5]
                \draw[red,thick,xshift=-1cm] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,0)--(1.5,0);
                \draw[blue,thick] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,1)--(0.5,0)--(1.5,0);
            \end{scope}
            \begin{scope}[shift={(3,-2.25)},scale=0.5]
                \draw[red,thick,xshift=-0.5cm] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,0)--(1.5,0);
                \draw[blue,thick] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,1)--(0.5,0)--(1.5,0);
                \fill[cyan,fill opacity=0.2] (-0.5,0.5)--(0,0)--(-0.5,0);
            \end{scope}
            \begin{scope}[shift={(4,-3)},scale=0.5]
                \draw[red,thick,fill=green, fill opacity=0.2] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,0)--(1.5,0);
                \draw[blue,thick] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,1)--(0.5,0)--(1.5,0);
            \end{scope}
            \begin{scope}[shift={(5,-2.25)},scale=0.5]
                \draw[red,thick,xshift=0.5cm] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,0)--(1.5,0);
                \draw[blue,thick] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,1)--(0.5,0)--(1.5,0);
                \fill[orange, fill opacity=0.2] (0,1)--(0.5,0.5)--(0.5,0)--(0,0);
            \end{scope}
            \begin{scope}[shift={(6,-1.5)},scale=0.5]
                \draw[red,thick,xshift=1cm] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,0)--(1.5,0);
                \draw[blue,thick] (-1.5,0)--(-0.5,0)--(-0.5,1)--(0.5,1)--(0.5,0)--(1.5,0);
            \end{scope}
        \end{tikzpicture}
        \caption{Graphic explanation of convolution and correlation.}
    \end{figure}

    \begin{thm}[Convolution theorem]
        The Fourier transform of a convolution is the product of Fourier transforms.
        \begin{equation}
            \mathcal{F}[f*g]=\mathcal{F}[f]\mathcal{F}[g]\,.
        \end{equation}
    \end{thm}
    \begin{proof}
        \begin{align}
            \mathcal{F}[f*g](\vb{k})&=\int\dd[n]{\vb{x}}\ee^{2\pi \ii\vb{k}\vdot\vb{x}}\int\dd[n]{\vb{s}}f(\vb{s})g(\vb{x}-\vb{s})\notag\\
            &=\int\dd[n]{\vb{s}}f(\vb{s})\int\dd[n]{\vb{x}}\ee^{2\pi \ii\vb{k}\vdot\vb{x}}g(\vb{x}-\vb{s})\notag\\
            &=\int\dd[n]{\vb{s}}f(\vb{s})\int\dd[n]{\vb{u}}\ee^{2\pi \ii\vb{k}\vdot(\vb{u}+\vb{s})}g(\vb{u}) \qquad\text{define }\vb{u}=\vb{x}-\vb{s}\notag \\
            &=\int\dd[n]{\vb{s}}\ee^{2\pi \ii\vb{k}\vdot\vb{s}}f(\vb{s})\int\dd[n]{\vb{u}}\ee^{2\pi \ii\vb{k}\vdot\vb{u}}g(\vb{u})\notag \\
            &=\tilde{f}(\vb{k})\tilde{g}(\vb{k})\,.
        \end{align}\qed
    \end{proof}
    \begin{thm}
        Conversely, the Fourier transform of a product \(fg\) is the convolution of their Fourier transforms
        \begin{equation}
            \mathcal{F}[fg]=\mathcal{F}[f]*\mathcal{F}[g]\,.
        \end{equation}
    \end{thm}
    \begin{proof}
        \begin{align}
            \mathcal{F}[fg](\vb{k})&=\int\dd[n]{\vb{x}}\ee^{2\pi \ii\vb{k}\vdot\vb{x}}f(\vb{x})g(\vb{x})\notag \\
            &=\int\dd[n]{\vb{x}}\ee^{2\pi \ii\vb{k}\vdot\vb{x}}f(\vb{x})\int\dd[n]{\vb{\ell}}\ee^{-2\pi \ii\vb{\ell}\vdot\vb{x}}\tilde{g}(\vb{\ell})\notag \\
            &=\int\dd[n]{\vb{\ell}}\tilde{g}(\vb{\ell})\int\dd[n]{\vb{x}}\ee^{2\pi \ii\vb{x}\vdot(\vb{k}-\vb{\ell})}f(\vb{x})\notag \\
            &=\int\dd[n]{\vb{\ell}}\tilde{g}(\vb{\ell})\tilde{f}(\vb{k}-\vb{\ell})\notag \\
            &=\tilde{f}*\tilde{g}(\vb{k})\,.
        \end{align}\qed
    \end{proof}
    We see a beautiful duality here. Product in the real domain is the convolution in the Fourier domain, and \textit{vice versa}.
    \begin{thm}[Wiener--Khinchin theorem]
        The Fourier transform of the autocorrelation of a function is its \textit{power spectral intensity}.
        \begin{equation}
            \mathcal{F}[f\otimes f]=\abs{\tilde{f}}^2\,.
        \end{equation}
    \end{thm}
    \begin{proof}
        \begin{align}
            \mathcal{F}[f\otimes f](\vb{k})&=\int\dd[n]{\vb{x}}\ee^{2\pi \ii\vb{k}\vdot\vb{x}}\int\dd[n]{\vb{s}}f^*(\vb{s})f(\vb{x}+\vb{s})\notag\\
            &=\int\dd[n]{\vb{s}}f^*(\vb{s})\int\dd[n]{\vb{x}}\ee^{2\pi \ii\vb{k}\vdot\vb{x}}f(\vb{x}+\vb{s})\notag\\
            &=\int\dd[n]{\vb{s}}f^*(\vb{s})\int\dd[n]{\vb{u}}\ee^{2\pi \ii\vb{k}\vdot(\vb{u}-\vb{s})}f(\vb{u}) \qquad\text{define }\vb{u}=\vb{x}+\vb{s}\notag \\
            &=\int\dd[n]{\vb{s}}\ee^{-2\pi \ii\vb{k}\vdot\vb{s}}f^*(\vb{s})\int\dd[n]{\vb{u}}\ee^{2\pi \ii\vb{k}\vdot\vb{u}}f(\vb{u})\notag \\
            &=\tilde{f}^*(\vb{k})\tilde{f}(\vb{k})=\abs{\tilde{f}(\vb{k})}^2\,.
        \end{align}\qed
    \end{proof}
    Finally, if we apply both sides on the Wiener--Khinchin theorem, we get
    \begin{equation}
        \mathcal{F}^{-1}\left[|\tilde{f}|^2\right]=f\otimes f\,.
    \end{equation}
    We can apply this to our diffraction intensity! We previously identified the structure factor to be the Fourier transform of the electron density, \(F(\vb{S})=\mathcal{F}[\rho(\vb{x})]\), and the diffraction intensity is exactly \(I(\vb{S})=\abs{F(\vb{S})}^2\). Therefore, the inverse Fourier transform of the diffraction intensity is exactly the autocorrelation of the electron density!
    \begin{equation}
        \mathcal{F}^{-1}[I(\vb{S})]=\rho\otimes\rho(\vb{r})\,.
    \end{equation}
    We often call this the \textit{Patterson function}, denoted \(P(\vb{r})\).

    \subsection{Illustrating the Patterson Function}
    The above derivation is a bit abstract. Let's do a simple 1D example of an electron density function with three peaks, modelling three atoms in a line, and see how its Patterson function look like.

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (-4,0)--(4,0)node[above]{\(x\)};
            \draw[thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-1}, {2*2.72^(-50*\x*\x)});
            \draw[thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-50*\x*\x)});
            \draw[thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+1.5}, {2.72^(-50*\x*\x)});
            \node at (-1,2)[above]{\(1\)};
            \node at (0,3)[above]{\(2\)};
            \node at (1.5,1)[above]{\(3\)};
            \draw (-1,0.05)--(-1,0)node[below]{\small\(-1\)};
            \draw (0,0.05)--(0,0)node[below]{\small\(0\)};
            \draw (1.5,0.05)--(1.5,0)node[below]{\small\(1.5\)};
        \end{tikzpicture}
    \end{figure}

    We put the three peaks at positions \(x=-1\), \(x=0\) and \(x=1.5\) with weights \(2\), \(3\) and \(1\) respectively. From the definition of the Patterson function, which is the correlation of the electron density with itself
    \begin{equation}
        P(u)=\int\dd{x}\rho(x)\rho(x+u)\,,
    \end{equation}
    we need to take another copy of electron density function, shift it by some distance \(u\), and evaluate the integral of their product, which is roughly governed by how well do the peaks of the two functions overlap. Let's set \(u\) to a range of different values and see what happens.
    \begin{itemize}
        \item \(u=-3\): First, when \(u\) is very negative, the two function has almost no overlap, so at this value of \(u\), \(P(u)\approx 0\).
        \begin{figure}[ht!]
            \centering
            \begin{tikzpicture}
                \draw[->] (-4,0)--(4,0)node[above]{\(x\)};
                \draw[thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-1}, {2*2.72^(-50*\x*\x)});
                \draw[thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-50*\x*\x)});
                \draw[thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+1.5}, {2.72^(-50*\x*\x)});
                \begin{scope}[shift={(-3,0)}]
                    \draw[red,thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-1}, {2*2.72^(-50*\x*\x)});
                    \draw[red,thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-50*\x*\x)});
                    \draw[red,thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+1.5}, {2.72^(-50*\x*\x)});
                \end{scope}
                \draw (-1,0.05)--(-1,0)node[below]{\small\(-1\)};
                \draw (0,0.05)--(0,0)node[below]{\small\(0\)};
                \draw (1.5,0.05)--(1.5,0)node[below]{\small\(1.5\)};
            \end{tikzpicture}
        \end{figure}
        \item \(u=-2.5\): At this value of \(u\), peak 1 and peak 3 just overlaps. Without the actual functional form of the peak, we can't evaluate this integral of their product, but since peak \(1\) has weight \(2\) and peak \(3\) has weight \(1\), we can roughly assign a relative weight of \(2\times 1=2\) to the Patterson function here.
        \begin{figure}[ht!]
            \centering
            \begin{tikzpicture}
                \draw[->] (-4,0)--(4,0)node[above]{\(x\)};
                \draw[thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-1}, {2*2.72^(-50*\x*\x)});
                \draw[thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-50*\x*\x)});
                \draw[thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+1.5}, {2.72^(-50*\x*\x)});
                \begin{scope}[shift={(-2.5,0)}]
                    \draw[red,thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-1}, {2*2.72^(-50*\x*\x)});
                    \draw[red,thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-50*\x*\x)});
                    \draw[red,thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+1.5}, {2.72^(-50*\x*\x)});
                \end{scope}
                \draw (-1,0.05)--(-1,0)node[below]{\small\(-1\)};
                \draw (0,0.05)--(0,0)node[below]{\small\(0\)};
                \draw (1.5,0.05)--(1.5,0)node[below]{\small\(1.5\)};
            \end{tikzpicture}
        \end{figure}
        \item \(u=-1.5\): Now at this value of \(u\), peak 3 and peak 2 overlaps, giving a peak in the Patterson function with relative weight \(3\times 1=3\).\\
        \begin{figure}[ht!]
            \centering
            \begin{tikzpicture}
                \draw[->] (-4,0)--(4,0)node[above]{\(x\)};
                \draw[thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-1}, {2*2.72^(-50*\x*\x)});
                \draw[thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-50*\x*\x)});
                \draw[thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+1.5}, {2.72^(-50*\x*\x)});
                \begin{scope}[shift={(-1.5,0)}]
                    \draw[red,thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-1}, {2*2.72^(-50*\x*\x)});
                    \draw[red,thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-50*\x*\x)});
                    \draw[red,thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+1.5}, {2.72^(-50*\x*\x)});
                \end{scope}
                \draw (-1,0.05)--(-1,0)node[below]{\small\(-1\)};
                \draw (0,0.05)--(0,0)node[below]{\small\(0\)};
                \draw (1.5,0.05)--(1.5,0)node[below]{\small\(1.5\)};
            \end{tikzpicture}
        \end{figure}
        \item \(u=-1\): Peak 1 and peak 2 overlap, giving a peak in the Patterson function with relative weight \(2\times 3=6\).
        \begin{figure}[ht!]
            \centering
            \begin{tikzpicture}
                \draw[->] (-4,0)--(4,0)node[above]{\(x\)};
                \draw[thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-1}, {2*2.72^(-50*\x*\x)});
                \draw[thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-50*\x*\x)});
                \draw[thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+1.5}, {2.72^(-50*\x*\x)});
                \begin{scope}[shift={(-1,0)}]
                    \draw[red,thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-1}, {2*2.72^(-50*\x*\x)});
                    \draw[red,thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-50*\x*\x)});
                    \draw[red,thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+1.5}, {2.72^(-50*\x*\x)});
                \end{scope}
                \draw (-1,0.05)--(-1,0)node[below]{\small\(-1\)};
                \draw (0,0.05)--(0,0)node[below]{\small\(0\)};
                \draw (1.5,0.05)--(1.5,0)node[below]{\small\(1.5\)};
            \end{tikzpicture}
        \end{figure}
        \item \(u=0\): At this special value of \(u\), the second function is not moved at all, so all the three peaks are perfectly aligned. This leads to a very large peak in the Patterson function with weight \(2^2+3^2+1^2=14\).
        \begin{figure}[ht!]
            \centering
            \begin{tikzpicture}
                \draw[->] (-4,0)--(4,0)node[above]{\(x\)};
                \draw[thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-1}, {2*2.72^(-50*\x*\x)});
                \draw[thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-50*\x*\x)});
                \draw[thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+1.5}, {2.72^(-50*\x*\x)});
                \begin{scope}
                    \draw[red,thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-1}, {2*2.72^(-50*\x*\x)});
                    \draw[red,thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-50*\x*\x)});
                    \draw[red,thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+1.5}, {2.72^(-50*\x*\x)});
                \end{scope}
                \draw (-1,0.05)--(-1,0)node[below]{\small\(-1\)};
                \draw (0,0.05)--(0,0)node[below]{\small\(0\)};
                \draw (1.5,0.05)--(1.5,0)node[below]{\small\(1.5\)};
            \end{tikzpicture}
        \end{figure}
    \end{itemize}
    You can go further to check other values of \(u\), but we should have done enough to discover a pattern. The Patterson function will have peaks at the values when there are two peaks in the electron density function align, which are exactly the ``inter-peak'' distances in the electron density. The relative weight of the peak in the Patterson function is the product of the weight of the peaks in the electron density.

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (-4,0)--(4,0)node[above]{\(x\)};
            \draw[domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-1}, {2*2.72^(-50*\x*\x)});
            \draw[domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-50*\x*\x)});
            \draw[domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+1.5}, {2.72^(-50*\x*\x)});
            \draw[<->,thick] (-1,1.5)--node[above]{\(u=\pm 1\)}(0,1.5);
            \draw[<->,thick] (-1,1)--node[above]{\(u=\pm 2.5\)}(1.5,1);
            \draw[<->,thick] (0,0.5)--node[above]{\(u=\pm 1.5\)}(1.5,0.5);
            \draw (-1,0.05)--(-1,0)node[below]{\small\(-1\)};
            \draw (0,0.05)--(0,0)node[below]{\small\(0\)};
            \draw (1.5,0.05)--(1.5,0)node[below]{\small\(1.5\)};
        \end{tikzpicture}
        \begin{tikzpicture}
            \draw[->] (-4,0)--(4,0)node[above]{\(u\)};
            \draw[thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x-2.5}, {0.5*2.72^(-50*\x*\x)});
            \draw[thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x-1.5}, {0.75*2.72^(-50*\x*\x)+1.5*2.72^(-50*(\x-0.5)*(\x-0.5))});
            \draw[thick,domain=-0.6:0.6, smooth, variable=\x,samples=50] plot ({\x}, {3.5*2.72^(-50*\x*\x)});
            \draw[thick,domain=-1:0.6, smooth, variable=\x,samples=50] plot ({\x+1.5}, {0.75*2.72^(-50*\x*\x)+1.5*2.72^(-50*(\x+0.5)*(\x+0.5))});
            \draw[thick,domain=-0.6:1, smooth, variable=\x,samples=50] plot ({\x+2.5}, {0.5*2.72^(-50*\x*\x)});
            \draw (-2.5,0.05)--(-2.5,0)node[below]{\small\(-2.5\)};
            \draw (-1.5,0.05)--(-1.5,0)node[below]{\small\(-1.5\)};
            \draw (-1,0.05)--(-1,0)node[below]{\small\(-1\)};
            \draw (0,0.05)--(0,0)node[below]{\small\(0\)};
            \draw (1,0.05)--(1,0)node[below]{\small\(1\)};
            \draw (1.5,0.05)--(1.5,0)node[below]{\small\(1.5\)};
            \draw (2.5,0.05)--(2.5,0)node[below]{\small\(2.5\)};
        \end{tikzpicture}
        \caption{Peaks in the Patterson function correspond to the inter-peak vectors in the electron density function.}
    \end{figure}

    To conclude, let's summarise some features of the Patterson function:
    \begin{enumerate}[topsep=0pt]
        \item The Patterson function is defined in the same space as \(\rho(\vb{r})\) (as opposed to the structure factor defined in the reciprocal space), and it spans a range twice that spanned by \(\rho(\vb{r})\).
        \item The Patterson function is always centrosymmetric, even if \(\rho(\vb{r})\) is not.
        \item The maximum of the Patterson function occurs at \(\vb{u}=\vb{0}\), and its value is
        \begin{equation}
            P(\vb{0})=\int\dd[3]{\vb{r}}\rho^2(\vb{r})\,.
        \end{equation}
        \item Local maxima in \(P(\vb{u})\) occur when peaks in \(\rho(\vb{r})\) overlaps with those in \(\rho(\vb{u}+\vb{r})\). This happens if the offset vector \(\vb{u}\) is some peak\(\leftrightarrow\)peak vector in \(\rho(\vb{r})\). If we take an atomic picture of the electron density, in which electron densities are concentrated on the atomic sites (we will formalise this latter), then peaks in \(P(\vb{u})\) occur when \(\vb{u}\) is an \textit{interatomic vector}.
        \item If there are \(N\) peaks in \(\rho(\vb{r})\), there are \(N^2\) interatomic vectors. Of these, \(N\) will occur at \(\vb{u}=\vb{0}\), corresponding to vectors of an atom pointing itself. Consequently, there will in general be \(N^2-N\) non-origin peaks in \(P(\vb{u})\) (some of them may overlap as well).
        \item For a function \(\rho(\vb{r})\) consists of resolved peaks, the total weight (area) of the peak produced in \(P(\vb{u})\) is proportional to the product of the weights of the peaks in \(\rho(\vb{r})\) and \(\rho(\vb{r}+\vb{u})\) producing it. If atoms in \(\rho(\vb{r})\) and \(\rho(\vb{r}+\vb{u})\) have atomic numbers \(Z_1\) and \(Z_2\), then the weight of the peaks in \(P(\vb{u})\) will be proportional to \(Z_1 Z_2\). Consequently, Patterson peaks involving heavy atoms (where \(Z_1\) and/or \(Z_2\) is large) will show up most clearly.
        \item Peaks in \(P(\vb{u})\) will be broader than in \(\rho(\vb{r})\), and peaks corresponding to vectors from light atoms may merge into a poorly-defined background.
    \end{enumerate}

    Hence, as we will see later, the Patterson function will be helpful in locating heavy atoms in a structure.

    \subsection{Patterson Function of a Molecule}
    Now consider a \(\mathrm{SO_3}\) molecule. For simplicity, we will make this problem 2 dimensional. The atomic number of \(\mathrm{S}\) and \(\mathrm{O}\) are 16 and 8 respectively, so the electron density function has one peak of weight 16, which we set at the origin, and three peaks of weight 8 at the same distance from the origin, separated by \(120^\circ\).

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (-2.5,0)--(2.5,0);
            \draw[->] (0,-2.5)--(0,2.5);
            \draw (0,0)--+(30:1.5)node[above=0.4cm]{\(\mathrm{O1}\)};
            \draw (0,0)--+(150:1.5)node[above=0.4cm]{\(\mathrm{O2}\)};
            \draw (0,0)--+(270:1.5)node[right=0.4cm]{\(\mathrm{O3}\)};
            \draw[fill=white] (0,0) node{\small\(16\)} circle (0.42);
            \draw[fill=white] (30:1.5) node{\small\(8\)} circle (0.3);
            \draw[fill=white] (150:1.5) node{\small\(8\)} circle (0.3);
            \draw[fill=white] (270:1.5) node{\small\(8\)} circle (0.3);
        \end{tikzpicture}
        \caption{The electron density of a \(\mathrm{SO_3}\) molecule.}
    \end{figure}
    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (-2.5,0)--(2.5,0);
            \draw[->] (0,-2.5)--(0,2.5);
            \draw[cyan,thick] (0,0)--+(30:1.5)node[above=0.5cm]{\(\mathrm{S\to O1}\)};
            \draw[cyan,thick] (0,0)--+(150:1.5)node[above=0.5cm]{\(\mathrm{S\to O2}\)};
            \draw[cyan,thick] (0,0)--+(270:1.5)node[right=0.5cm]{\(\mathrm{S\to O3}\)};
            \node at (0,0)[blue,below right=0.45cm]{\(\mathrm{S\to S}\)};
            \draw[fill=white] (0,0) node{\small\(256\)} circle (0.6);
            \draw[fill=white] (30:1.5) node{\small\(128\)} circle (0.42);
            \draw[fill=white] (150:1.5) node{\small\(128\)} circle (0.42);
            \draw[fill=white] (270:1.5) node{\small\(128\)} circle (0.42);
            \begin{scope}[shift={(7.5,0)}]
                \draw[->] (-2.5,0)--(2.5,0);
                \draw[->] (0,-2.5)--(0,2.5);
                \begin{scope}[shift={(210:1.5)}]
                    \draw[cyan,thick] (0,0)--(30:1.5)node[red,above=0.4cm]{\(\mathrm{O1\to O1}\)};
                    \draw[red,thick] (30:1.5)--(150:1.5)node[above=0.4cm]{\(\mathrm{O1\to O2}\)};
                    \draw[red,thick] (30:1.5)--(270:1.5)node[left=0.4cm]{\(\mathrm{O1\to O3}\)};
                    \node[cyan] at (0,0)[below left=0.35cm]{\(\mathrm{O1\to S}\)};
                    \draw[fill=white] (0,0) node{\small\(128\)} circle (0.42);
                    \draw[fill=white] (30:1.5) node{\small\(64\)} circle (0.3);
                    \draw[fill=white] (150:1.5) node{\small\(64\)} circle (0.3);
                    \draw[fill=white] (270:1.5) node{\small\(64\)} circle (0.3);
                \end{scope}
            \end{scope}
            \begin{scope}[shift={(0,-6)}]
                \draw[->] (-2.5,0)--(2.5,0);
                \draw[->] (0,-2.5)--(0,2.5);
                \begin{scope}[shift={(330:1.5)}]
                    \draw[red,thick] (150:1.5)--(30:1.5)node[above=0.4cm]{\(\mathrm{O2\to O1}\)};
                    \draw[cyan,thick] (0,0)--(150:1.5)node[red,above=0.4cm]{\(\mathrm{O2\to O2}\)};
                    \draw[red,thick] (150:1.5)--(270:1.5)node[right=0.4cm]{\(\mathrm{O2\to O3}\)};
                    \node[cyan] at (0,0)[below right=0.35cm]{\(\mathrm{O2\to S}\)};
                    \draw[fill=white] (0,0) node{\small\(128\)} circle (0.42);
                    \draw[fill=white] (30:1.5) node{\small\(64\)} circle (0.3);
                    \draw[fill=white] (150:1.5) node{\small\(64\)} circle (0.3);
                    \draw[fill=white] (270:1.5) node{\small\(64\)} circle (0.3);
                \end{scope}
            \end{scope}
            \begin{scope}[shift={(7.5,-6)}]
                \draw[->] (-2.5,0)--(2.5,0);
                \draw[->] (0,-2.5)--(0,2.5);
                \begin{scope}[shift={(0,1.5)}]
                    \draw[red,thick] (270:1.5)--(30:1.5)node[above=0.4cm]{\(\mathrm{O3\to O1}\)};
                    \draw[cyan,thick] (0,0)--(270:1.5)node[red,below left=0.3cm]{\(\mathrm{O3\to O3}\)};
                    \draw[red,thick] (150:1.5)node[above=0.4cm]{\(\mathrm{O3\to O2}\)}--(270:1.5);
                    \node[cyan] at (0,0)[above=0.45cm]{\(\mathrm{O3\to S}\)};
                    \draw[fill=white] (0,0) node{\small\(128\)} circle (0.42);
                    \draw[fill=white] (30:1.5) node{\small\(64\)} circle (0.3);
                    \draw[fill=white] (150:1.5) node{\small\(64\)} circle (0.3);
                    \draw[fill=white] (270:1.5) node{\small\(64\)} circle (0.3);
                \end{scope}
            \end{scope}
        \end{tikzpicture}
        \caption{Interatomic vectors of \(\mathrm{SO_3}\).}
    \end{figure}

    To evaluate the Patterson function, we need to find all the interatomic vectors. Let's first consider vectors from the central \(\mathrm{S}\) atom. There will be a self-vector (\(\mathrm{S\to S}\)) at the origin, with weight \(16\times 16=256\), and there will be three \(\mathrm{S\to O}\) vectors arranged symmetrically around origin, with weight \(16\times 8=128\) each. Their distance to the origin is the same as the \(\mathrm{S-O}\) bond length, which we will denote as \(r_1\). Note that this looks like the molecule itself, with the \(\mathrm{S}\) atom sitting at the origin.

    Then consider the vectors from the atom \(\mathrm{O1}\). There will be a self vector (\(\mathrm{O1\to O1}\)) at the origin, with weight \(8\times 8=64\). There are two other \(\mathrm{O\to O}\) vectors, \(\mathrm{O1\to O2}\) and \(\mathrm{O1\to O2}\), at \(60^\circ\) to each other, with weight \(64\) and length \(\sqrt{3}r_1\). Bisecting these two is a \(\mathrm{S\to O1}\) vector with weight \(128\) and length \(r_1\). Note this again look like the molecule itself, but now with \(\mathrm{O1}\) sitting at the origin. Similarly, we can consider vectors from atoms \(\mathrm{O2}\) and \(\mathrm{O3}\) as well.

    Then to construct the Patterson function, we only need to add these contributions up. The result is shown in the figure below.
    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (-3.5,0)--(3.5,0);
            \draw[->] (0,-3.5)--(0,3.5);
            \draw[fill=white] (0,0)node{448} circle (0.8);
            \foreach \i in {0,...,5}{
                \draw[fill=white] (30+\i*60:1.5) node{128} circle (0.42);
                \draw[fill=white] (\i*60:2.6) node{64} circle (0.3);
            }
        \end{tikzpicture}
        \caption{The Patterson function of a \(\mathrm{SO_3}\) molecule.}
    \end{figure}

    Some remarks:
    \begin{itemize}
        \item The weight of the origin is the sum of the squares the atomic numbers of all atoms.
        \item The Patterson function includes vectors between all atoms, not just between the chemically bonded ones.
        \item \(P(\vb{u})\) must have a centre of symmetry at the origin, even though \(\mathrm{SO_3}\) does not have one. The point group of the \(\mathrm{SO_3}\) molecule is \(D_{3h}\), and the centre of symmetry have upgraded the point group of the Patterson function to \(D_{6h}\).
    \end{itemize}

    One can use the same principle to construct the Patterson of a 3D molecule. Below an example of the Patterson function of \(\mathrm{SO_4^{2-}}\) ion, with \(T_d\) symmetry. The Patterson function has an extra inversion centre, so its point group is \(O_h\).
    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (0,-3)--(0,3);
            \draw[->] (-3,0)--(3,0);
            \draw[->] (0,0,-3)--(0,0,3);
            \draw[fill=white] (0,-0.866,-1.225) node{8} circle (0.3);
            \draw[fill=white] (0,0,0) node{16} circle (0.378);
            \draw[fill=white] (35.25:1.5) node{8} circle (0.3);
            \draw[fill=white] (144.75:1.5) node{8} circle (0.3);
            \draw[fill=white] (0,-0.866,1.225) node{8} circle (0.3);
            \begin{scope}[shift={(8,0)}]
                \draw[->] (0,-3)--(0,3);
                \draw[->] (-3,0)--(3,0);
                \draw[->] (0,0,-3)--(0,0,3);
                \draw[fill=white] (0,0,-2.45) node{64} circle (0.238);
                \draw[red,fill=white] (0,-0.866,-1.225) node{128} circle (0.3);
                \draw[red,fill=white] (0,0.866,-1.225) node{128} circle (0.3);
                \draw[fill=white] (1.225,1.732,-1.225) node{64} circle (0.238);
                \draw[fill=white] (-1.225,1.732,-1.225) node{64} circle (0.238);
                \draw[fill=white] (1.225,-1.732,-1.225) node{64} circle (0.238);
                \draw[fill=white] (-1.225,-1.732,-1.225) node{64} circle (0.238);
                \draw[blue,fill=white] (0,0,0) node{512} circle (0.476);
                \draw[red,fill=white] (35.25:1.5) node{128} circle (0.3);
                \draw[red,fill=white] (144.75:1.5) node{128} circle (0.3);
                \draw[red,fill=white] (-35.25:1.5) node{128} circle (0.3);
                \draw[red,fill=white] (-144.75:1.5) node{128} circle (0.3);
                \draw[fill=white] (2.45,0) node{64} circle (0.238);
                \draw[fill=white] (-2.45,0) node{64} circle (0.238);
                \draw[red,fill=white] (0,-0.866,1.225) node{128} circle (0.3);
                \draw[red,fill=white] (0,0.866,1.225) node{128} circle (0.3);
                \draw[fill=white] (1.225,1.732,1.225) node{64} circle (0.238);
                \draw[fill=white] (-1.225,1.732,1.225) node{64} circle (0.238);
                \draw[fill=white] (1.225,-1.732,1.225) node{64} circle (0.238);
                \draw[fill=white] (-1.225,-1.732,1.225) node{64} circle (0.238);
                \draw[fill=white] (0,0,2.45) node{64} circle (0.238);
                \draw[->] (0,0,2.688)--(0,0,3);
            \end{scope}
        \end{tikzpicture}
        \caption{The electron density and the Patterson function of \(\mathrm{SO_4^{2-}}\).}
    \end{figure}

    \subsection{The Patterson Function of Ideal Gas}
    We now move on to a more realistic case where there is a whole collection of molecules, and we will consider two extremes --- an ideal gas and a crystalline solid.

    First, let's consider an ideal gas. There are no intermolecular forces, negligible molecular volumes, and we will assume that all molecules are perfectly rigid and geometrically identical. The Patterson peaks will have contribution from all molecules: both intermolecular vectors and intramolecular vectors. For the vectors pointing within a molecule, the interatomic vectors should be identical to that for a single molecule, multiplied by the total number of molecules that are present. But as we are in the gas phase, we have another complexity. Due to the random molecular orientation, the Patterson function of an ideal gas appears as a spherically averaged version of the 3D Patterson that we constructed for one molecule. Thus, only the length of the interatomic vector is important, and we will plot the resulting Patterson function as a radial vector map. For example, for the \(\mathrm{SO_4^{2-}}\) ideal gas (which apparently will not be ideal in reality), the radial Patterson function is shown in the figure below.\footnote{As for the atomic wavefunction, you can choose to plot a radial Patterson function or a radial distribution function --- we are being rather loose here since we are doing everything schematically. Anyway, the true weight of a peak is the integral of the 3D Patterson function.}
    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (0,0)--(7,0)node[above]{\(u\)};
            \draw[->] (0,0)--(0,4)node[left]{\(P(u)\)};
            \draw[thick,domain=0:2, smooth, variable=\x,samples=50] plot ({\x}, {3*2.72^(-10*\x*\x)});
            \draw[thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+3}, {2*2.72^(-50*\x*\x)});
            \draw[thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+4.9}, {1*2.72^(-50*\x*\x)});
            \node at (3,2)[above]{\(d(\mathrm{S-O})\)};
            \node at (4.9,2)[above]{\(d(\mathrm{O\cdots O})\)};
        \end{tikzpicture}
        \caption{Intramolecular contribution to the radial Patterson function of \(\mathrm{SO_4^{2-}}\).}
    \end{figure}

    We then need to consider the intermolecular vectors. If the gas is indeed ideal with no intermolecular forces, then the positions and orientations of all molecules should be completely random at any time. Hence, all distances between molecules are equally possible, and so the intermolecular vectors will sum over time to form a constant background. If we are going to inject a little bit of reality into this crude model, we can say that the molecules cannot be too close from each other, so this background is zero at small \(u\).

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (0,0)--(7,0)node[above]{\(u\)};
            \draw[->] (0,0)--(0,4)node[left]{\(P(u)\)};
            \draw[thick,domain=0:1, smooth, variable=\x,samples=50] plot ({\x}, {2.5*2.72^(-8*\x*\x)+1});
            \draw[thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+3}, {2*2.72^(-50*\x*\x)+1});
            \draw[thick,domain=-1:1, smooth, variable=\x,samples=50] plot ({\x+4.9}, {1*2.72^(-50*\x*\x)+1});
            \draw[dashed, domain=0:4, smooth, variable=\x,samples=50] plot ({\x}, {10*\x*\x*\x*\x/(1+10*\x*\x*\x*\x)});
            \node at (3,3)[above]{\(d(\mathrm{S-O})\)};
            \node at (4.9,2)[above]{\(d(\mathrm{O\cdots O})\)};
            \draw[thick] (1,1)--(2,1);
            \draw[dashed] (4,1)--(7,1);
            \draw[<->] (1.5,0)--node[right]{\footnotesize background due to intermolecular vectors}(1.5,1);
        \end{tikzpicture}
        \caption{Radial Patterson function of \(\mathrm{SO_4^{2-}}\) with both intermolecular and intramolecular contributions.}
    \end{figure}

    As a result, in an ideal gas, the radial Patterson function has discernible peaks corresponding solely to the spherically averaged Patterson function of one molecule, superimposed on a featureless background. Non-ideal gases, liquid and non-crystalline solid will show similar radial Patterson function due their disorderedness. However, they may show local coordination peaks.

    \newpage
    \section{Diffraction from a Single Crystal}
    In the remainder of the course, we will focus almost exclusively on single crystals, since as we will see, we can develop robust methods to interpret single-crystal diffraction patterns.
    \subsection{Diffracted Intensity for a Single Crystal}
    We will first infer how the Patterson function of a crystal would look like --- this shouldn't be too difficult due to the order in a crystal, and then we will perform the Fourier transform to try to figure out the form of its diffracted intensity.

    We will consider a single crystal with unit cell vectors \(\vb{a},\vb{b},\vb{c}\), with \(N=N_a\times N_b\times N_c\) unit cells in total, where \(N_a,N_b,N_c\) are the number of cells along each direction.

    Suppose the Patterson function of a single unit cell is \(P_{\text{cell}}(\vb{u})\), then its Fourier transform will give the diffracted intensity from one unit cell, which we will call \(\abs{F_{\text{cell}}(\vb{S})}^2\).
    \begin{equation}
        \abs{F_{\text{cell}}}^2=\int\dd[3]{\vb{u}}\ee^{2\pi \ii\vb{u}\vdot\vb{S}}P_{\text{cell}}(\vb{u})\,.
    \end{equation}
    Then for our single crystal, there will be \(N\) such contributions to the diffracted intensities, so we get the intra-cell contribution \(N \abs{F_{\text{cell}}(\vb{S})}^2\).

    Next consider the contribution to the Patterson function by inter-cell vectors pointing from each cell to the cell next to it along the \(+\vb{a}\) direction. For each intra-cell vector \(\vb{u}\), there must be such a inter-cell vector \(\vb{u}+\vb{a}\), so the contribution to the Patterson function from this type of inter-cell vectors is \(P_{\text{cell}}(\vb{u}+\vb{a})\). This contributes
    \begin{equation}
        \int\dd[3]{\vb{u}}P_{\text{cell}}(\vb{u}+\vb{a})\ee^{2\pi \ii\vb{u}\vdot\vb{S}}
    \end{equation}
    to the diffraction intensity. We can simplify this a bit further. By the change of variable \(\vb{v}=\vb{u}+\vb{a}\), we have
    \begin{align}
        \int\dd[3]{\vb{u}}P_{\text{cell}}(\vb{u}+\vb{a})\ee^{2\pi \ii\vb{u}\vdot\vb{S}}&=\int\dd[3]{\vb{v}}P_{\text{cell}}(\vb{v})\ee^{2\pi \ii\vb{v}\vdot\vb{S}}\ee^{-2\pi \ii\vb{a}\vdot\vb{S}}\notag \\
        &=\abs{F_{\text{cell}}}^2 \ee^{-2\pi \ii\vb{a}\vdot\vb{S}}\,.
    \end{align}
    However, there are only \((N_a-1)N_bN_c\) cells have such a neighbouring cell one unit along \(+\vb{a}\) direction, so its contribution to the diffraction intensity is
    \begin{equation}
        (N_a-1)N_bN_c\abs{F_{\text{cell}}}^2 \ee^{-2\pi \ii\vb{a}\vdot\vb{S}}\,.
    \end{equation}
    Similarly, there are also contributions from inter-cell vectors pointing from a cell to the neighbouring cell along \(-\vb{a}\) direction, which is
    \begin{equation}
        (N_a-1)N_bN_c\abs{F_{\text{cell}}}^2 \ee^{+2\pi \ii\vb{a}\vdot\vb{S}}\,.
    \end{equation}

    The rest of the process is similar, there will be inter-cell vectors pointing from one cell to the cell \(n_a\vb{a}+n_b\vb{b}+n_c\vb{c}\) away for any \(-N_a< n_a< N_a\), \(-N_b< n_b< N_b\), \(-N_c< n_c< N_c\), contributing
    \begin{equation}
        (N_a-\abs{n_a})(N_b-\abs{n_b})(N_c-\abs{n_c})\abs{F_{\text{cell}}}^2 \ee^{-2\pi \ii(n_a\vb{a}+n_b\vb{b}+n_c\vb{c})\vdot\vb{S}}
    \end{equation}
    to the total diffraction intensity. We need to sum all of these up, and we get a total diffraction intensity
    \begin{align}
        I(\vb{S})&=\abs{F_{\text{cell}}}^2\sum_{n_a=-N_a}^{N_a}\sum_{n_b=-N_b}^{N_b}\sum_{n_c=-N_c}^{N_c}(N_a-\abs{n_a})(N_b-\abs{n_b})(N_c-\abs{n_c})\ee^{-2\pi \ii(n_a\vb{a}+n_b\vb{b}+n_c\vb{c})\vdot\vb{S}}\notag \\
        &=\abs{F_{\text{cell}}}^2\prod_{j\in\{a,b,c\}}\sum_{n_j=-N_j+1}^{N_j-1}(N_j-\abs{n_j})\ee^{-2\pi \ii n_j\vb{j}\vdot\vb{S}}\,.
    \end{align}
    The latter form is rather more compact, but less intuitive.\footnote{You might have noticed that the limits of the sum should be \(\pm(N_j-1)\) instead of \(N_j\). We have included \(n_j=\pm N_j\) into our sum since they contribute nothing and can make our formula slightly more compact.}

    \subsubsection*{A more Mathematical View}
    Consider the convolution of some function \(f(\vb{r})\) with a Dirac delta \(\delta(\vb{r}-\vb{a})\) with its peak at \(\vb{r}=\vb{a}\).
    \begin{equation}
        f(\vb{r})*\delta(\vb{r}-\vb{a})=\int_{-\infty}^{\infty}\dd[3]{\vb{u}}f(\vb{u})\delta(\vb{u}-(\vb{r}-\vb{a}))=f(\vb{r}-\vb{a})\,.
    \end{equation}
    We see that its effect is to shift \(f(\vb{r})\) by \(\vb{a}\) --- or in other words, it put a copy of \(f(\vb{r})\) at position \(\vb{a}\). A crystal is essentially a copy of \(\rho_{\text{cell}}\) at each lattice point\footnote{This is not quite accurate as a unit cell may contain more than one lattice point in non-primitive cell. This is not a crystallographic course so we will be rather loose here.}. This allows us to view the electron density of a crystal as the convolution of the lattice of Dirac delta functions with the electron density of a single unit cell:
    \begin{equation}\label{crystal_electron_density_as_convolution}
        \rho(\vb{r})=\rho_{\text{cell}}(\vb{r})*\rho_{\text{lattice}}(\vb{r})\,,
    \end{equation}
    where
    \begin{equation}
        \rho_{\text{lattice}}(\vb{r})=\sum_{n_a=0}^{N_a-1}\sum_{n_b=0}^{N_b-1}\sum_{n_c=0}^{N_c-1}\delta(\vb{r}-n_a\vb{a}-n_b\vb{b}-n_c\vb{c})
    \end{equation}
    is the lattice of delta functions (It is obviously not a electron density, but we will denote it as \(\rho\) anyway). A rather useful properties is the Patterson function of a convolution is the convolution of the Patterson functions,\footnote{This is perhaps not too obvious to prove using the integral definitions of these quantities. However, an important fact of electron density is that it is a real function, so \(P(\vb{r})=\rho(\vb{r})\otimes\rho(\vb{r})=\rho(\vb{r})*\rho(-\vb{r})\). Then
    \begin{align}
        P(\vb{r})&=\rho(\vb{r})*\rho(-\vb{r})\notag \\
        &=[\rho_{\text{cell}}(\vb{r})*\rho_{\text{lattice}}(\vb{r})]*[\rho_{\text{cell}}(-\vb{r})*\rho_{\text{lattice}}(-\vb{r})]\notag \\
        &=[\rho_{\text{cell}}(\vb{r})*\rho_{\text{cell}}(-\vb{r})]*[\rho_{\text{lattice}}(\vb{r})*\rho_{\text{lattice}}(-\vb{r})]\notag \\
        &=P_{\text{cell}}(\vb{r})*P_{\text{lattice}}(\vb{r})
    \end{align}
    by the commutativity and associativity of convolution (which are not that difficult to prove).} and so
    \begin{equation}
        P(\vb{u})=P_{\text{cell}}(\vb{u})*P_{\text{lattice}}(\vb{u})\,.
    \end{equation}
    The Patterson function (autocorrelation) of the lattice of delta functions is
    \begin{equation}
        P_{\text{lattice}}(\vb{u})=\sum_{n_a=-N_a}^{N_a}\sum_{n_b=-N_b}^{N_b}\sum_{n_c=-N_c}^{N_c}(N_a-\abs{n_a})(N_b-\abs{n_b})(N_c-\abs{n_c})\delta(\vb{u}-n_a\vb{a}-n_b\vb{b}-n_c\vb{c})\,.
    \end{equation}
    Then by the convolution theorem, the diffracted intensity, which is the Fourier transform of the Patterson function, must be the product of the diffracted intensity of a unit cell \(\abs{F_{\text{cell}}(\vb{r})}^2\) with the Fourier transform of this Patterson function of the lattice, which is given by
    \begin{equation}
        I(\vb{S})=\abs{F_{\text{cell}}}^2\sum_{n_a=-N_a}^{N_a}\sum_{n_b=-N_b}^{N_b}\sum_{n_c=-N_c}^{N_c}(N_a-\abs{n_a})(N_b-\abs{n_b})(N_c-\abs{n_c})\ee^{-2\pi \ii(n_a\vb{a}+n_b\vb{b}+n_c\vb{c})\vdot\vb{S}}\,.
    \end{equation}
    We have arrived at the same result.

    \subsection{The Reciprocal Lattice}
    Although we can't measure the structure factor, we can still work it out assuming we know \(\rho(\vb{r})\) to see how it looks like for a single crystal. Using the above expression of the electron density as a convolution (\ref{crystal_electron_density_as_convolution}), we can directly take its Fourier transform and get the structure factor
    \begin{align}
        F(\vb{S})&=F_{\text{cell}}(\vb{S})\mathcal{F}\left[\sum_{n_a=0}^{N_a-1}\sum_{n_b=0}^{N_b-1}\sum_{n_c=0}^{N_c-1}\delta(\vb{r}-n_a\vb{a}-n_b\vb{b}-n_c\vb{c})\right]\notag \\
        &=F_{\text{cell}}(\vb{S})\left[\sum_{n_a=0}^{N_a-1}\sum_{n_b=0}^{N_b-1}\sum_{n_c=0}^{N_c-1}\ee^{-2\pi \ii(n_a\vb{a}+n_b\vb{b}+n_c\vb{c})\vdot\vb{S}}\right]\notag \\
        &=F_{\text{cell}}(\vb{S})\prod_{j\in\{a,b,c\}}\sum_{n_j=0}^{N_j-1}\ee^{-2\pi \ii n_j\vb{j}\vdot\vb{S}}\,.
    \end{align}
    We see a cute geometric series here! This allows to simplify it further
    \begin{align}
        F(\vb{S})&=F_{\text{cell}}(\vb{S})\prod_{j\in\{a,b,c\}}\frac{1-\exp[-2\pi \ii N_j\vb{j}\vdot\vb{S}]}{1-\exp[-2\pi \ii\vb{j}\vdot\vb{S}]}\notag \\
        &=F_{\text{cell}}(\vb{S})\prod_{j\in\{a,b,c\}}\frac{\exp[-\pi \ii N_j\vb{j}\vdot\vb{S}]}{\exp[-\pi \ii\vb{j}\vdot\vb{S}]}\frac{\exp[\pi \ii N_j\vb{j}\vdot\vb{S}]-\exp[-\pi \ii N_j\vb{j}\vdot\vb{S}]}{\exp[\pi \ii\vb{j}\vdot\vb{S}]-\exp[-\pi \ii\vb{j}\vdot\vb{S}]}\notag \\
        &=F_{\text{cell}}(\vb{S})\prod_{j\in\{a,b,c\}}\exp[-\pi \ii (N_j-1)\vb{j}\vdot\vb{S}]\frac{\sin(\pi N_j\vb{j}\vdot\vb{S})}{\sin(\pi\vb{j}\vdot\vb{S})}
    \end{align}
    Having the structure factor in this form, we can work out another expression of the diffraction intensity of single crystal
    \begin{align}
        I(\vb{S})&=F(\vb{S})F^*(\vb{S})\notag\\
        &=\abs{F_{\text{cell}}(\vb{S})}^2\prod_{j\in\{a,b,c\}}\frac{\sin^2(\pi N_j\vb{j}\vdot\vb{S})}{\sin^2(\pi\vb{j}\vdot\vb{S})}\notag\\
        &=\abs{F_{\text{cell}}(\vb{S})}^2\frac{\sin^2(\pi N_a\vb{a}\vdot\vb{S})}{\sin^2(\pi\vb{a}\vdot\vb{S})}\frac{\sin^2(\pi N_b\vb{b}\vdot\vb{S})}{\sin^2(\pi\vb{b}\vdot\vb{S})}\frac{\sin^2(\pi N_c\vb{c}\vdot\vb{S})}{\sin^2(\pi\vb{c}\vdot\vb{S})}\,.
    \end{align}
    This is somewhat easier to plot. To make the plotting easier, we will consider a 1D crystal of \(N\) units cell, so
    \begin{equation}
        \frac{I(S)}{\abs{F_{\text{cell}}(S)}^2}=\frac{\sin^2(\pi NaS)}{\sin^2(\pi aS)}\,.
    \end{equation}
    Let's plot this function at different values of \(N\) and see how they look like.

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (0,0)node[below left]{\small 0}--(3.3,0)node[right]{\small\(S\)};
            \draw[->] (0,0)--(0,3.5)node[left]{\small\(\frac{I(S)}{\abs{F_{\text{cell}}(S)}^2}\)};
            \draw (1,0)--(1,-0.05)node[below]{\small\(1/a\)};
            \draw (2,0)--(2,-0.05)node[below]{\small\(2/a\)};
            \draw (3,0)--(3,-0.05)node[below]{\small\(3/a\)};
            \draw (0,1.5)--(-0.05,1.5)node[left]{\small\(5\)};
            \draw (0,3)--(-0.05,3)node[left]{\small\(10\)};
            \draw[thick,domain=0.02:2.98, smooth, variable=\x,samples=100] plot ({\x}, {0.3*(sin(3.1415*3*\x r)/sin(3.1415*\x r))^2});
            \node at (1.5,-1){(a) \(N=3\)};
            \begin{scope}[shift={(5,0)}]
                \draw[->] (0,0)node[below left]{\small 0}--(3.3,0)node[right]{\small\(S\)};
                \draw[->] (0,0)--(0,3.5)node[left]{\small\(\frac{I(S)}{\abs{F_{\text{cell}}(S)}^2}\)};
                \draw (1,0)--(1,-0.05)node[below]{\small\(1/a\)};
                \draw (2,0)--(2,-0.05)node[below]{\small\(2/a\)};
                \draw (3,0)--(3,-0.05)node[below]{\small\(3/a\)};
                \draw (0,1.5)--(-0.05,1.5)node[left]{\small\(25\)};
                \draw (0,3)--(-0.05,3)node[left]{\small\(50\)};
                \draw[thick,domain=0.001:2.999, smooth, variable=\x,samples=200] plot ({\x}, {0.06*(sin(3.1415*7*\x r)/sin(3.1415*\x r))^2});
                \node at (1.5,-1){(b) \(N=7\)};
            \end{scope}
            \begin{scope}[shift={(10,0)}]
                \draw[->] (0,0)node[below left]{\small 0}--(3.3,0)node[right]{\small\(S\)};
                \draw[->] (0,0)--(0,3.5)node[left]{\small\(\frac{I(S)}{\abs{F_{\text{cell}}(S)}^2}\)};
                \draw[thick,domain=0.001:2.999, smooth, variable=\x,samples=200] plot ({\x}, {0.005*(sin(3.1415*25*\x r)/sin(3.1415*\x r))^2});
                \draw (0,1.5)--(-0.05,1.5)node[left]{\small\(300\)};
                \draw (0,3)--(-0.05,3)node[left]{\small\(600\)};
                \draw (1,0)--(1,-0.05)node[below]{\small\(1/a\)};
                \draw (2,0)--(2,-0.05)node[below]{\small\(2/a\)};
                \draw (3,0)--(3,-0.05)node[below]{\small\(3/a\)};
                \node at (1.5,-1){(c) \(N=25\)};
            \end{scope}
        \end{tikzpicture}
    \end{figure}

    We see that the functions have principal maxima at \(S=k/a\) for integer values of \(k\), and there are \(N-2\) subsidiary maxima between the principal maxima. As we increase \(N\), the principal maxima becomes too strong that we can no longer see the subsidiary maxima. We can see this by taking the limit
    \begin{equation}
        \lim_{S\to k/a}\frac{\sin^2(\pi NaS)}{\sin^2(\pi aS)}=\lim_{u\to k}\left(\frac{\sin Nu\pi}{\sin u\pi}\right)^2=\lim_{u\to k}\left(\frac{N\pi\cos Nu\pi}{\pi\cos u\pi}\right)^2=N^2\,,
    \end{equation}
    so the height of the principal maxima is \(N^2\). Hence, in the limit of large \(N\) (in real-life crystals, \(N\sim 10^{23}\)), we can well-approximate the diffraction pattern of single crystals as discrete beams, separated by \(1/a\).

    Similarly, in a 3D crystals, the diffraction intensity will only be observable at discrete values of \(\vb{S}\) separated by \(1/\norm{\vb{a}}\), \(1/\norm{\vb{b}}\) and \(1/\norm{\vb{c}}\). This forms what is called a \textit{reciprocal lattice}, with lattice vectors \(\vb{a}^*\), \(\vb{b}^*\) and \(\vb{c}^*\) given by
    \begin{align}
        \vb{a}^*&=\frac{\vb{b}\cross\vb{c}}{V} & \vb{b}^*&=\frac{\vb{c}\cross\vb{a}}{V} & \vb{c}^*&=\frac{\vb{a}\cross\vb{b}}{V}\,,
    \end{align}
    where \(V=\vb{a}\vdot(\vb{b}\cross\vb{c})\) is the volume of the unit cell. We will only observe diffracted beams with
    \begin{equation}
        \vb{S}=h\vb{a}^*+k\vb{b}^*+l\vb{c}^*\,,
    \end{equation}
    i.e. on the reciprocal lattice points. We will show later that this corresponds to the same \(h,k,l\) as in the Miller planes in Bragg's description of diffraction which you might have seen if you take Part IA Material Sciences.

    It is called the reciprocal lattice because it lives in the reciprocal space (Fourier domain). In fact, the reciprocal lattice is the Fourier transform of the real lattice. The unit of the reciprocal lattice vectors are \(\text{length}^{-1}\), and their magnitudes are given by
    \begin{align}
        \norm{\vb{a}^*}&=\frac{\norm{\vb{b}}\norm{\vb{c}}\sin\alpha}{V} & \norm{\vb{b}^*}&=\frac{\norm{\vb{c}}\norm{\vb{a}}\sin\beta}{V} & \norm{\vb{c}^*}&=\frac{\norm{\vb{a}}\norm{\vb{b}}\sin\gamma}{V}\,,
    \end{align}
    where \(\alpha\) is the angle between \(\vb{b}\) and \(\vb{c}\), \textit{etc.} This means that we can view the reciprocal lattice as ``the lattice of periodicities in a crystal''. To see this, let's consider all the possible set of repeated parallel planes that are compatible with the periodicity of the crystal. By being compatible with the periodicity, we require it to look identical in different unit cells, which requires the planes to intersect each edge of the lattice an integer number of times. This allows us to define the \textit{Miller indices} for repeated planes in crystals by specifying how many times the plane intersect with the edge of the cell in each direction. If we put the first plane at the origin and the second plane intersects the axes at \(1/h\), \(1/k\) and \(1/l\) for \(h,k,l\in\mathbb{Z}\), then we would label these planes as \((hkl)\). Then this set of planes will intersect \(\vb{a}\) axis \(h\) times, \(\vb{b}\) axis \(k\) times and \(\vb{c}\) axis \(l\) times.

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw (0,0,0) rectangle (2,2,0);
            \draw (0,0,2) rectangle (2,2,2);
            \draw (0,0,0)--(0,0,2);
            \draw (2,0,0)--(2,0,2);
            \draw (0,2,0)--(0,2,2);
            \draw (2,2,0)--(2,2,2);
            \draw[->,thick] (0,0,0)--(2,0,0)node[right]{\(\vb{a}\)};
            \draw[->,thick] (0,0,0)--(0,0,2)node[left]{\(\vb{b}\)};
            \draw[->,thick] (0,0,0)--(0,2,0)node[left]{\(\vb{c}\)};
            \draw[fill=gray] (1,0,0)node[below]{\small\(1/h\)}--(0,0,0.66)node[below]{\small\(1/k\)}--(0,1,0)node[right]{\small\(1/l\)}--(1,0,0);
        \end{tikzpicture}
        \caption{A \((hkl)\) plane in a unit cell. There will be another \(\max(h,k,l)\) planes parallel to this in this cell, intersecting \(\vb{a}\) axis at \(1/h,2/h,\dots,1\), \(\vb{b}\) axis at \(1/k,2/k,\dots,1\) and \(\vb{c}\) axis at \(1/l,2/l,\dots,1\).}
    \end{figure}

    We can use these planes to construct the reciprocal lattice. Consider viewing the lattice along the \(\vb{b}\) direction, and constructing planes of \((h0l)\) types. For each set of plane, if we draw a vector perpendicular to these planes and magnitude inversely proportional to the interplanar spacing, then the end of these vectors will form the \((h0l)\) section of the reciprocal lattice.

    \begin{figure}
        \centering
        \begin{tikzpicture}
            \foreach \i in {0,...,4}{
                \foreach \j in {0,...,3}{
                    \draw[fill=black] (\i-0.15*\j,-0.7*\j) circle (0.05);
                    \draw (\i,0)--(\i-0.45,-2.1);
                    \draw (-0.15*\j,-0.7*\j)--(4-0.15*\j,-0.7*\j);
                }
            }
            \draw[->] (0,0)--(-0.525,-2.45)node[left]{\(\vb{a}\)};
            \draw[->] (0,0)--(4.5,0)node[above]{\(\vb{c}\)};
            \draw[thick,blue] (-0.4,0)--(4.4,0);
            \draw[thick,blue] (-0.55,-0.7)--(4.25,-0.7);
            \draw[thick,blue,->] (2.2,0)--(2.2,-1)node[right]{\scriptsize\(100\)};
            \draw[thick,red] (0.05,0.2333)--(-0.5,-2.3333);
            \draw[thick,red] (1.05,0.2333)--(0.5,-2.3333);
            \draw[thick,red,->] (-0.35,-1.6333)--(0.45,-1.7833)node[below]{\scriptsize\(001\)};
            \draw[thick,violet] (0.6625,0.175)--(-0.3125,-0.875);
            \draw[thick,violet] (1.1625,0.175)--(-0.4625,-1.575);
            \draw[thick,violet,->] (0.175,-0.35)--+(1.4,-1.3)node[right]{\scriptsize\(102\)};
            \begin{scope}[shift={(7,0.5)}]
                \foreach \i in {0,...,4}{
                    \foreach \j in {0,...,3}{
                        \draw[fill=black] (0.7*\i,-0.15*\i-\j) node[below right]{\scriptsize\(\j 0 \i\)} circle (0.05);
                        \draw (0,-\j)--(2.8,-0.6-\j);
                        \draw (0.7*\i,-0.15*\i)--(0.7*\i,-3-0.15*\i);
                    }
                }
                \draw[->] (0,0)--(3.15,-0.675)node[right]{\(\vb{c}^*\)};
                \draw[->] (0,0)--(0,-3.5)node[left]{\(\vb{a}^*\)};
                \draw[red,thick,->] (0,0)--(0.7,-0.15);
                \draw[blue,thick,->] (0,0)--(0,-1);
                \draw[violet,thick,->] (0,0)--(1.4,-1.3);
            \end{scope}
        \end{tikzpicture}
        \caption{Constructing the reciprocal lattice using planes.}
    \end{figure}

    By the definition of the reciprocal lattice vectors, it is easy to see that
    \begin{equation}
        \vb{i}\vdot\vb{j}^*=\delta_{ij}\,,
    \end{equation}
    \(i,j\in\{a,b,c\}\). Hence, by expanding \(\vb{r}=x\vb{a}+y\vb{b}+z\vb{c}\) and \(\vb{S}=h\vb{a}^*+k\vb{b}^*+l\vb{c}^*\), we can see that
    \begin{align}
        \vb{r}\vdot\vb{S}&=xh\vb{a}\vdot\vb{a}^*+xk\cancel{\vb{a}\vdot\vb{b}^*}+xl\cancel{\vb{a}\vdot\vb{c}^*}\notag\\
        &\quad\ yh\cancel{\vb{b}\vdot\vb{a}^*}+yk\vb{b}\vdot\vb{b}^*+yl\cancel{\vb{b}\vdot\vb{c}^*}\notag\\
        &\quad\ zh\cancel{\vb{c}\vdot\vb{a}^*}+zk\cancel{\vb{c}\vdot\vb{b}^*}+zl\vb{c}\vdot\vb{c}^*\notag\\
        &=xh+yk+zl\,.
    \end{align}
    Therefore for a single crystal, the structure factor can be rewritten as
    \begin{align}
        F(h,k,l)=\int\dd{x}\dd{y}\dd{z}\rho(x,y,z)\ee^{2\pi \ii(hx+ky+lz)}\,.
    \end{align}

    \subsection{Bragg's Law}
    \begin{figure}
        \centering
        \begin{tikzpicture}
            \foreach \i in {0,...,-3}{
                \draw (-3,0.7*\i)--(3,0.7*\i);
            }
            \draw[->] (0,-2.1)--(0,2.1)node[above]{normal};
            \draw[<->] (0.3,-2.1)--node[right]{\(d\)}(0.3,-1.4);
            \draw[->,red,thick] (0,0)--+(30:3);
            \draw[red,thick] (0,0)--+(150:3);
            \draw[->,red,thick] (0,-0.7)--+(30:3);
            \draw[red,thick] (0,-0.7)--+(150:3);
            \draw (0.3,0) arc (0:30:0.3);
            \node at (0.4,0.2)[right]{\(\theta\)};
            \draw[dashed] (0,0)--+(-60:0.606);
            \draw[dashed] (0,0)--+(-120:0.606);
        \end{tikzpicture}
        \caption{Diffraction using Bragg planes.}
    \end{figure}
    Here we present an alternative view of diffraction in a single crystal, which might be familiar from Part IA Material Sciences. We can think of the diffracted beam as being reflected by the planes in crystals, which are known as the Bragg's planes. The scattering vector is bisecting the incoming and outgoing rays, so it is perpendicular to those imaginary mirror planes. Now for a constructive interference to occur, we need the path difference of light reflected by consecutive Bragg planes to be an integer multiple of the wavelength, so
    \begin{equation}
        n\lambda=2d\sin\theta\,,
    \end{equation} 
    where \(\theta\) is the angle between the planes and the beams, and \(d\) is the interplanar spacing. This factor of \(n\) can be omitted since diffraction from with \(n>1\) from a set of planes \((h\, k\, l)\) with spacing \(d\) is equivalent to diffraction with \(n=1\) from planes with spacing \(d/n\), so we can instead think of them as being reflected from a high-order plane \((nh\, nk\, nl)\). For example, a \(n=4\) reflection from \(100\) planes is equivalent to a \(n=1\) reflection from \(400\) planes. Therefore, we have the Bragg's law
    \begin{equation}
        \lambda=2d\sin\theta
    \end{equation}
    for diffraction to be observed. We have defined \(\norm{\vb{S}}=2\sin\theta/\lambda\), and so \(\norm{\vb{S}}=1/d\). This again shows why diffraction is only observed on reciprocal lattice points.

    \subsection{Practical Measurements of Single-Crystal X-Ray Diffraction}
    Suppose we are measuring the diffraction from a particular single crystal. Since a crystal has a defined orientation, a certain scattering vector \(\vb{S}=h\vb{a}^*+k\vb{b}^*+l\vb{c}^*\) will appear in a well-defined direction relative to the crystal (perpendicular to the \(hkl\) planes). We can think the reciprocal lattice is attached to the crystal, and hence to measure a particular \(hkl\) diffraction, we need to arrange the incident beam to a particular direction relative to the crystal given by the Bragg's law. This requires us to be able to flexibly adjust the relative orientation of the incident beam, the detector and the crystal.
    \begin{figure}[ht!]
        \centering
        \includegraphics[width=0.6\textwidth]{Single_crystal_diffraction.jpg}
        \caption{A schematic illustration of diffraction in a single crystal.}
    \end{figure}
    
    Practically, it is very difficult to move the X-ray source, so we have to move the crystal and the detector. If the source and the detector are making an angle \(2\theta\), then this will correspond to a scattering vector of length \(2\sin\theta/\lambda\) and direction bisecting the line from the crystal to the source and to the detector. If this scattering vector happens to hit one of the reciprocal lattice point, then we will see a non-zero diffracted intensity in the detector. To make that happen, we have to be able to freely rotate the crystal around all 3 directions, so that we are effectively moving the reciprocal lattice attached to the crystal. This is achieved using a \textit{goniometer}.

    \begin{figure}
        \centering
        \includegraphics[width=0.7\textwidth]{XRD_apparatus.jpg}
        \caption{Apparatus for measuring the X-ray diffraction of a single crystal practically.}
    \end{figure}

    The outcome of a single-crystal X-ray diffraction measurement can be conceptually divided into two parts.
    \begin{enumerate}[topsep=0pt]
        \item \textit{Geometrical information.} From the value of \(\vb{S}=h\vb{a}^*+k\vb{b}^*+l\vb{c}^*\) we measured non-zero diffraction intensity, we can infer the reciprocal lattice vectors, and hence the real lattice vectors of the crystal. This can be done using only a small proportion of all the diffraction data, so only costs a few minutes.
        \item \textit{A list of diffracted intensity.} Once the geometry of the crystal in known, we can point the crystal and the detector only to where we know that there will be diffraction occurring. Then we can get a list of \(hkl\) values of measured diffracted beams and the corresponding diffraction intensities \(\abs{F(hkl)}^2\). To calculate the Patterson function (or the electron density if we somehow figure out the phases of the beams using methods that will be introduced later), we need the structure factor of the whole reciprocal space. This is not practical to do since there will be some maximum \(\norm{\vb{S}}\) value we are able to reach, and the diffraction will be weak for high \(hkl\) values. What we can do is to measure as many diffracted peaks as possible. This generally take hours, and hence X-ray diffraction is a slow technique, and the resulting structures are usually time-averaged.
    \end{enumerate}

    \subsection{The Independent Atom Model}
    Although \(\rho(\vb{r})\) is a continuous function, we are generally only interested in the positions and types of atoms. We will see how can we make further progress if we introduce an atomic picture.

    We will make the following assumptions.
    \begin{enumerate}[topsep=0pt]
        \item The electron density is not continuous, but instead gathered into isolated, individual atoms at fixed sites. The atoms are spherical.
        \item All electrons are located within atoms. Delocalised electrons or electrons in chemical bonds that are between atoms are neglected.
    \end{enumerate}
    This formalism is known as the \textit{independent atom model} (IAM). The second assumption seems like a fairly suspicious one. As chemists, we all know that chemical structures are held together by chemical bonds, and covalent bonds definitely involve the sharing of atoms. However for most elements, the majority of electrons are core electrons, which are little involved in bonding and are very localised. An obvious exception is hydrogen --- we will discuss more on hydrogen later.

    Now, if we describe the electron density of an atom labelled \(n\) as a spherically symmetric function \(\rho_{\text{atom}, n}(\vb{r})\), then the total electron density in the crystal is
    \begin{equation}
        \rho(\vb{r})=\sum_n \rho_{\text{atom},n}(\vb{r})*\delta(\vb{r}-x_n\vb{a}-y_n\vb{b}-z_n\vb{c})\,,
    \end{equation}
    where \((x_n,y_n,z_n)\) is the fractional coordinate of atom \(n\) and the sum is taken over all atoms in the crystal. Now from the convolution theorem, the structure factor of the cell is
    \begin{align}
        F(\vb{S})&=\mathcal{F}[\rho(\vb{r})]\notag\\
        &=\sum_n\mathcal{F}[\rho_{\text{atom},n}(\vb{r})]\mathcal{F}[\delta(\vb{r}-x_n\vb{a}-y_n\vb{b}-z_n\vb{c})]\notag\\
        &\eqqcolon \sum_n f_n(\vb{S})\exp(2\pi \ii\vb{r}_n\vdot\vb{S})\notag\\
        &=\sum_n f_n(\vb{S})\exp(2\pi \ii(hx_n+ky_n+lz_n))\,,
    \end{align}
    where the \(f_n\) is the Fourier transform of \(\rho_{\text{atom},n}(\vb{r})\) called the \textit{atomic scattering factor}. It can be seen as the diffraction of a single atom, and has unit of electrons. Since we assume \(\rho_{\text{atom},n}(\vb{r})\) is spherically symmetric, \(f(\vb{S})\) is spherically symmetric as well. Although some other more complicated model may apply (e.g. multipole expansion) to make both \(\rho_{\text{atom},n}(\vb{r})\) and \(f(\vb{S})\) not spherically symmetric, we shall not concern with these.

    \subsubsection{Atomic Scattering Factor}
    For the special case of \(\vb{S}=\vb{0}\),
    \begin{equation}
        F(\vb{0})=\sum f_n(\vb{0})=\int\dd{V}\rho(\vb{r})\,.
    \end{equation}
    For this to hold, we must have \(f_n(\vb{0})\) equal to the total number of electrons in atom \(n\). As \(\vb{S}\) moves away from zero, the value of \(f_n\) must change to reflect the interference occurring between X-rays scattered from different positions within the atom's volume. Under the assumption that \(f(\vb{S})\) is spherically symmetric, it is only dependent on \(\norm{\vb{S}}=(2\sin\theta)/\lambda\), so the scattering factor is usually fitted to parameterised function of \((\sin\theta)/\lambda\) as
    \begin{equation}
        f\left(\frac{\sin\theta}{\lambda}\right)=c+\sum_{i=1}^{4}a_i\exp\left[-b_i\left(\frac{\sin\theta}{\lambda}\right)^2\right]
    \end{equation}
    with nine tabulated parameters for each atom. These parameters are known as Cromer--Mann coefficients.

    Some examples of spherically symmetric atomic scattering factors are shown in \cref{Fig:scattering_factor}. We can see that \(f(0)\) is equal to the number of electrons in the atom/ion. Heavier elements generally have larger atomic scattering factors. For species having the same number of electrons, if the atom/ion is larger, than the scattering factors drop off more quickly. This is because a bigger atom would induce a larger path difference in diffraction, and hence leads to lower \(f_n\).\footnote{You can understand this by modelling the electron density in an atom as a Gaussian of width \(\sigma\). Its Fourier transform (the scattering factor) will be a Gaussian of width \(\sigma^{-1}\). Hence, if the atom is larger, then the scattering factor has smaller width. If we have a ``point'' atom, whose electron density is a delta function, then its Fourier transform is a constant, so the scattering factor will not drop off.}
    \begin{figure}
        \centering
        \begin{subfigure}[h]{0.45\linewidth}
            \begin{adjustbox}{width=\linewidth}
                \input{Scattering_factor_electron.tex}
            \end{adjustbox}
            \caption{Scattering factors of different species with different numbers of electrons.}
        \end{subfigure}
        \hfill
        \begin{subfigure}[h]{0.45\linewidth}
            \begin{adjustbox}{width=\linewidth}
                \input{Scattering_factor_size.tex}
            \end{adjustbox}
            \caption{Scattering factors of different species with the same number of electrons.}
        \end{subfigure}
        \caption{Atomic scattering factors of different species.}
        \label{Fig:scattering_factor}
    \end{figure}

    These factors are derived quantum mechanically from atomic wavefunctions, which are effectively at \(0\unit{K}\). In practice, atoms in crystals are typically slightly displaced from their average position --- this may be dynamic (due to thermal vibration) or static. This effectively makes the atom look larger, and hence the atomic scattering factor will drop off more quickly. This will put an extra \textit{Debye--Waller factor}
    \begin{equation}
        \exp\left(-\frac{8\pi^2\eval{u^2}\sin^2\theta}{\lambda^2}\right)
    \end{equation}
    onto the atomic scattering factor at \(0\unit{K}\).

    \begin{figure}
        \centering
        \input{Scattering_factor_disp.tex}
        \caption{The atomic scattering factor of \(\mathrm{C}\) with and without isotropic displacement.}
    \end{figure}

    To conclude, under the independent atomic model, the structure factor of an atomic single crystal is
    \begin{equation}
        F(h,k,l)=\sum_n f_n\exp[2\pi \ii(hx_n+ky_n+lz_n)]\,,
    \end{equation}
    where \(n\) is taken over all atoms in the crystals. However, we have seen that \(\abs{F_{hkl}}^2=N^2\abs{F_{\text{cell}}(hkl)}^2\), so the relative intensities of the diffracted beams are proportional to \(\abs{F_{\text{cell}}(hkl)}^2\). To solve for this, we only need to sum over all atoms in a unit cell
    \begin{equation}
        F_{\text{cell}}(h,k,l)=\sum_n f_n\exp[2\pi \ii(hx_n+ky_n+lz_n)]\,.
    \end{equation}
    From now on we will drop the ``cell'' subscript, and we will always refer to \(F_{\text{cell}}\). We see that this has now become a Fourier series. To figure out the electron density, we apply the inverse Fourier transform and we get
    \begin{equation}\label{Fourier_synthesis}
        \rho(x,y,z)=\frac{1}{V_{\text{cell}}}\sum_{h}\sum_{k}\sum_{l}F(h,k,l)\exp[-2\pi \ii(hx+ky+lz)]\,,
    \end{equation}
    where \(1/V_{\text{cell}}\) is volume of the unit cell for normalisation. This is also known as a \textit{Fourier synthesis}, because it `synthesises' the electron density by its frequency components using a complex Fourier series.

    \newpage

    \section{Symmetry in Crystals}
    In the previous chapter, we have already exploited the translation symmetry of crystals, which is their defining property. Typically, crystals also display other types of symmetries, such as rotations, mirror planes, and inversions (although they need not). This leads us to something that looks like the \textit{point groups} that describe the symmetry of molecules, but in crystals, we have additional translational symmetry, so they are instead known as \textit{space groups}. Rather remarkably, there are only 230 possible 3D space groups --- the number is finite, unlike for point groups where there can be an infinite number of them. This is because not all symmetry elements are compatible with the translational symmetry, leaving us with a limited possible combination of symmetry elements. The most famous example is probably that a crystal can never have a five-fold rotation axis\footnote{Something known as a \textit{quasi-crystal} can, but it has no translational symmetry.}.

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[fill=gray!20] (90:1)--(162:1)--(234:1)--(306:1)--(18:1)--(90:1);
            \foreach \i in {0,...,4}{
                \begin{scope}[shift = {(-18+72*\i :1.618)}]
                    \draw[fill=gray!20, rotate=180] (90:1)--(162:1)--(234:1)--(306:1)--(18:1)--(90:1);
                \end{scope}
            }
        \end{tikzpicture}
        \caption{Five-fold rotational symmetry is not compatible with translational symmetry.}
    \end{figure}

    Let's first see how various symmetry operators affect the diffraction patterns.
    \subsection{Symmetry Operations}
    \subsubsection{Inversion Centre}
    Suppose there is an inversion centre in the crystal, then by translational symmetry there must be one in each unit cell. We set it to be the origin of the unit cell, then for each atom at \((x_n,y_n,z_n)\), there must be the same atom at \((-x_n,-y_n,-z_n)\). Therefore, when calculating the structure factor, instead of summing over all \(N\) atoms in the unit cell, we can sum over the \(N/2\) pairs:
    \begin{align}
        F(hkl)&=\sum_{n=1}^{N/2}f_n\left[\exp[2\pi \ii(hx_n+ky_n+lz_n)]+\exp[-2\pi \ii(hx_n+ky_n+lz_n)]\right]\notag \\
        &=\sum_{n=1}^{N/2}2f_n\cos[2\pi (hx_n+ky_n+lz_n)]\,.\notag \\
        &=\sum_{n=1}^{N}f_n\cos[2\pi (hx_n+ky_n+lz_n)]\,.
    \end{align}
    Two immediate consequences are
    \begin{itemize}[topsep=0pt]
        \item The structure factor is always real (phase is \(0\) or \(\pi\)).
        \item \(F(hkl)=F(\bar{h}\bar{k}\bar{l})\).
    \end{itemize}
    Therefore, the structure factor also shows an inversion symmetry, with point group symmetry (at least) \(C_i\).

    However, this is not something we can really exploit. This is because we can only measure \(I(hkl)=\abs{F(hkl)}^2\), or equivalently the modulus of the structure factor.
    \begin{thm}[Friedel's law]
        For any crystal,
        \begin{equation}
            \abs{F(hkl)}=\abs{F(\bar{h}\bar{k}\bar{l})}\,.
        \end{equation}
    \end{thm}
    \begin{proof}
        This is because
        \begin{align}
            F(\bar{h}\bar{k}\bar{l})&=\sum_n f_n \exp[-2\pi \ii(hx_n+ky_n+lz_n)]\notag\\
            &=\left[\sum_n f_n\exp[2\pi \ii(hx_n+ky_n+lz_n)]\right]^*\notag\\
            &=F(hkl)^*\,.
        \end{align}
        They are complex conjugate, so they have the same modulus and diffraction intensity.\qed
    \end{proof}
    Therefore, the diffraction intensities of all crystals exhibit centres of inversion.

    In practice, when describing a diffraction pattern, we often picture a reciprocal lattice with its lattice points scaled by the intensity of diffraction. This construction is called the \textit{intensity-weighted reciprocal lattice}. The intensity-weighted reciprocal lattices of all crystals show a \(C_i\) point symmetry.

    \subsubsection*{Aside: Intensity Statistics}
    However, it is possible to infer the presence of an inversion centre from the diffraction pattern based on the intensities. If a centre of symmetry is not present, then generally \(F(hkl)\) would be a complex number, while if there is a centre of symmetry present, \(F(hkl)\) can only be a real number. A real \(F(hkl)\) has a higher probability to have a modulus close to zero than a complex one, and so we have a higher chance to observe weak \(F(hkl)\) values if an inversion centre is present.

    The above argument sounds a bit dubious. We can formalise it a little bit. Suppose the \(f_n\) values in a crystal follow some distribution with mean \(\mu\) and variance \(\sigma^2\), and the phase of each atom \(\phi_n\) is somehow random (uniformly distributed) between 0 and \(2\pi\).
    
    If there is a centre of inversion, then
    \begin{equation}
        F=\sum_n f_n\cos\phi_n\,.
    \end{equation}
    \(\cos\phi_n\) has a mean \(0\) and variance \(\frac{1}{2}\). By central limit theorem, if \(N\) is large, then \(F\) is a Gaussian with expectation value of
    \begin{equation}
        \mathbb{E}[F]=N \mathbb{E}[f_n\cos\phi_n]=N\mathbb{E}[f_n]\mathbb{E}[\cos\phi_n]=0
    \end{equation}
    and variance
    \begin{align}
        \Var[F]&=N\Var[f_n\cos\phi_n]\notag \\
        &=N\left[(\Var[f_n]+\mathbb{E}[f_n]^2)(\Var[\cos\phi_n]+\mathbb{E}[\cos\phi_n]^2)-\mathbb{E}[f_n]^2\mathbb{E}[\cos\phi_n]^2\right]\notag\\
        &=\frac{N}{2}(\sigma^2+\mu^2)\,.
    \end{align}
    Let's denote this variance \(\sigma_F^2\), then for the centrosymmetric case, the probability distribution function of \(\abs{F}\) is
    \begin{equation}
        g(x)=\frac{2}{\sigma_F\sqrt{2\pi}}\exp\left[-\frac{x^2}{2\sigma_F^2}\right]\,, \qquad x\ge 0\,.
    \end{equation}

    If there is not a symmetry of inversion, however, then
    \begin{equation}
        F=\sum_n f_n(\cos\phi_n+\ii\sin\phi_n)\,.
    \end{equation}
    The real and imaginary part of \(F\) then follows the same Gaussian distribution as the centrosymmetric case, with mean \(0\) and variance \(\sigma_F^2\). However, this is a 2D Gaussian. The probability density function of \(\abs{F}\) is then
    \begin{align}
        h(x)&=\int_{0}^{2\pi}\dd{\theta}x\frac{1}{2\pi \sigma_F^2}\exp\left[-\frac{x^2}{2\sigma_F^2}\right]\notag\\
        &=\frac{x}{\sigma_F^2}\exp\left[-\frac{x^2}{2\sigma_F^2}\right]\,.
    \end{align}
    Its probability density at 0 vanishes.

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (0,0)--(5,0)node[below]{\(\abs{F}\)};
            \draw[->] (0,0)--(0,3)node[left]{distribution};
            \draw[thick,domain=0:5, smooth, variable=\x,samples=50,red] plot ({\x}, {3*0.798*2.72^(-\x*\x/2)});
            \draw[thick,domain=0:5, smooth, variable=\x,samples=50,blue] plot ({\x}, {3*\x*2.72^(-\x*\x/2)});
            \node[red] at (0.3,2.7)[right]{centrosymmetric};
            \node[blue] at (1.5,1.5)[right]{non-centrosymmetric};
        \end{tikzpicture}
    \end{figure}

    \subsubsection{Mirror Plane}
    Consider a mirror plane perpendicular to the \(\vb{b}\) axis passing through the origin. This relates an atom at \((x,y,z)\) to another at \((x,-y,z)\). The structure factor can be simplified to
    \begin{align}
        F(hkl)&=\sum_{n=1}^{N/2}f_n[\exp[2\pi \ii(hx_n+ky_n+lz_n)]+\exp[2\pi \ii(hx_n-ky_n+lz_n)]]\notag \\
        &=\sum_{n=1}^{N}f_n\cos(2\pi ky_n)\exp[2\pi \ii(hx_n+lz_n)]\,.
    \end{align}
    Cosine is an even function, so
    \begin{equation}
        F(hkl)=F(h\bar{k}l)\,,
    \end{equation}
    and \(\abs{F(hkl)}^2=\abs{F(h\bar{k}l)}^2\). Therefore intensity-weighted reciprocal lattice will also have a mirror plane perpendicular to the \(\vb{b}^*\) axis. Combined with the \(i\) symmetry of Friedel pairs, we have
    \begin{equation}
        \abs{F(hkl)}^2=\abs{F(h\bar{k}l)}^2=\abs{F(\bar{h}k\bar{l})}^2=\abs{F(\bar{h}\bar{k}\bar{l})}^2\,,
    \end{equation}
    and so the intensity-weighted reciprocal lattice will have a \(C_{2h}\) symmetry. Note that \(i\) and \(\sigma_h\) generate the \(C_2\) symmetry.

    \begin{figure}
        \centering
        \begin{tikzpicture}[x={(1cm,0cm)},y={(0cm,1cm)},z={(-0.2cm,-0.32cm)}]
            \pgfmathsetseed{12345}
            \foreach \i in {-2,...,2}{
                \foreach \j in {-2,...,2}{
                    \draw[gray!50] (\i,-2,\j)--(\i,2,\j);
                }
                \foreach \j in {-1,0,1}{
                    \draw[gray!50] (\i,2*\j,-2)--(\i,2*\j,2);
                    \draw[gray!50] (-2,2*\j,\i)--(2,2*\j,\i);
                }
            }
            \foreach \i in {0,...,2}{
                \foreach \j in {0,1}{
                    \foreach \k in {-2,...,2}{
                        \tikzmath{\x = rand*0.04+0.06;}
                        \draw[fill=black] (\i,2*\j,\k) circle (\x);
                        \draw[fill=black] (\i,-2*\j,\k) circle (\x);
                        \draw[fill=black] (-\i,2*\j,-\k) circle (\x);
                        \draw[fill=black] (-\i,-2*\j,-\k) circle (\x);
                    }
                }
            }
            \draw[very thick,->] (-3,0,0)--(3,0,0)node[right]{\(a^*\)};
            \draw[very thick,->] (0,-3,0)--(0,3,0)node[above]{\(b^*\)};
            \draw[very thick,->] (0,0,-3)--(0,0,3)node[left]{\(c^*\)};
        \end{tikzpicture}
        \caption{An intensity-weighted reciprocal lattice with \(C_{2h}\) symmetry.}
    \end{figure}

    \subsubsection{Rotation Axes}
    Now let's consider the effect of a rotation axis. A \(m\)-fold rotation axis will rotate atoms by \(2\pi/m\) radians around the defined axis. For simplicity, we will only consider the 2-fold axis. We set the axis such that the rotation axis passes through the origin and is parallel to the \(\vb{b}\) axis of the unit cell, so that for each atom at \((x_n,y_n,z_n)\), there is also a same atom at \((-x,y,-z)\). In this case, we may simplify the structure factor to
    \begin{align}
        F(hkl)&=\sum_{n}^{N/2}f_n[\exp[2\pi \ii(hx_n+ky_n+lz_n)]+\exp[2\pi \ii(-hx_n+ky_n-lz_n)]]\notag \\
        &=\sum_{n}^{N}f_n\cos[2\pi(hx_n+lz_n)]\exp[2\pi \ii ky_n]\,.
    \end{align}
    Therefore,
    \begin{equation}
        F(hkl)=F(\bar{h}k\bar{l})\,.
    \end{equation}
    The intensity-weighted reciprocal lattice therefore also has a 2-fold rotation axis along \(\vb{b}^*\). Again, the Friedel's law still applies, so
    \begin{equation}
        \abs{F(hkl)}^2=\abs{F(h\bar{k}l)}^2=\abs{F(\bar{h}k\bar{l})}^2=\abs{F(\bar{h}\bar{k}\bar{l})}^2\,.
    \end{equation}
    Therefore the intensity-weighted reciprocal lattice has a \(C_{2h}\) point group symmetry (formally known as the \textit{Laue group}), as \(i\) and \(C_2\) further generates a \(\sigma_h\) symmetry.

    Finally, note that if a crystal structure exhibits a 2-fold rotation axis along one direction, or a mirror plane perpendicular to some direction, this axis must be perpendicular to two of the lattice vectors, otherwise the rotated cell will have a different orientation, and the translational symmetry will be broken. For example, if a 2-fold axis is parallel to \(\vb{b}\), then \(\vb{b}\) must be perpendicular to both \(\vb{a}\) and \(\vb{c}\). This means that the structure is at least \textit{monoclinic}, meaning that two of the unit-cell angles must be \(90^\circ\). By convention, we usually choose \(\alpha=\gamma=90^\circ\) and \(\beta\ne 90^\circ\) (although it could be that \(\beta=90^\circ\), but then we will classify the crystal to have a higher symmetry e.g. \textit{orthorhombic}).

    \subsubsection{Screw Axes}
    The fact that crystals are infinitely extended through the space leads us to some extra symmetry elements that are not present in point groups. Specifically, we can combine rotations or reflections with translations.

    A \(n_m\)-screw axis stands for a rotation of \(2\pi/n\) around the axis, and then a translation of \(m/n\) times the length of the lattice vector in that direction. We will only consider the 2-fold screw axis \(2_1\), and we will make the axis coincide with the \(\vb{b}\) vector. This is a rotation of \(180^\circ\) along \(\vb{b}\), and then translate by \(\vb{b}/2\), relating \((x,y,z)\) to \((-x,\frac{1}{2}+y,-z)\). The resulting structure factor is
    \begin{align}
        F(hkl)&=\sum_{n=1}^{N/2}f_n\exp(2\pi \ii ky_n)[\exp[2\pi \ii(hx_n+lz_n)]+(-1)^k\exp[-2\pi \ii(hx_n+lz_n)]]\notag \\
        &=\sum_{n=1}^{N}f_n\exp(2\pi \ii ky_n)\times\begin{cases}
            \cos[2\pi(hx_n+lz_n)] & \text{if \(k\) is even} \\
            \ii\sin[2\pi(hx_n+lz_n)] & \text{if \(k\) is odd.}
        \end{cases}
    \end{align}
    Consequently,
    \begin{equation}
        F(hkl)=\begin{cases}
            F(\bar{h}k\bar{l}) & \text{if \(k\) is even} \\
            -F(\bar{h}k\bar{l}) & \text{if \(k\) is odd,}
        \end{cases}
    \end{equation}
    but in either case,
    \begin{equation}
        \abs{F(hkl)}^2=\abs{F(\bar{h}k\bar{l})}^2\,.
    \end{equation}
    Combining with the Friedel pair relationship, we see that the \(2_1\) screw axis has exactly the same effect on the symmetry of the diffracted intensity as the 2-fold rotation axis, both having \(C_{2h}\).

    Moreover, if we consider the special case of \(h=l=0\), then the structure factor for \(0k0\) reduces to
    \begin{equation}
        F(0k0)=\sum_{n}^{N/2}f_n\exp(2\pi \ii ky_n)[1+(-1)^k]=\begin{cases}
            \sum_{n}^{N}f_n\exp(2\pi \ii ky_n) & \text{if \(k\) is even} \\
            0 & \text{if \(k\) is odd.}
        \end{cases}
    \end{equation}
    The structure factors for all \(0k0\) beams are zero if \(k\) is odd --- this result is independent of the atomic coordinates and is purely originates from symmetry. This is known as a \textit{systematic absence}. The pattern of the systematic absence depends on the direction of the screw axis:
    \begin{itemize}[topsep=0pt]
        \item \(2_1\) axis parallel to \(\vb{a}\): \((h00)\) absent for odd \(h\).
        \item \(2_1\) axis parallel to \(\vb{b}\): \((0k0)\) absent for odd \(k\).
        \item \(2_1\) axis parallel to \(\vb{c}\): \((00l)\) absent for odd \(l\).
    \end{itemize}

    We have a good explanation for this. Consider a \(2_1\) axis along \(\vb{b}\). If we project the 3D crystal structure into one dimension along \(\vb{b}\), i.e. we ignore the \(x\) and \(z\) coordinates, the presence of a \(2_1\) screw axis doubles the periodicity along \(\vb{b}\) direction, and hence the periodicity in the reciprocal lattice will be halved. This is exactly what a \(0k0\) beam is detecting: as reflections from a \((0k0)\) Bragg's plane has contributions from all \(x\) and \(z\) coordinates for a certain \(y\) value, it is only able to tell the periodicity along \(y\) direction, and it finds that things are repeating twice as often.

    \subsubsection{Glide Planes}
    A glide plane is a mirror plane reflection followed by a translation one half of the lattice. We will consider a \(c\)-glide perpendicular to \(b\), which is a reflection about a mirror plane perpendicular to \(b\) followed by a translation of \(\frac{1}{2}\vb{c}\), relating atoms at \((x,y,z)\) and \((x,-y,\frac{1}{2}+z)\). The structure factor equation becomes
    \begin{align}
        F(hkl)&=\sum_{n}^{N/2}f_n\exp[2\pi \ii(hx_n+lz_n)][\exp(2\pi \ii ky_n)+(-1)^l\exp(-2\pi \ii ky_n)]\notag \\
        &=\sum^{N}f_n\exp[2\pi \ii(hx_n+lz_n)]\times\begin{cases}
            \cos(2\pi ky_n) & \text{if \(l\) is even} \\
            \ii\sin(2\pi ky_n) & \text{if \(l\) is odd.}
        \end{cases}
    \end{align}
    This means that
    \begin{equation}
        F(hkl)=\begin{cases}
            F(h\bar{k}l) & \text{if \(l\) is even} \\
            -F(h\bar{k}l) & \text{if \(l\) is odd,}
        \end{cases}
    \end{equation}
    but in either case,
    \begin{equation}
        \abs{F(hkl)}^2=\abs{F(h\bar{k}l)}^2\,.
    \end{equation}
    The glide plane produces a mirror plane in the diffraction pattern, just as a normal mirror plane would do, and combining with Friedel pair relation, the diffraction pattern again has a \(C_{2h}\) symmetry.

    Consider \(k=0\), the structure factor reduces to
    \begin{equation}
        F(h0l)=\begin{cases}
            \sum_{n}^{N}f_n\exp[2\pi \ii(hx_n+lz_n)] & \text{if \(l\) is even} \\
            0 & \text{if \(l\) is odd.}
        \end{cases}
    \end{equation}
    Therefore, a \(c\)-glide perpendicular to \(b\) produces systematic absences of \(F(h0l)\) for odd \(l\). We again have a good explanation for it: we set \(k\) to 0 so the beam is ignorant of us changing the \(y\) coordinate by reflection, and now the translation of \(\frac{1}{2}\vb{c}\) doubles the periodicity along the \(c\) direction, so the reciprocal lattice is doubled in length in that direction.
    
    To conclude the systematic absence for glide planes: \\
    \textit{Glide plane perpendicular to \(a\)}:
    \begin{itemize}[topsep=0pt]
        \item \(b\)-glide: \((0kl)\) absent if \(k\) odd.
        \item \(c\)-glide: \((0kl)\) absent if \(l\) odd.
        \item \(n\)-glide: \((0kl)\) absent if \(k+l\) odd. (\(n\)-glide means translation by a half in both \(y\) and \(z\) directions)
    \end{itemize}
    \textit{Glide plane perpendicular to \(b\)}:
    \begin{itemize}[topsep=0pt]
        \item \(a\)-glide: \((h0l)\) absent if \(h\) odd.
        \item \(c\)-glide: \((h0l)\) absent if \(l\) odd.
        \item \(n\)-glide: \((h0l)\) absent if \(h+l\) odd.
    \end{itemize}
    \textit{Glide plane perpendicular to \(c\)}:
    \begin{itemize}[topsep=0pt]
        \item \(a\)-glide: \((hk0)\) absent if \(h\) odd.
        \item \(b\)-glide: \((hk0)\) absent if \(k\) odd.
        \item \(n\)-glide: \((hk0)\) absent if \(h+k\) odd.
    \end{itemize}

    \begin{figure}
        \centering
        \begin{tikzpicture}
            \pgfmathsetseed{88888}
            \foreach \i in {-8,...,8}{
                \draw[thin,color=red!20] (-2.7-0.05*\i,0.3*\i)--(2.7-0.05*\i,0.3*\i);
                \draw[thin,color=red!20] (0.3*\i-0.45,2.7)--(0.3*\i+0.45,-2.7);
            }
            \foreach \i in {-8,...,8}{
                \foreach \j in {1,...,8}{
                    \tikzmath{\x = rand*0.02+0.03;
                    \y = rand*0.02+0.025;}
                    \draw[fill=black] (0.3*\i-0.05*\j,0.3*\j) circle (\x);
                    \draw[fill=black] (-0.3*\i+0.05*\j,-0.3*\j) circle (\x);
                    \draw[fill=black] (0.3*\j,0) circle (\y);
                    \draw[fill=black] (-0.3*\j,0) circle (\y);
                }
            }
            \foreach \i in {-3,...,3}{
                \foreach \j in {1,...,3}{
                    \tikzmath{\x = rand*0.04+0.05;
                    \y = rand*0.04+0.05;}
                    \draw[fill=black] (0.3*\i-0.05*\j,0.3*\j) circle (\x);
                    \draw[fill=black] (-0.3*\i+0.05*\j,-0.3*\j) circle (\x);
                    \draw[fill=black] (0.3*\j,0) circle (\y);
                    \draw[fill=black] (-0.3*\j,0) circle (\y);
                }
            }
            \foreach \i in {-5,...,5}{
                \foreach \j in {1,...,5}{
                    \tikzmath{\x = rand*0.03+0.04;
                    \y = rand*0.03+0.04;}
                    \draw[fill=black] (0.3*\i-0.05*\j,0.3*\j) circle (\x);
                    \draw[fill=black] (-0.3*\i+0.05*\j,-0.3*\j) circle (\x);
                    \draw[fill=black] (0.3*\j,0) circle (\y);
                    \draw[fill=black] (-0.3*\j,0) circle (\y);
                }
            }
            \draw[red] (-2.7,0)--(2.7,0)node[right,black]{\(a^*\)};
            \draw[red] (-0.45,2.7)--(0.45,-2.7)node[below,black]{\(c^*\)};
            \node at (0,-3.7) {(a) mirror plane perpendicular to \(b\).};

            \begin{scope}[shift={(8,0)}]
                \foreach \i in {-8,...,8}{
                    \draw[thin,color=red!20] (-2.7-0.05*\i,0.3*\i)--(2.7-0.05*\i,0.3*\i);
                    \draw[thin,color=red!20] (0.3*\i-0.45,2.7)--(0.3*\i+0.45,-2.7);
                }
                \foreach \i in {-8,...,8}{
                    \foreach \j in {1,...,4}{
                        \tikzmath{\x = rand*0.02+0.03;}
                        \draw[fill=black] (0.3*\i-0.1*\j,0.6*\j) circle (\x);
                        \draw[fill=black] (-0.3*\i+0.1*\j,-0.6*\j) circle (\x);
                    }
                }
                \foreach \i in {1,...,8}{
                    \tikzmath{\x = rand*0.02+0.03;}
                    \draw[fill=black] (0.3*\i,0) circle (\x);
                    \draw[fill=black] (-0.3*\i,0) circle (\x);
                }
                \foreach \i in {-3,...,3}{
                    \tikzmath{\x = rand*0.04+0.05;}
                    \draw[fill=black] (0.3*\i-0.1,0.6) circle (\x);
                    \draw[fill=black] (-0.3*\i+0.1,-0.6) circle (\x);
                }
                \foreach \i in {1,...,3}{
                    \tikzmath{\x = rand*0.04+0.05;}
                    \draw[fill=black] (0.3*\i,0) circle (\x);
                    \draw[fill=black] (-0.3*\i,0) circle (\x);
                }
                \foreach \i in {-5,...,5}{
                    \foreach \j in {2,4}{
                        \tikzmath{\x = rand*0.03+0.04;}
                        \draw[fill=black] (0.3*\i-0.05*\j,0.3*\j) circle (\x);
                        \draw[fill=black] (-0.3*\i+0.05*\j,-0.3*\j) circle (\x);
                    }
                }
                \foreach \i in {1,...,5}{
                    \tikzmath{\x = rand*0.03+0.04;}
                    \draw[fill=black] (0.3*\i,0) circle (\x);
                    \draw[fill=black] (-0.3*\i,0) circle (\x);
                }
                \draw[red] (-2.7,0)--(2.7,0)node[right,black]{\(a^*\)};
                \draw[red] (-0.45,2.7)--(0.45,-2.7)node[below,black]{\(c^*\)};
                \node at (0,-3.7) {(b) \(c\)-glide perpendicular to \(b\).};
            \end{scope}
        \end{tikzpicture}
        \caption{Schematic \((h0l)\) slices of the intensity-weighted reciprocal lattice. We see that glide planes create systematic absences, while mirror planes do not.}
    \end{figure}

    \subsection{Lattice Types}
    In some cases, it is more preferable to define a unit cell that is not primitive, i.e. containing more than one lattice point. This is possibly because the non-primitive unit cell has a higher symmetry, or it allows the symmetry elements to align with the axes of the unit cell.

    There are in total four types of 3D unit cells. The first type is \textit{primitive}, denoted \(P\), where the lattice points are at the corners of the cells only, so that there is only one lattice point in the unit cell. It is also possible for a cell to also contain lattice points in the centre of two opposite faces. This is conventionally chosen to be the \(ab\) face, so this type of cell is known as \textit{\(C\)-centred}. Another possibility is to contain a second lattice point at the centre of the cell, and this is known as \textit{body-centred} or \textit{\(I\)-centred}. Finally, we can have lattice points at the centres of all unit-cell faces, which is known as \textit{face-centred} or \textit{\(F\)-centred}.

    \begin{figure}
        \centering
        \begin{tikzpicture}
            \draw[->,thick] (0,0,0)--(0,0,2)node[below]{\small \(a\)};
            \draw[->,thick] (0,0,0)--(0,2.5,0)node[left]{\small \(c\)};
            \draw[->,thick] (0,0,0)--(2,0,0)node[below]{\small \(b\)};
            \foreach \i in {0,1.5}{
                \draw (0,0,\i) rectangle (1.5,2,\i);
                \foreach \j in {0,2}{
                    \draw (\i,\j,0) -- (\i,\j,1.5);
                }
            }
            \foreach \i in {0,1.5}{
                \foreach \j in {0,2}{
                    \foreach \k in {0,1.5}{
                        \draw[red,fill=red] (\i,\j,\k) circle (0.05);
                    }
                }
            }
            \node at (0.65,-1.5) {\(P\)};

            \begin{scope}[shift={(4,0)}]
                \draw[->,thick] (0,0,0)--(0,0,2)node[below]{\small \(a\)};
                \draw[->,thick] (0,0,0)--(0,2.5,0)node[left]{\small \(c\)};
                \draw[->,thick] (0,0,0)--(2,0,0)node[below]{\small \(b\)};
                \foreach \i in {0,1.5}{
                    \draw (0,0,\i) rectangle (1.5,2,\i);
                    \foreach \j in {0,2}{
                        \draw (\i,\j,0) -- (\i,\j,1.5);
                    }
                }
                \foreach \i in {0,1.5}{
                    \foreach \j in {0,2}{
                        \foreach \k in {0,1.5}{
                            \draw[red,fill=red] (\i,\j,\k) circle (0.05);
                        }
                        \draw[red,fill=red] (0.75,\j,0.75) circle (0.05);
                    }
                }
                \node at (0.65,-1.5) {\(C\)};
            \end{scope}

            \begin{scope}[shift={(8,0)}]
                \draw[->,thick] (0,0,0)--(0,0,2)node[below]{\small \(a\)};
                \draw[->,thick] (0,0,0)--(0,2.5,0)node[left]{\small \(c\)};
                \draw[->,thick] (0,0,0)--(2,0,0)node[below]{\small \(b\)};
                \foreach \i in {0,1.5}{
                    \draw (0,0,\i) rectangle (1.5,2,\i);
                    \foreach \j in {0,2}{
                        \draw (\i,\j,0) -- (\i,\j,1.5);
                    }
                }
                \foreach \i in {0,1.5}{
                    \foreach \j in {0,2}{
                        \foreach \k in {0,1.5}{
                            \draw[red,fill=red] (\i,\j,\k) circle (0.05);
                        }
                    }
                }
                \draw[red,fill=red] (0.75,1,0.75) circle (0.05);
                \node at (0.65,-1.5) {\(I\)};
            \end{scope}

            \begin{scope}[shift={(12,0)}]
                \draw[->,thick] (0,0,0)--(0,0,2)node[below]{\small \(a\)};
                \draw[->,thick] (0,0,0)--(0,2.5,0)node[left]{\small \(c\)};
                \draw[->,thick] (0,0,0)--(2,0,0)node[below]{\small \(b\)};
                \foreach \i in {0,1.5}{
                    \draw (0,0,\i) rectangle (1.5,2,\i);
                    \foreach \j in {0,2}{
                        \draw (\i,\j,0) -- (\i,\j,1.5);
                    }
                }
                \foreach \i in {0,1.5}{
                    \foreach \j in {0,2}{
                        \foreach \k in {0,1.5}{
                            \draw[red,fill=red] (\i,\j,\k) circle (0.05);
                        }
                        \draw[red,fill=red] (0.75,\j,0.75) circle (0.05);
                    }
                    \draw[red,fill=red] (\i,1,0.75) circle (0.05);
                    \draw[red,fill=red] (0.75,1,\i) circle (0.05);
                }
                \node at (0.65,-1.5) {\(F\)};
            \end{scope}
        \end{tikzpicture}
        \caption{Types of unit cell centring.}
    \end{figure}

    Since non-primitive unit cells contain more than one lattice points, they also have systematic absences, which can be worked out using the same way as we did before.
    \begin{itemize}[topsep=0pt]
        \item \(P\): No systematic absences.
        \item \(C\): \((hkl)\) absent if \(h+k=2n+1\).
        \item \(I\): \((hkl)\) absent if \(h+k+l=2n+1\).
        \item \(F\): \((hkl)\) absent unless \(h,k,l\) are all odd or all even.
    \end{itemize}
    Heuristically, the reciprocal lattice of a \(P\) and a \(C\) lattices are themselves, the reciprocal lattice of an \(I\) lattice is a larger \(F\) lattice, and the reciprocal lattice of an \(F\) lattice is a larger \(I\) lattice.

    By using a non-primitive cell, we are choosing to describe the real lattice with longer lattice vectors, so the reciprocal lattice vectors are correspondingly shorter. We are therefore using smaller reciprocal unit cells than a primitive reciprocal unit cell. Hence, systematic absences must arise.

    \subsection{Space Groups and Equivalent Positions}
    An identification of the lattice type together with a collection of symmetry operators defines a \textit{space group}. It describes the symmetry of a crystal, just as a point group describes the symmetry of a molecule, but we have an extra translational symmetry described by the lattice type.

    For example, let's consider the most common space group \(P2_1/c\), where its name stands for primitive lattice, a \(2_1\) screw axis \(\parallel b\) and a \(c\)-glide \(\perp b\). These symmetry elements also create a centre of inversion. By convention, we set the inversion centre to be the origin, so that the \(2_1\) axis is at \((0,y,1/4)\) and the \(c\)-glide is at \((x,1/4,z)\). This collection of symmetry operators produces a set of coordinates that are related to each other, known as the \textit{general equivalent positions} (GEPs). The GEPs for \(P2_1/c\) are shown in the figure below.

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \node[draw,minimum height=0.65cm,minimum width=2.3cm] (A) at (0,0){\(x,y,z\)};
            \node[draw,minimum height=0.65cm,minimum width=2.3cm] (B) at (6,0){\(-x,\frac{1}{2}+y,\frac{1}{2}-z\)};
            \node[draw,minimum height=0.65cm,minimum width=2.3cm] (C) at (0,-3.5){\(-x,-y,-z\)};
            \node[draw,minimum height=0.65cm,minimum width=2.3cm] (D) at (6,-3.5){\(x,\frac{1}{2}-y,\frac{1}{2}+z\)};
            \draw[<->] (A.east)--node[above,align=center]{\small \(2_1\) screw \\ at \((0,y,1/4)\)}(B.west);
            \draw[<->] (C.east)--node[below,align=center]{\small \(2_1\) screw \\ at \((0,y,1/4)\)}(D.west);
            \draw[<->] (A.south)--node[left,align=center]{\small inversion \\ at \((0,0,0)\)}(C.north);
            \draw[<->] (B.south)--node[right,align=center]{\small inversion \\ at \((0,0,0)\)}(D.north);
            \draw[<->] (A.south east)--(D.north west);
            \draw[<->] (C.north east)--node[fill=white,align=center]{\(c\)-glide \\ at \((x,1/4,z)\)}(B.south west);
        \end{tikzpicture}
        \caption{General equivalent positions in the \(P2_1/c\) space group.}
    \end{figure}

    Therefore, there exists a minimal set of atomic coordinates that need to be specified to describe the whole unit cell (and hence the entire crystal structure), which is known as the \textit{asymmetric unit}. The coordinates of the other atoms in the cell can be obtained by applying the symmetry elements in the space group.

    However, notice that there are some special coordinates in the \(P2_1/c\) group that do not produce a group of four distinct coordinates when the symmetry operators are applied. An example is \((0,0,0)\), for which you will only obtain two distinct coordinates \((0,0,0)\) and \((0,1/2,1/2)\) when applying the symmetry elements. Such positions are called the \textit{special equivalent positions}. They arise because the coordinates coincide with the point group elements (centre of symmetry in this case), so it is not moved by those symmetry elements. Similarly, if a rotation axis or a mirror plane is present in some space group, there will be a whole line and a whole plane of special equivalent positions, respectively.

    \begin{figure}
        \centering
        \begin{tikzpicture}[scale=0.95]
            \draw[x={(6cm,0cm)},y={(-1.5cm,-5cm)}] (0,0)--(1,0)--(1,1)--(0,1)--(0,0);
            \draw[x={(6cm,0cm)},y={(-1.5cm,-5cm)},thick,->] (1.03,0)--(1.2,0) node[below]{\(x\)};
            \draw[x={(6cm,0cm)},y={(-1.5cm,-5cm)},thick,->] (0,1.03)--(0,1.2) node[left]{\(z\)};
            \foreach \i in {0,1}{
                \foreach \j in {0,1,2}{
                    \pic at (-0.375+3*\j-0.75*\i,-1.25-2.5*\i) {screw};
                }
            }
            \foreach \i in {0,1,2}{
                \foreach \j in {0,1,2}{
                    \draw[cyan,fill=cyan] (3*\i-0.75*\j,-2.5*\j) circle (0.05);
                }
            }
            \node[cyan] at (3,0)[above]{\(z=0,\frac{1}{2}\)};
            \draw[violet] (0.45,-0.5)node[below=0.22 cm]{\footnotesize\((x,y,z)\)} circle (0.2);
            \draw[blue] (-0.45,0.5)node[above=0.22 cm]{\footnotesize\((-x,-y,-z)\)} circle (0.2);
            \draw[red] (-1.2,-2)node[left=0.22 cm]{\footnotesize\((-x,\frac{1}{2}+y,\frac{1}{2}-z)\)} circle (0.2);
            \draw[purple] (-0.3,-3)node[right=0.22 cm]{\footnotesize\((x,\frac{1}{2}-y,\frac{1}{2}+z)\)} circle (0.2);
            \foreach \i in {0,1}{
                \foreach \j in {0,1}{
                    \draw[violet] (0.45+6*\i-1.5*\j,-0.5-5*\j) circle (0.2);
                    \draw[blue] (-0.45+6*\i-1.5*\j,0.5-5*\j) circle (0.2);
                }
            }
            \draw[red] (4.8,-2) circle (0.2);
            \draw[purple] (5.7,-3) circle (0.2);
        \end{tikzpicture}
        \begin{tikzpicture}[scale=0.95]
            \draw (0,0) rectangle (6,5);
            \draw[thick,->] (6.18,0)--(7.2,0)node[above]{\(z\)};
            \draw[thick,->] (0,5.15)--(0,6)node[left]{\(y\)};
            \draw[thick,dashed,orange,arrows = {->[harpoon,scale=1.5]}] (-1,1.25)--(7,1.25)node[right]{\(\frac{1}{2}\)};
            \draw[thick,dashed,orange,arrows = {->[harpoon,scale=1.5]}] (-1,3.75)--(7,3.75)node[right]{\(\frac{1}{2}\)};
            \draw[dashed,thick] (1.5,-1)--(1.5,6)node[above]{\(2_1\)};
            \foreach \i in {0,1,2}{
                \foreach \j in {0,1,2}{
                    \draw[cyan,fill=cyan] (3*\i,2.5*\j) circle (0.05);
                }
            }
            \draw[dashed,thick] (4.5,-1)node[below]{\(x=0,\frac{1}{2}\)}--(4.5,6)node[above]{\(2_1\)};
            \draw[blue] (-0.6,-0.5)node[below=0.22 cm]{\footnotesize\((-x,-y,-z)\)} circle (0.2);
            \draw[violet] (0.6,0.5)node[above=0.22 cm]{\footnotesize\((x,y,z)\)} circle (0.2);
            \draw[red] (2.4,3)node[above=0.22 cm]{\footnotesize\((-x,\frac{1}{2}+y,\frac{1}{2}-z)\)} circle (0.2);
            \draw[purple] (3.6,2)node[below=0.22 cm]{\footnotesize\((-x,\frac{1}{2}-y,\frac{1}{2}+z)\)} circle (0.2);
            \foreach \i in {0,1}{
                \foreach \j in {0,1}{
                    \draw[blue] (-0.6+6*\i,-0.5+5*\j) circle (0.2);
                    \draw[violet] (0.6+6*\i,0.5+5*\j) circle (0.2);
                }
            }
        \end{tikzpicture}
        \caption{View of \(P2_1/c\) space group unit cell along \(y\) axis and \(x\) axis. Note that extra symmetry elements arise automatically such that they appear twice as often as the lattice points.}
    \end{figure}

    \subsection{Determining Space Group}
    Having obtained a diffraction pattern from the experiment, we should be able to easily determine the space group. First, by observing the reciprocal cell geometry, we should be able to infer the lattice vectors \(a\), \(b\), \(c\) and their angles \(\alpha\), \(\beta\) and \(\gamma\). Then by observing the general \((hkl)\) systematic absences, we can infer the lattice type (\(P\), \(I\), \(F\) or \(C\)). This will give us one of the 14 possible types of 3D lattice, known as the \textit{Bravais lattices}.

    \begin{table}[ht!]
        \centering
        \caption{The 14 Bravais lattices.}
        \begin{tabular}{ccccc}
            \toprule
            Crystal system & \(P\) & \(I\) & \(F\) & \(C\) \\ \midrule
            \makecell{\(\) \\ Cubic \\ \(a=b=c\) \\
            \(\alpha=\beta=\gamma=90^\circ\) \\ \(\)} & \raisebox{-0.42\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (\i,\j,\k) circle (0.05);
                        }
                        \draw (\i,\j,0)--(\i,\j,1);
                    }
                    \draw (0,0,\i) rectangle (1,1,\i);
                }
            \end{tikzpicture}} & \raisebox{-0.42\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (\i,\j,\k) circle (0.05);
                        }
                        \draw (\i,\j,0)--(\i,\j,1);
                    }
                    \draw (0,0,\i) rectangle (1,1,\i);
                }
                \draw[fill=black] (0.5,0.5,0.5) circle (0.05);
            \end{tikzpicture}} & \raisebox{-0.42\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (\i,\j,\k) circle (0.05);
                        }
                        \draw (\i,\j,0)--(\i,\j,1);
                    }
                    \draw (0,0,\i) rectangle (1,1,\i);
                    \draw[fill=black] (0.5,0.5,\i) circle (0.05);
                    \draw[fill=black] (0.5,\i,0.5) circle (0.05);
                    \draw[fill=black] (\i,0.5,0.5) circle (0.05);
                }
            \end{tikzpicture}} \\ \midrule
            \makecell{\(\) \\ Tetragonal \\
            \(a=b\ne c\) \\
            \(\alpha=\beta=\gamma=90^\circ\) \\ \(\)} & \raisebox{-0.45\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (\i,1.4*\j,\k) circle (0.05);
                        }
                        \draw (\i,1.4*\j,0)--(\i,1.4*\j,1);
                    }
                    \draw (0,0,\i) rectangle (1,1.4,\i);
                }
            \end{tikzpicture}} & \raisebox{-0.45\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (\i,1.4*\j,\k) circle (0.05);
                        }
                        \draw (\i,1.4*\j,0)--(\i,1.4*\j,1);
                    }
                    \draw (0,0,\i) rectangle (1,1.4,\i);
                }
                \draw[fill=black] (0.5,0.7,0.5) circle (0.05);
            \end{tikzpicture}} \\ \midrule
            \makecell{\(\) \\ Orthorhombic \\
            \(a\ne b\ne c\) \\
            \(\alpha=\beta=\gamma=90^\circ\) \\ \(\)} & \raisebox{-0.45\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (1.6*\i,1.4*\j,\k) circle (0.05);
                        }
                        \draw (1.6*\i,1.4*\j,0)--(1.6*\i,1.4*\j,1);
                    }
                    \draw (0,0,\i) rectangle (1.6,1.4,\i);
                }
            \end{tikzpicture}} & \raisebox{-0.45\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (1.6*\i,1.4*\j,\k) circle (0.05);
                        }
                        \draw (1.6*\i,1.4*\j,0)--(1.6*\i,1.4*\j,1);
                    }
                    \draw (0,0,\i) rectangle (1.6,1.4,\i);
                }
                \draw[fill=black] (0.8,0.7,0.5) circle (0.05);
            \end{tikzpicture}} & \raisebox{-0.45\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (1.6*\i,1.4*\j,\k) circle (0.05);
                        }
                        \draw (1.6*\i,1.4*\j,0)--(1.6*\i,1.4*\j,1);
                    }
                    \draw (0,0,\i) rectangle (1.6,1.4,\i);
                    \draw[fill=black] (0.8,0.7,\i) circle (0.05);
                    \draw[fill=black] (0.8,1.4*\i,0.5) circle (0.05);
                    \draw[fill=black] (1.6*\i,0.7,0.5) circle (0.05);
                }
            \end{tikzpicture}} & \raisebox{-0.45\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (1.6*\i,1.4*\j,\k) circle (0.05);
                        }
                        \draw (1.6*\i,1.4*\j,0)--(1.6*\i,1.4*\j,1);
                    }
                    \draw (0,0,\i) rectangle (1.6,1.4,\i);
                    \draw[fill=black] (0.8,1.4*\i,0.5) circle (0.05);
                }
            \end{tikzpicture}} \\ \midrule
            \makecell{\(\) \\ Hexagonal \\
            \(a=b\ne c\) \\
            \(\alpha=\beta=90^\circ\), \(\gamma=120^\circ\) \\ \(\)} & \raisebox{-0.45\totalheight}{\begin{tikzpicture}[z={(-0.833cm,-0.333cm)}]
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (\i,1.4*\j,\k) circle (0.05);
                        }
                        \draw (\i,1.4*\j,0)--(\i,1.4*\j,1);
                    }
                    \draw (0,0,\i) rectangle (1,1.4,\i);
                }
            \end{tikzpicture}} \\ \midrule
            \makecell{\(\) \\ Trigonal \\
            \(a=b=c\) \\
            \(\alpha=\beta=\gamma\ne 90^\circ\) \\ \(\)} & \raisebox{-0.45\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (\i+0.5*\j-0.5*\k,0.866*\j,0.866*\k) circle (0.05);
                            \draw (0.5*\j-0.5*\k,0.866*\j,0.866*\k)--(1+0.5*\j-0.5*\k,0.866*\j,0.866*\k);
                            \draw (\i-0.5*\k,0,0.866*\k)--(\i+0.5-0.5*\k,0.866,0.866*\k);
                            \draw (\i+0.5*\j,0.866*\j,0)--(\i+0.5*\j-0.5,0.866*\j,0.866);
                        }
                    }
                }
            \end{tikzpicture}} \\ \midrule
            \makecell{\(\) \\ Monoclinic \\
            \(a\ne b\ne c\) \\
            \(\alpha=\gamma=90^\circ\), \(\beta\ne 90^\circ\) \\ \(\)} & \raisebox{-0.45\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (\i+0.3*\j,1.3*\j,\k) circle (0.05);
                        }
                        \draw (\i+0.3*\j,1.3*\j,0)--(\i+0.3*\j,1.3*\j,1);
                        \draw (\i,0,\j)--(\i+0.3,1.3,\j);
                        \draw (0.3*\i,1.3*\i,\j)--(1+0.3*\i,1.3*\i,\j);
                    }
                }
            \end{tikzpicture}} & & & \raisebox{-0.45\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (\i+0.3*\j,1.3*\j,\k) circle (0.05);
                        }
                        \draw (\i+0.3*\j,1.3*\j,0)--(\i+0.3*\j,1.3*\j,1);
                        \draw (\i,0,\j)--(\i+0.3,1.3,\j);
                        \draw (0.3*\i,1.3*\i,\j)--(1+0.3*\i,1.3*\i,\j);
                    }
                    \draw[fill=black] (0.5+0.3*\i,1.3*\i,0.5) circle (0.05);
                }
            \end{tikzpicture}} \\ \midrule
            \makecell{\(\) \\ Triclinic \\
            \(a\ne b\ne c\) \\
            \(\alpha\ne \beta\ne \gamma\ne 90^\circ\) \\ \(\)} & \raisebox{-0.45\totalheight}{\begin{tikzpicture}
                \foreach \i in {0,1}{
                    \foreach \j in {0,1}{
                        \foreach \k in {0,1}{
                            \draw[fill=black] (\i+0.2*\j-0.4*\k,1.3*\j,0.9*\k) circle (0.05);
                            \draw (0.2*\j-0.4*\k,1.3*\j,0.9*\k)--(1+0.2*\j-0.4*\k,1.3*\j,0.9*\k);
                            \draw (\i-0.4*\k,0,0.9*\k)--(\i+0.2-0.4*\k,1.3,0.9*\k);
                            \draw (\i+0.2*\j,1.3*\j,0)--(\i+0.2*\j-0.4,1.3*\j,0.9);
                        }
                    }
                }
            \end{tikzpicture}} \\ \bottomrule
        \end{tabular}
    \end{table}

    Having determined the lattice type, we can then identify the symmetry elements in the crystal. If the intensity-weighted reciprocal lattice exhibits a \(C_{2h}\) symmetry, then there will be a \(C_2\) axis or a mirror plane in the structure. If there are other systematic absences, then there will be glide planes or screw axes. We can identify the presence of inversion centres from intensity statistics.

    In practice, this can be easily done using automated programs. However, for a genuine experiment, there will be measurement errors, or there might be ambiguity on whether a diffraction is too small or it is really absent. Hence, all of these assessment indicate probable space groups rather than a concrete assessment.

    \subsection{Symmetry in Patterson Functions}
    Symmetry also allows us to identify atomic coordinates directly from Patterson function. Suppose we have confirmed that a crystal has a space group \(P2_1/c\) from diffraction pattern, we then know that the crystal must have the same atom at the following general equivalent positions:
    \begin{align*}
        (a):&\ (x,y,z) & (b):&\ \textstyle (-x,\frac{1}{2}+y,\frac{1}{2}-z) & (c):&\ \textstyle (x,\frac{1}{2}-y,\frac{1}{2}+z) & (d):&\ (-x,-y,-z)\,.
    \end{align*}
    This results in 16 interatomic vectors in the Patterson function: four of them are self-vectors at the origin, and the remaining twelve are non-origin vectors. Since each \(A\to B\) vector will be accompanied by a \(A\leftarrow B\) in reverse, these will comprise six centrosymmetric pairs:
    \begin{enumerate}[topsep=0pt,label=(\roman*)]
        \item \((a)\leftrightarrow (b)\): \(\pm (2x,-\frac{1}{2},-\frac{1}{2}+2z)\),
        \item \((a)\leftrightarrow (c)\): \(\pm (0,-\frac{1}{2}+2y,-\frac{1}{2})\),
        \item \((a)\leftrightarrow (d)\): \(\pm (2x,2y,2z)\),
        \item \((b)\leftrightarrow (c)\): \(\pm (-2x,2y,-2z)\),
        \item \((b)\leftrightarrow (d)\): \(\pm (0,\frac{1}{2}+2y,\frac{1}{2})\),
        \item \((c)\leftrightarrow (d)\): \(\pm (2x,\frac{1}{2},\frac{1}{2}+2z)\).
    \end{enumerate}
    As the structure is periodic, there will be the same atom 1 unit away along any coordinate, so we can shift any coordinate by \(\pm 1\). Consequently, vector (i) is actually identical to (vi), and (ii) is identical to (v). Therefore, for the space group \(P2_1/c\), we actually have two pairs of doubly-weighted peaks at \(\pm (2x,\frac{1}{2},\frac{1}{2}+2z)\), \(\pm (0,\frac{1}{2}+2y,\frac{1}{2})\) and two pairs of singly-weighted peaks at \(\pm(2x,2y,2z)\) and \(\pm(-2x,2y,-2z)\). Those peaks in the Patterson functions are easy to locate because of their special forms (0 or \(\frac{1}{2}\) in some coordinates). By identifying the coordinates of these peaks in the Patterson function, we can directly work out the coordinates of these atoms.

    Note that since the Patterson function only gives distinct peaks for interatomic vectors between heavy atoms, this usually only allow us to work out the coordinates of the heavy atoms in the structure. However, this is usually a very important first step for a complete structure determination. Having known this initial information, we have three complementary methods to determine the coordinates of the rest of the atoms. They are the \textit{heavy atom method}, \textit{isomorphous replacement} and \textit{anomalous scattering}.

    \subsection{The Heavy Atom Method}
    Suppose of the \(N\) atoms in the unit cell, we know the coordinate of the \(M\) heavy atoms of them e.g. from Patterson function. We can split the structure factor into a contribution of heavy atoms and the contribution of the rest of the atoms.
    \begin{align}
        F(hkl)&=\sum_{n=1}^{N}f_n \exp[2\pi \ii(hx_n+ky_n+lz_n)]\notag\\
        &=\sum_{n\text{ heavy}}f_n \exp[2\pi \ii(hx_n+ky_n+lz_n)] + \sum_{n\text{ rest}}f_n \exp[2\pi \ii(hx_n+ky_n+lz_n)]\notag\\
        &=F_{\text{heavy}}(hkl)+F_{\text{rest}}(hkl)\,.
    \end{align}
    From experiment, we can only measure \(\abs{F(hkl)}\), not \(\Phi(hkl)\). But since we know the coordinate of the \(M\) heavy atoms, we can calculate
    \begin{equation}
        F_{\text{heavy}}=\sum_{n=1}^{M}f_n \exp[2\pi \ii(hx_n+ky_n+lz_n)]\,.
    \end{equation}
    In particular, we know both the amplitude and the phase of the heavy atom contribution. Since the diffracting power of an atom \(f_n\), is proportional to the number of electrons, which is in turn proportional to the atomic number, heavy atom contributions tend to dominate in \(F(hkl)\).
    \[\abs{F_{\text{heavy}}(hkl)}\stackrel{?}{\gg}\abs{F_{\text{rest}}(hkl)}\,.\]
    This allows us to argue that hopefully \(\Phi(hkl)\) is close to \(\Phi_{\text{heavy}}(hkl)\), so we can use it as an estimate of \(\Phi(hkl)\). This allows us to combine the measured \(\abs{F(hkl)}\) and calculated \(F_{\text{heavy}}(hkl)\) to get an estimate of the structure factor
    \begin{equation}
        F(hkl)=\abs{F(hkl)}\exp[\ii\Phi(hkl)]\stackrel{?}{\approx}\abs{F(hkl)}\exp[\ii\Phi_{\text{heavy}}(hkl)]\,.
    \end{equation}

    \begin{figure}
        \centering
        \begin{tikzpicture}
            \draw[->] (-1,0)--(4,0);
            \draw[->] (0,-1)--(0,4);
            \draw[thick,->] (0,0)--node[below right = -2pt]{\(F_{\text{heavy}}\)}(2.2,1.2);
            \draw[thick,->] (2.2,1.2)--node[right]{\(F_{\text{rest}}\)}(3,3.4);
            \draw[thick] (0,0)--node[left]{\(F\)}(3,3.4);
            \draw[blue] (0.6,0) arc (0:28.61:0.6);
            \draw[red] (1,0) arc (0:48.58:1);
        \end{tikzpicture}
        \caption{We can use \(\Phi_{\text{heavy}}\) (blue) to approximate \(\Phi\) (red).}
    \end{figure}

    Having obtained approximate \(F(hkl)\) values, we can perform the inverse Fourier transform to get an approximated electron density
    \begin{align}
        \rho(x,y,z)&=\mathcal{F}^{-1}[\abs{F(hkl)}\exp[\ii\Phi(hkl)]]\notag\\
        &\approx\mathcal{F}^{-1}[\abs{F(hkl)}\exp[\ii\Phi_{\text{heavy}}(hkl)]]\notag\\
        &=\frac{1}{V_{\text{cell}}}\sum_{h,k,l}\abs{F(hkl)}\exp[\ii\Phi_{\text{heavy}}(hkl)-2\pi\ii(hx+ky+lz)]\,.
    \end{align}

    This seems to be very crude so far, probably only slightly better than just guessing random \(\Phi\) values. However, we will usually find that we are getting sufficiently close to the true \(\rho\) such that we can identify some peaks other than those due to the heavy atoms. If this is the case, we know some extra coordinates of some atoms. We can include them in our set of ``heavy'' atoms when calculating \(\Phi_{\text{heavy}}\) --- this will generally mean a better approximation of the true phase. A further inverse transform will give us a better approximation to the true electron density from which, hopefully, more atomic positions can be deduced. The iteration process can be repeated until all of the atoms are found. At this stage \(\Phi_{\text{heavy}}\) will be \(\Phi\) exactly, and we have completely solved the structure.

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (-1,0)--(4,0);
            \draw[->] (0,-1)--(0,4);
            \draw[thick,->] (0,0)--node[below right = -2pt]{\(F_{\text{heavy}}\)}(2.7,2.1);
            \draw[thick,->] (2.7,2.1)--node[right]{\(F_{\text{rest}}\)}(3,3.4);
            \draw[thick] (0,0)--node[left]{\(F\)}(3,3.4);
            \draw[blue] (0.6,0) arc (0:37.87:0.6);
            \draw[red] (1,0) arc (0:48.58:1);
        \end{tikzpicture}
        \caption{A refined approximation of \(\Phi\) by including more atoms in the set of known `heavy' atoms.}
    \end{figure}

    \section{Phase Determining Methods}
    There are many occasions in which the heavy atom fails to work, for example because the heavy atoms are not `heavy' enough to dominate the diffraction. Here, we will introduce two phase determining methods that can determine the phase of the diffraction beam more rigorously once the positions of the heavy atoms are known. Both methods achieve this by changing the way that the known heavy atom interacts with the X-ray, either by changing the identity of the atom or changing the way it scatters the X-ray.

    \subsection{Isomorphous Replacement}
    If we know the identity and positions of some type of atom (labelled \(a\)) in the lattice, then we can write the structure factor as
    \begin{equation}
        F_{1}(hkl)=F_{\text{rest}}(hkl)+\sum_{i=1}^{n}f_a\exp[2\pi \ii(hx_i+ky_i+lz_i)]\,.
    \end{equation}
    Now suppose we can replace these atoms with another type of atom (labelled \(b\)) at exactly the same positions, and suppose such replacement does not change any other part of the cell (the size and shape of the lattice is not changing as well as the coordinate of other atoms). This is known as an \textit{isomorphous replacement}. Then the structure factor after such a replacement is
    \begin{equation}
        F_{2}(hkl)=F_{\text{rest}}(hkl)+\sum_{i=1}^{n}f_b\exp[2\pi \ii(hx_i+ky_i+lz_i)]\,.
    \end{equation}
    The difference of the two structure factors, before and after replacement, is
    \begin{equation}
        \delta F(hkl)=F_{2}(hkl)-F_{1}(hkl)=\sum_{i=1}^{n}(f_b-f_a)\exp[2\pi \ii(hx_i+ky_i+lz_i)]\,.
    \end{equation}
    This is something we can calculate, for both the magnitude and the phase angle, since we know the positions of these atoms. Then since we can measure the magnitude of the structure factor before and after replacement, \(\abs{F_1(hkl)}\) and \(\abs{F_2(hkl)}\), we can calculate the phase of \(F_1\) and \(F_2\).
    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}
            \draw[->] (-4,0)--(4,0);
            \draw[->] (0,-4)--(0,4);
            \draw (0,0) circle (1.5);
            \draw (0,0) circle (3.3);
            \draw[dashed] (260:4)--(80:4);
            \draw[->,thick,blue] (20:1.5)--node[right]{\small\(\delta F\)}++(80:2.3)node(a){};
            \draw[->,thick,red] (140:1.5)--node[left]{\small\(\delta F\)}++(80:2.3)node(b){};
            \draw[thick,blue] (0,0)--node[left]{\(F_2\)}(a.center);
            \draw[thick,red] (0,0)--node[right]{\(F_2\)}(b.center);
            \draw[->,thick,blue] (0,0)--node[below]{\small\(F_1\)}(20:1.5);
            \draw[->,thick,red] (0,0)--node[left]{\small\(F_1\)}(140:1.5);
            \draw[blue,thick] (0.4,0)arc(0:20:0.4);
            \draw[red,thick] (0.6,0)arc(0:140:0.6);
        \end{tikzpicture}
        \caption{There are two possible set of phase angles (blue and red) for a set of isomorphous replacement.}
        \label{Fig:isomorphous_replacement}
    \end{figure}

    However, as you can see in \cref{Fig:isomorphous_replacement}, a set of isomorphous replacement data give two possible values of phase angles. These two possible phase values are related by a reflection with respect to an axis of angle \(\Phi(\delta F)\) passing through the origin. To eliminate this ambiguity, we can try to do a second replacement. However, if we replace the same atoms, say \(a\) to \(c\), then the change in structure factor is given by
    \begin{equation}
        \delta F'=\sum_n (f_c-f_a)\sum_{i=1}^{n}\exp[2\pi \ii(hx_i+ky_i+lz_i)]\,.
    \end{equation}
    This is parallel to the first change in the structure factor \(\delta F\) --- it will just be either shorter or longer, so it just gives the same set of two possible \(\Phi\) values. To make progress, we have to perform isomorphous replacement for a different set of atoms, say \(d\) to \(e\). Then the change in the structure factor is
    \begin{equation}
        \delta F'=\sum_n (f_e-f_d)\sum_{j=1}^{m}\exp[2\pi \ii(hx_j+ky_j+lz_j)]\,.
    \end{equation}
    This will give a different set of \(\Phi\) values --- the common one is the true phase of the beam.

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}[scale=0.85]
            \draw[->] (-4,0)--(4,0);
            \draw[->] (0,-4)--(0,4);
            \draw[dashed] (260:4)--(80:4);
            \begin{scope}[scale=0.8]
                \draw (0,0) circle (1.5);
                \draw (0,0) circle (3.3);
                \draw (0,0) circle (4.5);
                \draw[->,thick,blue] (20:1.5)--++(80:2.3)node(a){};
                \draw[->,thick,red] (140:1.5)--++(80:2.3)node(b){};
                \draw[->,thick,blue] (20:1.5)--++(80:3.6)node(c){};
                \draw[->,thick,red] (140:1.5)--++(80:3.6)node(d){};
                \draw[thick,blue] (0,0)--(a.center);
                \draw[thick,red] (0,0)--(b.center);
                \draw[thick,blue] (0,0)--(c.center);
                \draw[thick,red] (0,0)--(d.center);
                \draw[->,thick,blue] (0,0)--(20:1.5);
                \draw[->,thick,red] (0,0)--(140:1.5);
            \end{scope}
            \begin{scope}[shift={(9,0)}]
                \draw[->] (-4,0)--(4,0);
                \draw[->] (0,-4)--(0,4);
                \begin{scope}[scale=0.8]
                    \draw (0,0) circle (1.5);
                    \draw (0,0) circle (3.3);
                    \draw (0,0) circle (4.5);
                    \draw[->,thick,blue] (20:1.5)--++(80:2.3)node(e){};
                    \draw[->,thick,red] (140:1.5)--++(80:2.3)node(f){};
                    \draw[->,thick,blue] (20:1.5)--++(-50:3.8)node(g){};
                    \draw[->,thick,violet] (-120:1.5)--++(-50:3.8)node(h){};
                    \draw[thick,blue] (0,0)--(e.center);
                    \draw[thick,red] (0,0)--(f.center);
                    \draw[thick,blue] (0,0)--(g.center);
                    \draw[thick,violet] (0,0)--(h.center);
                    \draw[->,thick,blue] (0,0)--(20:1.5);
                    \draw[->,thick,red] (0,0)--(140:1.5);
                    \draw[->,thick,violet] (0,0)--(-120:1.5);
                \end{scope}
            \end{scope}
        \end{tikzpicture}
        \caption{An isomorphous replacement of one set of atoms gives two possible set of phase angles (blue and red), and replacing another set of atoms will give a different set of phase angles (blue and violet). The common one is the true answer.}
    \end{figure}

    This of course brings some experimental difficulties. We need to make three different crystals, and we need to make sure that our replacement does not change anything other than the identity of the atoms that we are replacing --- this is not easy to do in practice.

    Luckily, such difficulty does not exist in centrosymmetric crystals since the phase will either be 0 or \(\pi\), i.e. they are real numbers. Once we know \(\delta F\), including its sign, we can directly determine the sign of \(F_1\) and \(F_2\) from their magnitudes.

    \subsection{Anomalous Scattering}
    A second method to determine the phase is to change the way that the electrons scatter the X-ray.

    The discussion up to this point has been based on the assumptions of Thomson scattering, which assume that electrons in crystals behave like free electrons. But actually, the electrons are bound into atoms, which means that the oscillations set up by the incident X-rays are to some extent restrained. Under most circumstances, the deviation from Thomson behaviour is negligible and the description we have given so far is adequate. However, significant differences can arise when the wavelength of the incident X-ray comes close to an \textit{absorption edge} for a particular atom type, where the energy corresponds to an electronic transition or ionisation process. Under this circumstance, the scattering behaviour of the atom will be different from the normal cases. This phenomenon is known as \textit{anomalous scattering} or \textit{resonant scattering}, where `anomalous' here means deviation from normal (Thomson) behaviour.

    \begin{figure}
        \centering
        \begin{tikzpicture}
            \draw[->] (0,0)--(5,0)node[below]{\(\lambda\)};
            \draw[->] (0,0)--(0,3.5)node[above]{\small Absorption};
            \draw[thick,domain=-2:1, smooth, variable=\x,samples=50] plot ({\x+2}, {3^(\x)+0.3});
            \draw (3,3.3)node[right, align=center]{\footnotesize absorption \\[-2pt] \footnotesize edge}--(3,0.2);
            \draw[thick,domain=-3:-1, smooth, variable=\x,samples=50] plot ({\x+6}, {2^(\x)+0.075});
        \end{tikzpicture}
    \end{figure}

    To account for anomalous scattering in the structure factor equation, the atomic scattering factors are modified to
    \begin{equation}
        f_{\text{anom}}=f+(f'+\ii f'')\,,
    \end{equation}
    where \(f\) is the normal scattering factor, and \(f'+\ii f''\) is a complex correction, where both \(f'\) and \(f''\) are real. The values of \(f'\) and \(f''\) depend on the X-ray wavelength but they are independent of scattering angle, and they are generally small compared to \(f\). \(f'\) can be either positive or negative, but \(f''\) is always positive.

    Since \(f'\) and \(f''\) are small compared to \(f\), it is usually sufficient to approximate all of the effect solely by adding the imaginary correction, so
    \begin{equation}
        f_{\text{anom}}\approx f+\ii\Delta f\,.
    \end{equation}

    We can then divide the atoms into the set that scatters normally, and the ones that scatter anomalously. Then the structure factor under anomalous conditions is
    \begin{align}
        F'(hkl)&=\sum_{n\text{ norm}}f_n \ee^{2\pi \ii(hx_n+ky_n+lz_n)}+\sum_{m\text{ anom}}(f_m+\ii\Delta f_m) \ee^{2\pi \ii(hx_m+ky_m+lz_m)}\notag\\
        &=\sum_{n}f_n \ee^{2\pi \ii(hx_n+ky_n+lz_n)} + \ii\sum_{\text{anom}}\Delta f_m \ee^{2\pi \ii(hx_m+ky_m+lz_m)}\notag \\
        &=F(hkl)+\delta F(hkl)\,,
    \end{align}
    where \(F(hkl)\) is the structure factor under normal scattering and change in the structure factor due to anomalous scattering is
    \begin{equation}
        \delta F(hkl)=\ii\sum_{\text{anom}}\Delta f_m \ee^{2\pi \ii(hx_m+ky_m+lz_m)}\,.
    \end{equation}
    Graphically, if an atom originally contribute \(f_n \ee^{\ii\phi}\) to the structure factor, then the anomalous change is
    \begin{equation}
        \ii\Delta f_n \ee^{\ii\phi}=\Delta f_n \ee^{\ii(\phi+\frac{\pi}{2})}\,,
    \end{equation}
    i.e. it is \(90^\circ\) counterclockwise to the normal scattering contribution.

    \begin{figure}
        \centering
        \begin{tikzpicture}
            \draw[->] (-1,0)--(4,0);
            \draw[->] (0,-1)--(0,3.5);
            \draw[->,thick] (0,0)--node[below right=-2pt]{\small\(F_{\text{rest}}\)}(2,0.7);
            \draw[->,thick] (2,0.7)--node[below right=-2pt]{\small\(F_{\text{anom}}\)}(3,1.9);
            \draw[->,thick,blue] (0,0)--node[above=-2pt]{\small\(F\)}(3,1.9);
            \draw[dashed] (3,1.9)--(4,3.1);
            \draw[->,thick,violet] (3,1.9)--node[above right]{\small\(\delta F\)}(2.1,2.65);
            \draw[->,thick,red] (0,0)--node[above left=-2pt]{\small\(F'\)}(2.1,2.65);
        \end{tikzpicture}
        \caption{Anomalous Scattering.}
    \end{figure}

    An important consequence of anomalous scattering is the breakdown of the Friedel's law: \(F(hkl)\) and \(F(\bar{h}\bar{k}\bar{l})\) are no longer complex conjugates of each other, and so \(I(hkl)\) and \(I(\bar{h}\bar{k}\bar{l})\) are no longer necessarily equal. This is because
    \begin{equation}
        F'(hkl)=\sum_{n}f_n \ee^{2\pi \ii(hx_n+ky_n+lz_n)} + \ii\sum_{\text{anom}}\Delta f_m \ee^{2\pi \ii(hx_m+ky_m+lz_m)}
    \end{equation}
    and so
    \begin{equation}
        F'(hkl)^*=\sum_{n}f_n \ee^{-2\pi \ii(hx_n+ky_n+lz_n)} - \ii\sum_{\text{anom}}\Delta f_m \ee^{-2\pi \ii(hx_m+ky_m+lz_m)}\,,
    \end{equation} 
    while
    \begin{equation}
        F'(\bar{h}\bar{k}\bar{l})=\sum_{n}f_n \ee^{-2\pi \ii(hx_n+ky_n+lz_n)} + \ii\sum_{\text{anom}}\Delta f_m \ee^{-2\pi \ii(hx_m+ky_m+lz_m)}\,.
    \end{equation}
    This is illustrated in the figure below.

    \begin{figure}
        \centering
        \begin{tikzpicture}[scale=1.4]
            \draw[->] (-1.5,0)--(4,0);
            \draw[->] (0,-2)--(0,2);
            \draw[-Stealth,thick] (0,0)--node[right=0.2cm]{\footnotesize\(F(hkl)\)}(2.5,1.1);
            \draw[dashed] (2.5,1.1)--(3.7,1.9);
            \draw[-Stealth,thick] (2.5,1.1)--node[right]{\footnotesize\(\delta F(hkl)\)}(1.9,2);
            \draw[-Stealth,thick] (0,0)--node[above left]{\footnotesize\(F'(hkl)\)}(1.9,2);
            \draw[-Stealth,thick] (0,0)--node[below]{\footnotesize\(F(\bar{h}\bar{k}\bar{l})\)}(2.5,-1.1);
            \draw[dashed] (2.5,-1.1)--(3.7,-1.9);
            \draw[-Stealth,thick] (2.5,-1.1)--node[right]{\footnotesize\(\delta F(\bar{h}\bar{k}\bar{l})\)}(3.1,-0.2);
            \draw[-Stealth,thick] (0,0)--node[above]{\footnotesize\(F'(\bar{h}\bar{k}\bar{l})\)}(3.1,-0.2);
        \end{tikzpicture}
        \caption{The Friedel's law is broken when anomalous scattering happens.}
    \end{figure}

    Note however that we still have \(I(hkl)=I(\bar{h}\bar{k}\bar{l})\) if the structure is centrosymmetric because then the two triangles will overlap.

    The breakdown of Friedel's law under anomalous scattering is actually extremely useful because it is now possible to distinguish the \textit{absolute structure} (handedness) of a non-centrosymmetric crystal.

    If the coordinates of all atoms in the non-centrosymmetric crystal is inverted with respect to the origin \((x_n,y_n,z_n)\to(-x_n,-y_n,-z_n)\), then we see that we have obtained its enantiomer. Hence, if A and B are enantiomers, we must have
    \begin{equation}
        F_{\text{A}}(hkl)=F_{\text{B}}(\bar{h}\bar{k}\bar{l})\,,
    \end{equation}
    and so \(I_{\text{A}}(hkl)=I_{\text{B}}(\bar{h}\bar{k}\bar{l})\). But now since \(I_{\text{B}}(\bar{h}\bar{k}\bar{l})\ne I_{\text{B}}(hkl)\) under anomalous scattering, \(I_{\text{A}}(hkl)\ne I_{\text{B}}(hkl)\). This allows us to determine the handedness of the crystal --- we just need to check which handedness of the model matches the measured intensities better than the other.

    In practice, we would set our model to one of the handedness, and work out the value of \(x\) such that
    \begin{equation}
        I_{\text{measured}}(hkl)=(1-x)I_{\text{model}}(hkl)+xI_{\text{model}}(\bar{h}\bar{k}\bar{l})\,,
    \end{equation}
    and take the average over \(hkl\). \(x\) is known as the \textit{Flack parameter}, and if our current handedness is correct, \(x\) should be 0 within some statistical error, while if \(x\) is near 1, the actual handedness of the crystal should be flipped.

    The assignment of absolute structure becomes more confident as the magnitude of the anomalous signal increases, which is achieved when heavy atoms are present. \(\mathrm{MoK}_\alpha\) radiation (\(\lambda=0.7107\,\text{\AA}\)) generally requires the crystal to contain \(\mathrm{Cl}\) atoms or heavier, while \(\mathrm{CuK}_\alpha\) radiation (\(\lambda=1.5418\,\text{\AA}\)) can be successful with lighter atoms. More detailed statistical analysis of the intensities can often confidently determine the absolute structure of \(\mathrm{CHNO}\) compounds with \(\mathrm{CuK}_\alpha\) radiation. This is incredibly useful for organic chemists.

    However, due to the same reason as for isomorphous replacement, a calculated \(\delta F\) and measured \(\abs{F(hkl)}\) and \(\abs{F'(hkl)}\) will give two possible values of phase angle \(\Phi(hkl)\). The solution is also the same --- we use another X-ray wavelength under which another set of atoms would scatter anomalously, and this will give another set of two possible phase angles. The common answer is the true answer. This technique is known as \textit{multiple anomalous scattering (MAD)}. It is particularly easy to apply if a source of variable wavelength is available, such as a synchrotron, so that several types of atoms can be made to scatter anomalously in turn.

    \newpage
    \section{Direct Methods}
    All the techniques introduced above rely on the fact that we know the positions of some atoms in the cell (the heavy atoms) using Patterson function. However, sometimes we can't even make a start using Patterson function and so none of the above methods work. We have to find an alternative route to the structure. Methods to do this are referred to as \textit{direct methods} because we are attempting to deduce the phases directly from the observed intensities without going through the Patterson function.

    The development of direct methods, coupled with the simultaneous growth of computing power, is principally responsible for establishing X-ray diffraction as a `standard' analytical technique in chemistry. It eliminates the requirement for heavy atoms, and hence enables structure determination for any compound.

    The theory is associated with probabilities, and can be fully described with the associated mathematical language rigorously. Here, we will only attempt to illustrate the basic concept using the understanding of Fourier synthesis.

    \subsection{The Basic Principle}
    For simplicity, we will consider a 1D crystal. The electron density is given by the Fourier synthesis (\ref{Fourier_synthesis})
    \begin{align}
        \rho(x)V_{\text{cell}}&=\sum_{h=-\infty}^{\infty}F(h)\ee^{-2\pi \ii hx}\notag \\
        &=F(0)+2\sum_{h=1}^{\infty}\abs{F(h)}\cos[\Phi(h)-2\pi hx]\,,
    \end{align}
    where we have used the fact that \(\Phi(-h)=-\Phi(h)\). To simplify things further, we assume that the structure has a centre of symmetry, so \(\Phi(h)\in\{0,\pi\}\). Then the summation becomes
    \begin{equation}
        \rho(x)V_{\text{cell}}=F(0)+2\sum_{h=1}^{\infty}S(h)\abs{F(h)}\cos(2\pi hx)\,,
    \end{equation}
    where \(S(h)=+1\) if \(\Phi(h)=0\), while \(S(h)=-1\) if \(\Phi(h)=\pi\). Consequently, the electron density is the sum of a series of cosine functions with period \(1/h\), amplitude \(\abs{F(h)}\) and sign \(S(h)\). In principle, we could determine \(\rho(x)\) by simply trying every possible combinations of \(S(h)\) values until we have found one which gives a reasonable electron density. But for \(N\) measured \(\abs{F(h)}\) values, there are \(2^N\) combinations, so it is highly impractical to check them one by one.

    The fundamental fact we will rely on is that electron density is a positive quantity. There may be a small negative region in our synthesis of \(\rho(x)\) due to the inaccuracies in the measurement of \(F(hkl)\) values (subject to experimental error) and series termination errors (due to the finite number of structure factors that can actually be measured), but there cannot be any significant negative regions --- this requirement will allow us to rule out certain combination of phases.

    \subsection{Fixing the Origin}
    Before determining the phases \textit{ab initio}, let's go back to the basics and consider again what does the ``phase'' mean. When defining the phase, we set an origin in our structure. This does not mean that we necessarily need to physically identify a point inside the crystal during a diffraction experiment. Rather, we need to specify the values of a few phases, so that we can define all other phases relative to those.

    For example, let's consider the \((h00)\) beam, where we write
    \begin{equation}
        F(h00)=\sum_n f_n\exp[2\pi \ii hx_n]\,.
    \end{equation}
    What we actually mean is
    \begin{equation}
        F(h00)=\sum_n f_n\exp[2\pi \ii h(x_n-x_{O})]\,,
    \end{equation}
    where \(x_{O}\) is the \(x\) coordinate of the origin. When we drop \(-x_O\), it is understood that \(x_n\) is a fractional coordinate defined relative to the origin. Obviously, the value of \(x_n-x_O\), and therefore the phase of \(F(h00)\), depends on the value of \(x_O\). But oppositely, if we choose the phase of one of the \(h00\) beams to be 0, we effectively define \(x_O\). In a 3D structure, we could define the phase of three independent beams, say \(h00\), \(0k0\) and \(00l\) for some \(h,k\) and \(l\), then we have effectively fixed the origin in the structure.

    Let's illustrate this using the common space group \(P2_1/c\). We claimed before that if a space group is centrosymmetric, as for this one, then the structure factor would always be a real number, with phase 0 or \(\pi\). This is actually true if and only if we set the origin to coincide with a centre of inversion. Of course it doesn't have to be, but we would always do so for simplicity. In \(P2_1/c\), there are 8 centres of inversion within a unit cell, located at
    \begin{equation}
        \textstyle (0,0,0)\,,\ (0,0,\frac{1}{2})\,,\ (0,\frac{1}{2},0)\,,\ (\frac{1}{2},0,0)\,,\ (\frac{1}{2},\frac{1}{2},0)\,,\ (\frac{1}{2},0,\frac{1}{2})\,,\ (0,\frac{1}{2},\frac{1}{2})\text{ and } (\frac{1}{2},\frac{1}{2},\frac{1}{2})\,,
    \end{equation}
    where \((0,0,0)\) is set to be one of these centres of inversion. Then the structure factor referring to this origin is
    \begin{equation}
        F(hkl)_{0,0,0}=\sum_n f_n\cos[2\pi(hx_n+ky_n+lz_n)]\,.
    \end{equation}
    Alternatively, if we move the origin to a different one, say the one we currently label as \((\frac{1}{2},\frac{1}{2},0)\), an atom that originally had fractional coordinate \((x_n,y_n,z_n)\) would now have coordinate \((x_n-\frac{1}{2},y_n-\frac{1}{2},z_n)\). Hence, relative to this origin, the structure factor becomes
    \begin{equation}
        F(hkl)_{\frac{1}{2},\frac{1}{2},0}=\sum_n f_n\cos\left[2\pi\left((hx_n+ky_n+lz_n)-\frac{h+k}{2}\right)\right]=(-1)^{h+k}F(hkl)_{0,0,0}\,.
    \end{equation}
    Consequently, the magnitude of each structure factor will have the same magnitude after this change, but its sign will change according to whether \(h+k\) is odd or even.

    Similar expressions can be obtained for all choices of the origin.
    \begin{equation}
        \begin{aligned}
            F(hkl)_{0,0,\frac{1}{2}}&=(-1)^l F(hkl)_{0,0,0}\,,\\
            F(hkl)_{0,\frac{1}{2},0}&=(-1)^k F(hkl)_{0,0,0}\,,\\
            F(hkl)_{\frac{1}{2},0,0}&=(-1)^h F(hkl)_{0,0,0}\,,\\
            F(hkl)_{0,\frac{1}{2},\frac{1}{2}}&=(-1)^{k+l} F(hkl)_{0,0,0}\,,\\
            F(hkl)_{\frac{1}{2},0,\frac{1}{2}}&=(-1)^{h+l} F(hkl)_{0,0,0}\,,\\
            F(hkl)_{\frac{1}{2},\frac{1}{2},0}&=(-1)^{h+k} F(hkl)_{0,0,0}\,,\\
            F(hkl)_{\frac{1}{2},\frac{1}{2},\frac{1}{2}}&=(-1)^{h+k+l} F(hkl)_{0,0,0}\,.
        \end{aligned}
    \end{equation}
    Hence, if we specify the phases of three carefully chosen beams, say \(312\), \(322\) and \(221\) all to have phase \(0\), then there will be only one of the eight possible origins to agree with all of these three phase values (try it!), and hence we have successfully specified the origin.

    Moreover, we can expand the set of known phases by symmetry. By inspection on the general equivalent positions of the \(P2_1/c\) space group, we get
    \begin{equation}
        F(hkl)=F(h\bar{k}l)=F(\bar{h}k\bar{l})=F(\bar{h}\bar{k}\bar{l})\,.
    \end{equation}
    Hence, by solely defining the origin, we get 12 phase values already.

    \subsection{Projected Structures and Unitary Structure Factors}
    The basic principle of the direct method is the non-negativity of electron density. For a centrosymmetric crystal,
    \begin{equation}
        \rho(x,y,z)=\sum_{h,k,l=-\infty}^{\infty}S(hkl)\abs{F(hkl)}\cos[2\pi(hx+ky+lz)]\,,
    \end{equation}
    where \(S(hkl)=\pm 1\). We see that a beam with strong \(\abs{F(hkl)}\) has a large influence on the resulting Fourier summation, so we would expect to be able to establish their phases most confidently. However, we would expect a very large number of terms in this triple summation, and hence even strong \(\abs{F(hkl)}\) beams will have a small contribution, and we would be less confident with any phase we propose.

    This problem will be reduced if there are fewer terms in the series, which can be achieved if we project the structure onto a line. For example,
    \begin{equation}
        \rho(x)=F(000)+2\sum_{h=1}^{\infty}S(h00)\abs{F(h00)}\cos(2\pi hx)
    \end{equation}
    would describe the electron density projected onto the \(x\) axis, and
    \begin{equation}
        \rho(d)=F(000)+2\sum_{h=1}^{\infty}S(hhh)\abs{F(hhh)}\cos(6\pi hd)
    \end{equation}
    would describe the electron density projected onto the body diagonal of the cell, where \(d\) is the coordinate projected to the diagonal. In both cases, the non-negativity principle must still apply, and the number of terms in the sum has drastically reduced as we hoped to.

    However, the projection brings another issue. In the original 3D structure, the electron density consists of electron-rich atoms separated by regions of very low electron density. However, this property is likely to be lost if the electron density is projected onto a line. The consequence is that, in general, it will be harder to generate regions of negative electron density even if some \(S(hkl)\) are incorrect. Therefore the predictive power of the non-negativity principle will decrease.

    There is an elegant way to get around this. Since atomic scattering factor looks roughly the same shape for all atoms, differing mainly only their scale, we can define a \textit{unitary scattering factor}
    \begin{equation}
        n_n=\frac{f_n}{\sum_m f_m}\,.
    \end{equation}
    This represents the fraction of the scattering power of the atom relative to the overall scattering power of the cell, and since \(f_n\) has similar shapes, \(n_n\) will be roughly constant without any decay. Hence, the unitary scattering factor represents the scattering of a point atom, as the inverse Fourier transform of a constant function is a delta function.

    \begin{figure}
        \centering
        \begin{subfigure}[h]{0.45\linewidth}
            \begin{adjustbox}{width=\linewidth}
                \input{Scattering_C.tex}
            \end{adjustbox}
            \caption{Scattering factor of carbon.}
        \end{subfigure}
        \hfill
        \begin{subfigure}[h]{0.45\linewidth}
            \begin{adjustbox}{width=\linewidth}
                \input{Unitary_scattering_C.tex}
            \end{adjustbox}
            \caption{Unitary scattering factor of a carbon atom in a cell with content \(\mathrm{C_{24}H_{24}O_8}\) .}
        \end{subfigure}
    \end{figure}

    From the unitary scattering factor, we can define the \textit{unitary structure factor}
    \begin{equation}
        U(hkl)=\sum_n n_n\exp[2\pi \ii(hx_n+ky_n+lz_n)]=\frac{F(hkl)}{\sum_n f_n}\,.
    \end{equation}
    An extra benefit of doing so is that because of the fall-off in the scattering power with diffraction angle, some beams which are inherently strong (in that all atoms scatter in phase) will nevertheless be weak. Unitary structure factors nicely remove this dependence on scattering angle. Finally, an extra helpful thing to do is to normalise it by the mean-squared unitary structure factor
    \begin{equation}
        E(hkl)=\frac{U(hkl)}{\sqrt{\eval{U(hkl)^2}}}\,.
    \end{equation}

    \subsection{Pair and Triple Relationships}
    \subsubsection{Pair Relationship}
    Suppose we have a normalised electron density projected onto the \(x\) axis
    \begin{equation}
        \rho(x)=1+2\sum_{h>0}S(h)\abs{E(h)}\cos(2\pi hx)\,.
    \end{equation}
    Now consider the case when there are two very strong beams, with indices \(h\) and \(2h\), of similar magnitudes \(\abs{E(h)}\approx\abs{E(2h)}\), we write
    \begin{equation}
        \rho(x)\approx 1+2\abs{E}[S(h)\cos(2\pi hx)+S(2h)\cos(4\pi hx)]\,.
    \end{equation}
    If the sum of these two contributions have a significantly negative region, it is unlikely that other terms in the Fourier synthesis will compensate for that, so we wish their minima will not overlap. Let's check different combinations of \(S(h)\) and \(S(2h)\), as shown in \cref{Fig:Pair_relation}.

    \begin{figure}
        \centering
        \begin{tikzpicture}
            \begin{scope}
                \draw[->] (0,0)--(3.142,0);
                \draw[thick,domain=0:6.283, smooth, variable=\x,samples=80] plot ({0.5*\x}, {0.8*cos(\x r)});
                \node at (1.57,-1.6){\small Positive \(E(h)\)}; 
            \end{scope}
            \node at (4.07,0){\(+\)};
            \begin{scope}[shift={(5,0)}]
                \draw[->] (0,0)--(3.142,0);
                \draw[thick,domain=0:6.283, smooth, variable=\x,samples=80] plot ({0.5*\x}, {0.8*cos(2*\x r)});
                \node at (1.57,-1.6){\small Positive \(E(2h)\)};
            \end{scope}
            \node at (9.07,0){\(=\)};
            \begin{scope}[shift={(10,0)}]
                \draw[->] (0,0)--(3.142,0);
                \draw[thick,domain=0:6.283, smooth, variable=\x,samples=80] plot ({0.5*\x}, {0.8*cos(\x r)+0.8*cos(2*\x r)});
            \end{scope}

            \begin{scope}[shift={(0,-4)}]
                \begin{scope}
                    \draw[->] (0,0)--(3.142,0);
                    \draw[thick,domain=0:6.283, smooth, variable=\x,samples=80] plot ({0.5*\x}, {0.8*cos(\x r)});
                    \node at (1.57,-1.6){\small Positive \(E(h)\)}; 
                \end{scope}
                \node at (4.07,0){\(+\)};
                \begin{scope}[shift={(5,0)}]
                    \draw[->] (0,0)--(3.142,0);
                    \draw[thick,domain=0:6.283, smooth, variable=\x,samples=80] plot ({0.5*\x}, {-0.8*cos(2*\x r)});
                    \node at (1.57,-1.6){\small Negative \(E(2h)\)};
                \end{scope}
                \node at (9.07,0){\(=\)};
                \begin{scope}[shift={(10,0)}]
                    \draw[->] (0,0)--(3.142,0);
                    \draw[thick,domain=0:6.283, smooth, variable=\x,samples=80] plot ({0.5*\x}, {0.8*cos(\x r)-0.8*cos(2*\x r)});
                \end{scope}
            \end{scope}

            \begin{scope}[shift={(0,-8)}]
                \begin{scope}
                    \draw[->] (0,0)--(3.142,0);
                    \draw[thick,domain=0:6.283, smooth, variable=\x,samples=80] plot ({0.5*\x}, {-0.8*cos(\x r)});
                    \node at (1.57,-1.6){\small Negative \(E(h)\)}; 
                \end{scope}
                \node at (4.07,0){\(+\)};
                \begin{scope}[shift={(5,0)}]
                    \draw[->] (0,0)--(3.142,0);
                    \draw[thick,domain=0:6.283, smooth, variable=\x,samples=80] plot ({0.5*\x}, {0.8*cos(2*\x r)});
                    \node at (1.57,-1.6){\small Positive \(E(2h)\)};
                \end{scope}
                \node at (9.07,0){\(=\)};
                \begin{scope}[shift={(10,0)}]
                    \draw[->] (0,0)--(3.142,0);
                    \draw[thick,domain=0:6.283, smooth, variable=\x,samples=80] plot ({0.5*\x}, {-0.8*cos(\x r)+0.8*cos(2*\x r)});
                \end{scope}
            \end{scope}

            \begin{scope}[shift={(0,-12)}]
                \begin{scope}
                    \draw[->] (0,0)--(3.142,0);
                    \draw[thick,domain=0:6.283, smooth, variable=\x,samples=80] plot ({0.5*\x}, {-0.8*cos(\x r)});
                    \node at (1.57,-1.6){\small Negative \(E(h)\)}; 
                \end{scope}
                \node at (4.07,0){\(+\)};
                \begin{scope}[shift={(5,0)}]
                    \draw[->] (0,0)--(3.142,0);
                    \draw[thick,domain=0:6.283, smooth, variable=\x,samples=80] plot ({0.5*\x}, {-0.8*cos(2*\x r)});
                    \node at (1.57,-1.6){\small Negative \(E(2h)\)};
                \end{scope}
                \node at (9.07,0){\(=\)};
                \begin{scope}[shift={(10,0)}]
                    \draw[->] (0,0)--(3.142,0);
                    \draw[thick,domain=0:6.283, smooth, variable=\x,samples=80] plot ({0.5*\x}, {-0.8*cos(\x r)-0.8*cos(2*\x r)});
                \end{scope}
            \end{scope}
        \end{tikzpicture}
        \caption{The minima of the two terms will overlap if \(E(2h)\) is negative.}
        \label{Fig:Pair_relation}
    \end{figure}

    We see that regardless of \(S(h)\) and \(S(2h)\), we will have some negative regions. However, if \(S(2h)\) is negative, whatever \(S(h)\) is, the minima of the two cosine waves will overlap, resulting in a strongly negative region. This is unlikely. Hence, we get the pair relationship: if \(E(h)\) and \(E(2h)\) are both large, then \(S(2h)\) is likely to be \(+1\).

    As we can take projection along any axis, this result can be generalised: if \(E(\vb{h})\) and \(E(2\vb{h})\) are large, where \(\vb{h}=hkl\) is the Miller index, then \(S(2\vb{h})=+1\).

    \subsubsection{Triple Relationship}
    A similar, but more involved analysis can be done for \(E(\vb{h})\), \(E(\vb{h}')\) and \(E(\vb{h}+\vb{h}')\), assuming all large and of similar magnitudes.

    Let's imagine forming a two dimensional space, plotting \(\pm\cos(hx)\) and \(\pm\cos(h'y)\) along the two axis, where \(h=\norm{\vb{h}}\) and \(h'=\norm{\vb{h}'}\). This is equivalent to reorient the two Fourier waves \(\pm \cos(\vb{S}\vdot\vb{r})\) and \(\pm \cos(\vb{S}'\vdot\vb{r})\) along \(x\) and \(y\) axes, respectively. As shown in \cref{Fig:Triple_relation}, the minimum of the sum of these two waves will be at one of the grid points \(A\), \(B\), \(C\) or \(D\). The third wave \(\pm\cos(hx+h'y)\), corresponding to \(\pm\cos((\vb{S}+\vb{S}')\vdot\vb{r})\) with miller index \(\vb{h}+\vb{h}'\), will have its wavefront at the diagonal, and we hope it to have its maximum aligned with the minimum of the previous two waves combined in order to compensate for it.

    \begin{figure}
        \centering
        \begin{tikzpicture}
            \fill[gray!30] (0,4) node[below right,black]{\small\(A\)} circle (0.4);
            \fill[gray!30] (0,2) node[below right,black]{\small\(C\)} circle (0.4);
            \fill[gray!30] (3,4) node[below right,black]{\small\(B\)} circle (0.4);
            \fill[gray!30] (3,2) node[below right,black]{\small\(D\)} circle (0.4);
            \draw (0,0) rectangle (6,4);
            \draw[dashed] (3,0)--(3,4);
            \draw[dashed] (0,2)--(6,2);
            \draw[thick,red] (-0.6,-0.4)--(6.6,4.4);
            \draw[thick,red] (-2.1,0.6)--(5.1,5.4);
            \draw[thick,red] (-3.6,1.6)--(3.6,6.4);
            \draw[red,very thick,->] (-1.2,3.2)node[above left]{\small\(cos(hx+h'y)\)}--(1.5,-1.1);
            \draw[thick,->] (5.3,4.3)--(5.8,4.3)node[above]{\(x\)};
            \draw[thick,->] (-0.3,0.7)--(-0.3,0.2)node[left]{\(y\)};
            \foreach \x in {0,3,6}{
                \node at (\x,-0.5) [align=center] {\small \(\cos(hx)\) \\[-1pt] max/min};
            }
            \foreach \y in {0,2,4}{
                \node at (6.3,\y) [right] {\small \(\cos(h'y)\) max/min};
            }
        \end{tikzpicture}
        \caption{Triple relationship.}
        \label{Fig:Triple_relation}
    \end{figure}

    \begin{table}[ht!]
        \centering
        \begin{tabular}{ccccc}
            \toprule
            \(S(h)\) & \(S(h')\) & \makecell[c]{\(E(h+h')\) must diminish \\ minimum at position} & \(S(h+h')\) & \(S(h)S(h')S(h+h')\) \\ \midrule
            \(+1\) & \(+1\) & \(D\) & \(+1\) & \(+1\) \\
            \(+1\) & \(-1\) & \(C\) & \(-1\) & \(+1\) \\
            \(-1\) & \(+1\) & \(A\) & \(-1\) & \(+1\) \\
            \(-1\) & \(-1\) & \(B\) & \(+1\) & \(+1\) \\ \bottomrule
        \end{tabular}
    \end{table}

    This can be summarised as the \textit{triple relationship}
    \begin{equation}
        S(\vb{h})S(\vb{h}')S(\vb{h}+\vb{h}')=+1\,.
    \end{equation}
    One can see that this reduces to the pair relationship if we just set \(\vb{h}=\vb{h}'\).

    The advantage of this method is that it can be automated with trials and errors on a computer, requiring virtually no user input.

    \subsubsection{Limitation of Direct Methods}
    Recall that the way we figure out \(\rho(x,y,z)\) is to use a Fourier series, and if we include an infinite sum of diffracted beams, we should be able to reproduce it exactly. However, we can only measure diffraction up to a finite maximum scattering angle, and hence we have a finite number of terms in the Fourier synthesis. This results in the \textit{series termination error}. This can be particularly problematic in direct methods.

    \begin{figure}
        \centering
        \includegraphics[width=0.5\textwidth]{Termination_error.png}
        \caption{Fourier synthesis of electron density in caesium picrate \(\mathrm{Cs[C_6H_2(NO_2)_3O]}\) as number of terms increases.}
        \label{Fig:Termination_error}
    \end{figure}

    Let's consider the example of caesium picrate \(\mathrm{Cs[C_6H_2(NO_2)_3O]}\), projected onto the \(x\) axis. \Cref{Fig:Termination_error} shows progressively larger number of \(E(h)\) values included in the Fourier synthesis of electron density. We see with only five terms included in the sum, only Cs atoms at \(x\approx 0.1\) and \(x\approx 0.9\) can be observed, and the C, N and O atoms are not resolved. As more terms are included, the lighter atoms become visible, and the large Cs peaks also becomes sharper. However, the Cs peaks are also surrounded by large negative ripples, which arises due to the series termination errors. These remain strong even when 40 terms are included in the series, only disappearing when the number of terms exceeds 100. Therefore, we are likely to observe negative electron density regions around heavy atoms even when our phases are correct. Consequently, any method relying on the non-negativity of electron density may falsely rule out the correct phases combinations.

    The solution is also simple. If heavy atoms are present, then Patterson function plus phase determining methods based on heavy atoms would be ideal. Direct method and heavy atom based methods are perfectly complementary.
    
    Moreover, for molecules like proteins when there are no particularly heavy atoms and the unit cells are large, there might be no particularly strong peaks, and the intensities are measured at low resolutions. For them, multiple isomorphous replacement, multiple anomalous scattering or (most commonly) single anomalous scattering would be used.

    \subsection{Dual-Space Methods}
    In fact, most chemical structures solved today use neither the Patterson function nor direct methods. Instead, modern computing power enables application of the following algorithm called the \textit{dual-space method}.

    \begin{enumerate}
        \item Produce a random phase \(\Phi(hkl)\) for each measured \(F(hkl)\).
        \item Generate \(\rho(x,y,z)\) at points on a defined grid within the unit cell by the inverse Fourier transform using measured \(\abs{F(hkl)}\) and current \(\Phi(hkl)\).
        \item For any grid point with negative \(\rho(x,y,z)\), multiply the value by \(-1\).
        \item Calculate new \(F(hkl)\) by the Fourier transform of \(\rho(x,y,z)\).
        \item Replace the current phase set with the \(\Phi(hkl)\) values obtained in step 4, then return to step 2.
    \end{enumerate}

    The above operation will converge to a \(\rho(x,y,z)\) which is necessarily non-negative. We would repeat the procedure many times from different initial sets and to assess which of the converged solutions is the most likely to be correct.

    The fundamental basis of the dual space method is clearly the non-negativity of electron density, and the process of flipping negative \(\rho(x,y,z)\) is an example of \textit{density modification}, meaning modifying the calculated electron density to conform to our expectations. The established principle of atomicity can also be applied to the structure at some defined frequency during the iteration. This is achieved by identifying a number of maxima in \(\rho\) and replacing them by isolated spherical electron densities at these positions.

    An additional benefit of dual-space method is that it does not require the symmetry of the crystal structure to be firmly established. They are usually applied to the whole unit cell content.

    \newpage
    \section{Structure Refinement and Other Diffraction Methods}
    The methods described in previous sections generally produce only an approximate model to the structure under investigation, commonly referred to as a \textit{trial structure}. Atoms may deviate from their true positions quite significantly, and some atoms may remain to be found. In order to complete the model, it is necessary to refine the structure. We will provide a brief outline here.

    \subsection{Residual Minimisation}
    As the observed \(\abs{F(hkl)}\) are known functions of the atomic coordinates, the latter can be refined using least-squares methods. The quantity to be minimised is the \textit{residual}
    \begin{equation}
        R=\sum_{hkl}w_{hkl}[\abs{F_{\text{obs}}(hkl)}^2-\abs{F_{\text{calc}}(hkl)}^2]^2\,,
    \end{equation}
    where \(w_{hkl}\) is a weighting factor expressing the accuracy of individual \(\abs{F_{\text{obs}}(hkl)}\) values derived during measurements.

    However, this is not as simple as it seems. The structure factor equation is not linear, so it is not possible to apply straightforward least-squares methods. We need to \textit{linearise} the equation by considering the \textit{atomic shifts} \(\delta x_n = x_n'-x_n\), and compute the best value of shifts for a particular set of coordinates. We can iterate until the optimal shifts become small. Like any optimisation processes, we want to converge to the global minimum of the residual, but as ever, we are likely to get stuck at a local minimum during optimisation. We then need to use our chemical intuition e.g. whether some bond lengths or coordination environment are suspicious to identify the true structure.

    \subsection{Locating the Atoms}
    In accordance with the Independent Atom Model, the image of \(\rho(x,y,z)\) must then be interpreted to obtain coordinates for each atom. Atoms are considered to lie at the centroids of concentrated regions of electron density. The accuracy of the atomic positions must therefore depend on the quality of the electron density map. The image of \(\rho(x,y,z)\) is influenced by the number of terms included in the Fourier synthesis, and the derived atomic coordinates are therefore very much dependent on the resolution of the analysis.
    
    Examples are shown in \cref{Fig:Resolution} for a section of the electron density map through the benzene ring of the molecule sulfathiazole. At the exceptionally high resolution of \(0.46\,\text{\AA}\), the atoms are very clearly defined, and their centres can be identified with confidence. However, note that it is not entirely obvious where the H atoms lie. At \(1.20\,\text{\AA}\) resolution, the atoms of the benzene ring merge effectively into a continuous feature, and it is more difficult to define each atomic centre. For the four C(H) atoms, the electron density appears to protrude outward in the direction where H atom is expected. Hence, defining the C atom coordinates at the centroid of these distorted features is likely to result in a distorted geometry for the benzene ring. A more typical resolution for a molecular crystal structure is \(0.85\,\text{\AA}\), which can be seen to produce relatively well defined atoms. Nonetheless, it should be clear that the accuracy of the final atomic coordinates can be limited for lower resolution crystal structures, and great care should be taken when interpreting derived bond distances and angles.

    \begin{figure}
        \centering
        \includegraphics[width=0.9\textwidth]{Resolution.png}
        \caption{Electron density map of sulfathiazole at different resolutions.}
        \label{Fig:Resolution}
    \end{figure}

    \subsection{The Difference Density}
    We can define the \textit{difference density} as the inverse Fourier transform of the difference between the observed and calculated \(\abs{F(hkl)}\) values
    \begin{equation}
        \rho_{\text{D}}(x,y,z)=\mathcal{F}^{-1}\left[(\abs{F_{\text{obs}}(hkl)}-\abs{F_{\text{calc}}(hkl)})\exp[\ii\Phi_{\text{calc}}(hkl)]\right]\,,
    \end{equation}
    where \(\abs{F_{\text{calc}}(hkl)}\) and \(\Phi_{\text{calc}}(hkl)\) are calculated from the current trial structure.

    The resulting difference density is interpreted as the difference between the correct structure and the trial structure. If our trial structure is absolutely correct, the difference density should be identically zero. Normally, \(\rho_{\text{D}}\) has some definite characteristics:
    \begin{itemize}
        \item \textit{Positive peaks}: this arises if an atom has been omitted from the trial structure. Towards the end of a refinement, this is usually the hydrogen atom. It is very difficult to find H atoms in an image of the actual electron density, \(\rho(x,y,z)\), because it is usually submerged in the noise of series termination error, especially in the presence of other heavy atoms. The H atoms are usually more clearly seen on the difference density since both \(\abs{F_{\text{obs}}(hkl)}\) and \(\abs{F_{\text{calc}}(hkl)}\) are subjected to termination errors, so the subtraction will cancel them out to some extent.
        \item \textit{Positive and negative peaks adjacent to an atom in the trial structure}: this will arise if the atom is not quite at the right position. It can be rectified by moving the atom in the direction of the maximum \(\rho_{\text{D}}\) gradient.
        \item \textit{Hollow peaks at an atom position in the trial structure}: a negative peak surrounded by a pronounced positive rim will occur if the trial structure is effectively more `dense' than in the real structure. This often arises when there is a need to optimise the atomic displacement parameter. This is mentioned further below.
    \end{itemize}

    Since \(\rho(x,y,z)\) is always subject to series termination errors, we cannot expect the difference density ever to be zero. There will always be ``Fourier ripples'' around particularly heavy atoms, which might be quite substantial (say \(1e\text{\AA}{}^{-3}\)). The crucial point is that a completed structure refinement should not have any remaining features in \(\rho_{\text{D}}\) that are indicative of missing atoms, i.e. a peak of \(1e\,\text{\AA}{}^{-3}\) within \(0.5\,\text{\AA}\) of a heavy atom is likely to be just a Fourier ripple, but a peak of \(1e\,\text{\AA}{}^{-3}\) at a distance of \textit{ca} \(1\,\text{\AA}\) from an O atom making only one other bond is clearly the H atom of an OH group. Hence, some chemical understanding is also required to interpret crystallographic results.

    \subsection{Atomic Displacement Parameters}
    Atomic displacement parameters, ADPs, were mentioned in the discussion of atomic scattering factors. The ADPs can be viewed to ``modulate'' the atomic scattering factors to account for thermal vibration or static displacement (where an atom might take slightly different positions within different unit cells).

    ADPs should always be positive and serve to decrease an atom's contribution in the structure factor equation. They are visualised by representing the atom as a sphere (for an isotropic ADP) or ellipsoid (for an anisotropic ADP) scaled to the size of the numerical parameters. For a given crystal structure, it is reasonable to expect, and generally observed, that all atoms have displacement ellipsoids/spheres of a similar size. Anomalous ADPs are indicative of atoms that may have been assigned the wrong atom type. During a structure refinement, the atom type is defined by the choice of atomic scattering factor, which is then fixed during a given refinement run. The ADPs, on the other hand, are numerical parameters that can be refined during the least-squares process, and can respond to an incorrect choice of atoms. If an atomic site is assigned an atom type with too many electrons, the ADPs will become large to diminish the atomic scattering factor. Conversely, if an atomic site is assigned as an atom site with too few electrons, the ADPs will become small so that they do not apply any significant modulating effect. In extreme cases, ADPs can refine to negative values (in the anisotropic case, the displacement tensor becomes ``non-positive definite''), which makes no physical sense and is not acceptable in a crystallographic result.

    \subsection{H atoms}
    It has been mentioned that H atoms can be difficult to locate in \(\rho(x,y,z)\) because they only have one electron. An additional point to consider is where the H atom actually is. The one electron of H will almost always be involved in a covalent bond, so the maximum electron density in a \(\mathrm{C-H}\) bond (for example) will be somewhere between the C atom and the proper nuclear position of the H atom. Since atomic positions are deduced from maxima in \(\rho(x,y,z)\), H atoms will be placed too close to the atom to which they are bonded, i.e. bond lengths to H in X-ray crystal structures are always systematically too short.
    
    Often we know enough about molecular structure to know where H atoms should be, so we can just place H atoms in calculated positions. However, we still have to place them in the ``wrong'' (shortened) positions because we are still trying to fit an electron density map. True H atom positions can be estimated by normalising \(\mathrm{X-H}\) bonds to values obtained from neutron diffraction.

    \subsection{Assessing the Quality of the Results}
    When the refinement has been completed, the final result of the structure determination is commonly expressed by two different normalised residuals:
    \begin{align}
        wR2&=\left(\frac{\sum_{hkl}w_{hkl}\left[\abs{F_{\text{obs}}(hkl)}^2-\abs{F_{\text{calc}}(hkl)}^2\right]^2}{\sum_{hkl}w_{hkl}\left[\abs{F_{\text{obs}}(hkl)}^2\right]^2}\right)^{1/2}\\
        R1&=\frac{\sum_{hkl}\abs{\abs{F_{\text{obs}}(hkl)}-\abs{F_{\text{calc}}(hkl)}}}{\sum_{hkl}\abs{F_{\text{obs}}(hkl)}}\,.
    \end{align}
    The first of these is a root-mean-squared value derived directly from the refined residual, while the second is based on absolute differences between the structure factor magnitudes. The \(wR2\) measure is preferred because it can include all intensity data. \(R1\) will require weak \(\abs{F}\) values below a minimum threshold (typically greater than 3 times the estimated error) to be ignored because of the difficulties assessing their accuracy.

    For a chemical crystal structure, \(wR2\) is typically in the range \(0.10\sim 0.20\). \(R1\) values are always smaller, typically in the range \(0.05\sim 0.10\). There may be reasons why \(R\)-factors could be larger than these quoted values, for example a very weakly diffracting crystal (producing noisy intensities), or substantial disorder, where atoms may not correspond to the expectations of perfect long-range order in a single crystal. Hence, \(R\)-factors alone do not always tell the full story. To assess a crystal structure, it is important also to compare it to expectations based on physical and chemical sense.

    \subsection{Neutron and Electron Diffraction}
    This course has focused mainly on X-ray diffraction because X-rays are most commonly used for chemical characterisation, particularly in ``home'' laboratories. The same principles apply of course to other radiation sources. Neutrons have long been used to complement X-ray diffraction analyses, and electron diffraction is also now emerging as a practical technique to study micro- and nano-crystalline materials. 

    \subsubsection{Neutron Diffraction}
    Although they are commonly regarded as particles, neutrons have a wave-like character (as all the particles) and are also diffracted by matter. Thermal neutrons from a reactor have a kinetic energy given by:
    \begin{equation}
        E=\frac{1}{2}mv^2\approx k_B T=4\times 10^{-21}\unit{J}
    \end{equation}
    at room temperature. This corresponds roughly to a velocity of \(2,200\unit{m}\unit{s}^{-1}\), and hence a wavelength of about \(1.8\,\text{\AA}\), which is eminently suitable for diffraction studies.

    Neutron diffraction has some distinct advantages over X-ray diffraction:
    \begin{enumerate}
        \item Neutrons are mainly scattered by atomic nuclei, which are very small. Consequently peaks in either a Patterson function or a ``nuclear density'' map produced by the inverse Fourier transform will be very sharp, making interpretation easier.
        \item For X-ray diffraction, the scattering power of an atom is roughly proportional to its atomic number. This means that light atoms, particularly H, may be difficult to identify and refine. In neutron diffraction, the scattering power of a nucleus depends on the nuclear energy levels, which vary in an almost random way, even among isotopes of the same element. Consequently some light atoms scatter neutrons more strongly than heavy ones. The most important case involves the scattering from isotopes of H, which is very strong from 2H (deuterium). Neutron diffraction is therefore a good way to locate the true positions of H atoms by experiment.
        
        The random variation of neutron scattering powers can be exploited in other ways. For example, it is difficult using X-ray diffraction to distinguish between atoms with very similar atomic number because they have almost identical scattering power. A classic example is Si and Al in a zeolite structure. For neutrons however, their scattering powers are different, and they can be easily distinguished.
        \item Neutrons have spin, and can therefore interact with the local magnetic field produced by an unpaired electron. If unpaired electrons are present, the atomic scattering factor for neutrons can be written as:
        \begin{equation}
            f_{\text{neutron}} = f_{\text{nuclear}} + f_{\text{magnetic}}\,. 
        \end{equation}
        When we record an experimental set of diffracted intensities using neutrons, we are recording the effects of both magnetic and nuclear components of the scattering. If the basic structure is known (usually from a preliminary X-ray measurement), we can calculate a type of ``difference density'' using \(\abs{F_{\text{calc}}(hkl)}\) and \(\Phi_{\text{calc}}(hkl)\) values which are deduced from the atomic parameters using the nuclear scattering factors only. The features which show up in the difference density then highlight parts of the structure where magnetic electrons are present. This difference density, which has the form:
        \begin{equation}
            \rho_{\text{magnetic}}(x,y,z)=\mathcal{F}^{-1}\left[(\abs{F_{\text{obs}}(hkl)}-\abs{F_{\text{calc}}(hkl)})\exp[\ii\Phi_{\text{calc}}(hkl)]\right]\,,
        \end{equation}
        is normally referred to as the \textit{magnetic scattering density}. 
    \end{enumerate}

    Although they have these clear advantages, neutrons also have two important disadvantages which restrict their use:
    \begin{enumerate}
        \item Thermal neutrons require a nuclear reactor for their generation. Consequently they are only available in certain specialised central facilities, to which applications for beam time must be made and where complicated experimental arrangements for ``one-off'' or speculative experiments are not generally possible.
        \item Neutron scattering is almost two orders of magnitude weaker than X-ray scattering. Consequently, to record acceptable diffracted intensities usually requires a larger sample. In the case of powder diffraction, this is not too much of a problem, but most \textit{ab initio} structure solution requires single crystals, and these are frequently very difficult, if not impossible, to grow in the sizes required for neutron work. This is particularly true for materials such as proteins. 
    \end{enumerate}

    \subsubsection{Electron Diffraction}
    Accelerated electrons also have significant wave-like character. For a representative accelerating voltage of \(200 \unit{keV}\) in an electron microscope, the wavelength is about \(0.025\,\text{\AA}\); considerably shorter than X-ray wavelengths used in laboratory diffraction instruments but still in the region to permit diffraction studies.

    The main benefit of using electrons is that it allows diffraction data to be collected from nano-crystalline samples, with volume two or three orders of magnitude smaller than those required for lab-based X-ray measurements. This is possible due to the strong coulomb interaction between the electron beam and the sample. However, there are practical drawbacks, namely that measurements are required to be made in a vacuum, and have generally been implemented with electron microscopes that limit sample movement and therefore cannot access all areas of reciprocal space. In addition, exposure to intense electron beams can lead to rapid sample decomposition, especially for organic molecules. These practical matters have generally limited the application of electron diffraction compared to X-ray diffraction. Some of them are now starting to be overcome by dedicated electron diffraction instruments and cryo-cooling of samples, \textit{etc.}, and the technique is likely to grow significantly in the coming years.

    The particularly strong scattering of electrons leads to challenges in data interpretation. In particular, recall from the initial discussion that we developed the Fourier transform relationship under the assumption that the total scattering is small compared to the strength of the incident beam. For electrons, we cannot assume that the scattering is small compared to the incident beam, so we have to deal with \textit{dynamical scattering theory}, which takes into account multiple scattering effects (i.e. re-scattering of the scattered beams). Practically, it is helpful to minimise multiple scattering in electron diffraction by using samples that are as thin as possible (with the drawback that this is likely to accelerate sample decomposition), but it still cannot be ignored during structure determination and refinement procedures.
    
    For many years, software used for X-ray structure solution and refinement has simply been applied to electron diffraction data, and it has been accepted that the results will be generally worse than those obtained using X-rays (an acceptable price to pay for being able to look at very small samples). In the last few years, however, effective software implementing the full dynamical theory has started to emerge. The calculations are very much more intensive than for X-rays, so cycles of refinement may reach hours rather than seconds for X-rays. The computational cost obviously increases with structure size, and macromolecular refinements are not in reach in the immediate future. However, the methods have produced promising results for small-molecule structures, including effective identification of H atoms and absolute structure determination.




\end{document}