\documentclass{article}

\usepackage{amsmath,geometry,amsfonts,array,makecell,enumitem,bm,esint,booktabs,multirow,mathtools,upgreek,amssymb,pgfplots,mathrsfs}
\usepackage[amsmath]{ntheorem}
\usepackage[hidelinks,naturalnames]{hyperref}
\usepackage[nameinlink,noabbrev]{cleveref}
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhead[L]{\itshape\nouppercase{\leftmark}}
\fancyhead[R]{Ring Polymer Molecular Dynamics}

\title{Ring_Polymer}
\author{Yue Wu}

\geometry{a4paper,hmargin=1.1in,vmargin=1.2in}

\setlength{\parskip}{1em}
\tolerance=1000
\emergencystretch=1em
\hyphenpenalty=1000
\exhyphenpenalty=100
\righthyphenmin=3

\pgfplotsset{compat=1.18}

\theoremstyle{plain}\theoremheaderfont{\normalfont\itshape}\theorembodyfont{\rmfamily}\theoremseparator{.}\newtheorem*{rem}{Remark}\newtheorem*{ex}{Example}\newtheorem*{proof}{Proof}\newtheorem*{altp}{Alternative proof}

\theoremstyle{plain}\theoremheaderfont{\normalfont\bfseries}\theorembodyfont{\rmfamily}\theoremseparator{.}\newtheorem{thm}{Theorem}[section]\newtheorem{lem}[thm]{Lemma}\newtheorem{prop}[thm]{Proposition}\newtheorem*{cor}{Corollary}\newtheorem{defn}[thm]{Definition}\newtheorem{clm}[thm]{Claim}\newtheorem{clminproof}{Claim}

\theoremstyle{break}\theoremheaderfont{\normalfont\itshape}\theorembodyfont{\rmfamily}\theoremseparator{.\medskip}\newtheorem*{proofskip}{Proof}\newtheorem*{exs}{Examples}\newtheorem*{rems}{Remarks}

\theoremstyle{break}\theoremheaderfont{\normalfont\bfseries}\theorembodyfont{\rmfamily}\theoremseparator{.\medskip}\newtheorem{lemskip}[thm]{Lemma}\newtheorem{defnskip}[thm]{Definition}\newtheorem{propskip}[thm]{Proposition}\newtheorem{thmskip}[thm]{Theorem}

\crefname{thm}{Theorem}{Theorems}\crefname{defn}{Definition}{Definitions}\crefname{lem}{Lemma}{Lemmas}\crefname{lemskip}{Lemma}{Lemmas}\crefname{cor}{Corollary}{Corollaries} \crefname{prop}{Proposition}{Propositions}\crefname{clm}{Claim}{Claims}

\setcounter{tocdepth}{2}
\setcounter{section}{0}
\numberwithin{equation}{section}

\newcommand{\qed}{\hfill\ensuremath{\Box}}
\newcommand{\unit}[1]{\ \mathrm{#1}}
\newcommand{\ii}{\mathrm{i}}
\newcommand{\ee}{\mathrm{e}}
\newcommand{\tp}{^\mathrm{T}}
\newcommand{\dd}[2][]{\mathrm{d}^{#1} #2\,}
\newcommand{\DD}[1]{D #1\,}
\renewcommand{\d}[2][]{\mathrm{d}^{#1} #2}
\newcommand{\dv}[3][]{\frac{\mathrm{d}^{#1} #2}{{\mathrm{d} #3}^{#1}}}
\newcommand{\pdv}[3][]{\frac{\partial^{#1} #2}{{\partial #3}^{#1}}}
\newcommand{\bra}[1]{\left\langle #1 \right|}
\newcommand{\ket}[1]{\left| #1 \right\rangle}
\newcommand{\braket}[2]{\left\langle #1 \middle| #2 \right\rangle}
\newcommand{\mel}[3]{\left\langle #1 \middle| #2 \middle| #3 \right\rangle}
\newcommand{\redmel}[3]{\left\langle #1 \middle\| #2 \middle\| #3 \right\rangle}
\newcommand{\eval}[1]{\left\langle #1 \right\rangle}
\newcommand{\expval}[2]{\left\langle #2 \middle| #1 \middle| #2 \right\rangle}
\newcommand{\vb}[1]{\bm{\mathrm{#1}}}
\newcommand{\vu}[1]{\hat{\bm{\mathrm{#1}}}}
\newcommand{\cross}{\bm{\times}}
\newcommand{\vdot}{\bm{\cdot}}
\newcommand{\abs}[1]{\left| #1 \right|}
\newcommand{\norm}[1]{\left\| #1 \right\|}
\newcommand{\grad}{\vb{\nabla}}
\renewcommand{\div}{\vb{\nabla}\cdot}
\newcommand{\curl}{\vb{\nabla}\times}
\newcommand{\laplacian}{\nabla^2}
\renewcommand{\Re}{\operatorname{Re}}
\renewcommand{\Im}{\operatorname{Im}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\CC}{\mathbb{C}}
\DeclareMathOperator{\tr}{tr}

\usetikzlibrary{decorations.pathmorphing}

\begin{document}
    \setlength{\parindent}{0pt}
	\Huge\textsf{\textbf{Ring Polymer Molecular Dynamics}}

	\noindent\makebox[\linewidth]{\rule{\textwidth}{2pt}}

	\large\textsf{\textbf{Yue Wu}}
	\begin{itemize}[topsep=0pt,leftmargin=15pt]
		\item[] \textit{Yusuf Hamied Department of Chemistry\\
		Lensfield Road,\\
		Cambridge, CB2 1EW}\\

		\textit{yw628@cam.ac.uk}
	\end{itemize}
    \thispagestyle{empty}
    \pagenumbering{roman}
    \setlength{\parindent}{15pt}

    \normalsize
	\newpage
	\tableofcontents
	\newpage
    \pagenumbering{arabic}

    \section{Partition Function}
    For a quantum system of Hamiltonian
    \begin{equation}
        \hat{H}=\hat{T}+\hat{V}=\frac{\hat{p}^2}{2m}+V(q)\,,
    \end{equation}    
    we are often interested in the partition function
    \begin{align}
        Z&=\sum_{\ket{k}}\ee^{-\beta E_k}\notag \\
        &=\sum_{\ket{k}} \ee^{-\beta\expval{\hat{H}}{k}}\,,
    \end{align}
    where \(\{\ket{k}\}\) are the energy eigenstates. Defining the exponential of an operator via power series, one can write
    \begin{equation}
        Z=\sum_{\ket{k}}\expval{\ee^{-\beta\hat{H}}}{k}=\tr\ee^{-\beta\hat{H}}\,,
    \end{equation}
    assuming convergence.

    Since the Hamiltonian commutes with itself, one can show, by Taylor expansion, that
    \begin{equation}
        \ee^{-\beta\hat{H}}=\left[\ee^{-\frac{\beta}{n}\hat{H}}\right]^n
    \end{equation}
    We will take the \(n\to\infty\) limit of the above decomposition, which is known as the \textit{Trotter splitting}, to write
    \begin{equation}
        Z=\tr\left[\lim_{n\to\infty}\left(\ee^{-\frac{\beta}{n}\hat{H}}\right)^n\right]\,.
    \end{equation}
    The trace has the nice property that it is independent of the basis that we evaluate it in. We now expand the trace in the position basis \(\{\ket{q_1}\}\), giving
    \begin{equation}
        Z=\lim_{n\to\infty}\int\dd{q_1}\expval{\left[\ee^{-\frac{\beta}{n}\hat{H}}\right]^n}{q_1}\,.
    \end{equation}
    We have the freedom to insert identity operators
    \begin{equation}
        1=\int\dd{q_i}\ket{q_i}\bra{q_i}
    \end{equation}
    anywhere we want. We can insert \(n-1\) of them, each sandwiched between two of the \(n\) exponential operators, giving
    \begin{equation}
        Z=\lim_{n\to\infty}\int\dd{q_1}\dots\dd{q_n}\mel{q_1}{\ee^{-\frac{\beta}{n}\hat{H}}}{q_2}\mel{q_2}{\ee^{-\frac{\beta}{n}\hat{H}}}{q_3}\dots\mel{q_n}{\ee^{-\frac{\beta}{n}\hat{H}}}{q_1}\,.
    \end{equation}

    Now we have \(n\) identical-looking matrix elements in the integrand, each looks like
    \begin{equation}
        M_i=\mel{q_i}{\ee^{-\beta_n \hat{H}}}{q_{i+1}}\,,
    \end{equation}
    where we have identified \(q_{1}\equiv q_{n+1}\) and denoted \(\beta_n\coloneqq \beta /n\). We would like to evaluate this matrix element, but the Hamiltonian in the exponent will cause us some trouble, since it is made of two operators, \(\hat{H}=\hat{T}+\hat{V}\), which does not commute. To proceed, we need the following result from Lie algebra.
    \begin{lem}[Baker--Campbell--Hausdorff formula]
        For possibly non-commutative \(X\) and \(Y\) in the Lie algebra of a Lie group,
        \begin{equation}
            \ee^{X}\ee^{Y}=\ee^{Z}\,,
        \end{equation}
        where \(Z\) is given by
        \begin{equation}
            Z=X+Y+\frac{1}{2}[X,Y]+\frac{1}{12}([X,[X,Y]]+[Y,[Y,X]])+\dots,
        \end{equation}
        in which \([-,-]\) is the commutator.
    \end{lem}
    This simply states that once \(X\) and \(Y\) are non-commuting, we no longer have \(\ee^{X}\ee^{Y}=\ee^{X+Y}\) --- otherwise this would be the same as \(\ee^{Y}\ee^{X}\) and the non-commutativity will be broken. Instead, we will have some terms related to the commutators of \(X\) and \(Y\) introduced into the exponent.

    This means that if we break \(\beta_n\hat{H}=\beta_n\hat{T}+\beta_n\hat{V}\), this will lead to an error term \(\frac{1}{2}[\beta_n\hat{T},\beta_n\hat{V}]+\dots=O(n^{-2})\). We have \(n\) such terms, so the global error is \(O(n^{-1})\), which vanishes in the \(n\to\infty\) limit.

    However, we can do better than that. We can symmetrically break the Hamiltonian to
    \begin{equation}
        M_i\simeq\mel{q_i}{\ee^{-\beta_n\hat{V}/2}\ee^{-\beta_n\hat{T}}\ee^{-\beta_n\hat{V}/2}}{q_{i+1}}\,.
    \end{equation}
    By Baker--Campbell--Hausdorff formula, this symmetric decomposition will only introduce a \(O(\frac{1}{n^3})\) error in each term due to cancellation of \(O(\frac{1}{n^2})\) terms, leading to a \(O(\frac{1}{n^2})\) error globally in \(Z\). There are no difference in the above two splitting schemes as \(n\to\infty\) as both errors converges to zero, but the error in symmetric splitting is smaller when \(n\) is finite.

    Since \(\{\ket{q_i}\}\) is an eigenbasis of \(\hat{V}\)
    \begin{align}
        M_i&\simeq\mel{q_i}{\ee^{-\beta_n\hat{V}/2}\ee^{-\beta_n\hat{T}}\ee^{-\beta_n\hat{V}/2}}{q_{i+1}}\notag\\
        &=\ee^{-\beta_n V(q_i)/2}\mel{q_i}{\ee^{-\beta_n\hat{T}}}{q_{i+1}}\ee^{-\beta_n V(q_{i+1})/2}\,.
    \end{align}
    To evaluate the matrix element in the middle, we again use the trick of inserting an identity operator between the exponentials, but this time is the momentum basis, giving
    \begin{align}
        M_i&\simeq\ee^{-\beta_n V(q_i)/2}\ee^{-\beta_n V(q_{i+1})/2}\int\dd{p}\mel{q_i}{\ee^{-\beta_n\hat{T}}}{p}\braket{p}{q_{i+1}}\notag\\
        &=\ee^{-\beta_n V(q_i)/2}\ee^{-\beta_n V(q_{i+1})/2}\int\dd{p}\ee^{-\frac{\beta_n p^2}{2m}}\braket{q_i}{p}\braket{p}{q_{i+1}}\,.
    \end{align}
    The bra-kets are just the position representation of momentum eigenstates
    \begin{equation}
        \braket{q_i}{p}=\frac{1}{\sqrt{2\pi\hbar}}\ee^{\ii p q_i/\hbar}\,.
    \end{equation}
    Therefore,
    \begin{equation}
       M_i\simeq\frac{1}{2\pi\hbar}\ee^{-\beta_n V(q_i)/2}\ee^{-\beta_n V(q_{i+1})/2}\int\dd{p} \ee^{\ii p (q_i-q_{i+1})/\hbar}\ee^{-\frac{\beta_n p^2}{2m}}\,.
    \end{equation}
    We are only left with a simple Gaussian integral (after completing the square), which evaluates to
    \begin{equation}
        \int\dd{p} \ee^{\ii p (q_i-q_{i+1})/\hbar}\ee^{-\frac{\beta_n p^2}{2m}}=\sqrt{\frac{2\pi m}{\beta_n}}\exp\left(-\frac{m}{2\beta_n\hbar^2}(q_i - q_{i+1})^2\right)\,,
    \end{equation}
    and so the matrix elements are
    \begin{equation}
        M_i\simeq\sqrt{\frac{m}{2\pi\beta_n\hbar^2}}\exp\left[-\frac{m}{2\beta_n\hbar^2}(q_i - q_{i+1})^2-\frac{\beta_n[V(q_i)+V(q_{i+1})]}{2}\right]\,.
    \end{equation}
    The partition function of interest is therefore
    \begin{equation}
        Z=\lim_{n\to\infty}\left(\frac{m}{2\pi\beta_n\hbar^2}\right)^{n/2}\int\dd{q_1}\dots\dd{q_n}\exp\left[-\sum_{i=1}^{n}\left(\frac{m}{2\beta_n\hbar^2}(q_i - q_{i+1})^2+\beta_n V(q_i)\right)\right]\,.
    \end{equation}
    This form of the partition function starts to reveal its name `ring polymer'. We just need a few extra steps to get there. In particular, notice the prefactor --- it is exactly what is known as the thermal wavelength, which can be obtained by integrating the momentum degrees of freedom when evaluating the classical partition function. It is just instead of \(\beta\), we have \(\beta_n\equiv\beta/n\) here. This is the effective (inverse) temperature of our ring polymer. Observe that
    \begin{equation}
        \left(\frac{m}{2\pi\beta_n\hbar^2}\right)^{1/2}=\frac{1}{2\pi\hbar}\int\dd{p_i}\exp\left(-\frac{\beta_n p_i^2}{2m}\right)\,.
    \end{equation}
    This allows us to finally write
    \begin{align}
        Z&=\lim_{n\to\infty}\frac{1}{(2\pi\hbar)^n}\int\dd{p_1}\dd{q_1}\dots\dd{p_n}\dd{q_n}\exp\left[-\beta_n\sum_{i=1}^{n}\left(\frac{p_i^2}{2m}+\frac{m}{2\beta_n^2\hbar^2}(q_i-q_{i+1})^2+V(q_i)\right)\right]\notag\\
        &=\lim_{n\to\infty}\frac{1}{(2\pi\hbar)^n}\int\dd[n]{\vb{p}}\dd[n]{\vb{q}}\exp\left(-\beta_n H_n\right)\notag\\
        &\eqqcolon\lim_{n\to\infty} Z_n\,,
    \end{align}
    where
    \begin{equation}
        H_n=\sum_{i=1}^{n}\left[\frac{p_i^2}{2m}+\frac{m}{2\beta_n^2\hbar^2}(q_i-q_{i+1})^2+V(q_i)\right]\,.
    \end{equation}
    We see something magical here. This is exactly the classical partition function of a \(n\)-particle polymer ring system connected by springs of angular frequency \(\omega_n=\frac{1}{\beta_n\hbar}\), placed on a potential \(V\) at inverse temperature \(\beta_n\). If we take the \(n\to\infty\) limit, the partition function this polymer ring with \(n\) particles becomes that of a single quantum particle!

    \newpage

    \section{Thermal Average of an Operator}
    Suppose now we are interested in the thermal average of an operator \(\hat{A}\),
    \begin{equation}
        \eval{A}=\frac{1}{Z}\sum_{\ket{k}}\ee^{-\beta E_k}\expval{\hat{A}}{k}\,.
    \end{equation}
    If we pick \(\{\ket{k}\}\) to be the eigenstate of the Hamiltonian, then
    \begin{equation}
        \ee^{-\beta\hat{H}}\ket{k}=\ee^{-\beta E_k}\ket{k}\,,
    \end{equation}
    so
    \begin{align}
        \eval{A}&=\frac{1}{Z}\sum_{\ket{k}}\expval{\ee^{-\beta \hat{H}}\hat{A}}{k}\notag \\
        &=\frac{1}{Z}\tr[\ee^{-\beta\hat{H}}\hat{A}]\,.
    \end{align}
    We use the same trick to split the \(\ee^{-\beta\hat{H}}\) into \(n\to\infty\) parts, and equate \(Z\) with the ring polymer partition function
    \begin{equation}
        \eval{A}=\lim_{n\to\infty}\frac{1}{Z_n}\tr\left[\left(\ee^{-\beta_n\hat{H}}\right)^n\hat{A}\right]\,.
    \end{equation}
    A nice property of the trace is that it is cyclic invariant, meaning that we can move any number of slices of \(\ee^{-\beta_n\hat{H}}\) after \(\hat{A}\)
    \begin{equation}
        \eval{A}=\lim_{n\to\infty}\frac{1}{Z_n}\tr\left[\left(\ee^{-\beta_n\hat{H}}\right)^{j}\hat{A}\left(\ee^{-\beta_n\hat{H}}\right)^{n-j}\right]\,,
    \end{equation}
    where \(0\le j\le n\). We take one step further and write \(\eval{A}\) as the average of the right hand sides with \(1\le j\le n\):
    \begin{equation}
        \eval{A}=\lim_{n\to\infty}\frac{1}{n Z_n}\sum_{j=1}^{n}\tr\left[\left(\ee^{-\beta_n\hat{H}}\right)^{j}\hat{A}\left(\ee^{-\beta_n\hat{H}}\right)^{n-j}\right]\,.
    \end{equation}
    For each \(j\), we can use our good old trick of inserting identity operators between each pair of slices, giving
    \begin{equation}
        \eval{A}=\lim_{n\to\infty}\frac{1}{n Z_n}\sum_{j=1}^{n}\int\dd[n]{\vb{q}}\mel{q_1}{\ee^{-\beta_n\hat{H}}}{q_2}\dots\mel{q_j}{\ee^{-\beta_n\hat{H}}\hat{A}}{q_{j+1}}\dots\mel{q_n}{\ee^{-\beta_n\hat{H}}}{q_1}\,.
    \end{equation}
    Notice the extra \(\hat{A}\) in the \(j^{\text{th}}\) matrix element.

    \subsection{Coordinate-Dependent Quantities}
    To proceed, we assume that the operator of interest \(\hat{A}=A(\hat{q})\) is a function of coordinate only, and so \(\hat{A}\ket{q_i}=A(q_i)\ket{q_i}\). An example is the potential energy \(\hat{V}=V(\hat{q})\). Then since \(\hat{A}\ket{q}=A(q)\ket{q}\),
    \begin{equation}
        \eval{A}=\lim_{n\to\infty}\frac{1}{n Z_n}\sum_{j=1}^{n}\int\dd[n]{\vb{q}}A(q_{j+1})\mel{q_1}{\ee^{-\beta_n\hat{H}}}{q_2}\dots\mel{q_n}{\ee^{-\beta_n\hat{H}}}{q_1}\,.
    \end{equation}
    This now reduces to what we have seen before, just with an extra scalar function in the integral. We can write it as
    \begin{align}
        \eval{A}&=\lim_{n\to\infty}\frac{1}{(2\pi\hbar)^n Z_n}\int\dd[n]{\vb{p}}\dd[n]{\vb{q}} \left[\frac{1}{n}\sum_{j=1}^{n}A(q_j)\right]\ee^{-\beta_n H_n}\notag \\
        &=\lim_{n\to\infty}\frac{1}{(2\pi\hbar)^n Z_n}\int\dd[n]{\vb{p}}\dd[n]{\vb{q}} \mathcal{A}_n\ee^{-\beta_n H_n}
    \end{align}
    which is the classical thermal average of \(\mathcal{A}_n\) for the polymer ring, where
    \begin{equation}\label{ring_polymer_observable}
        \mathcal{A}_n(\vb{q})=\frac{1}{n}\sum_{i=1}^{n}A(q_i)
    \end{equation}
    is the average value of \(A\) for the \(n\) particles on the polymer ring. We reduced the quantum thermal average into the classical thermal average in a polymer ring,
    \begin{equation}
        \eval{A}=\lim_{n\to\infty}\eval{\mathcal{A}_n}\,.
    \end{equation}
    
    Therefore, if we are interested in the thermal average of some coordinate-dependent quantity of a quantum particle, we can replace it with a ring polymer of large \(n\), propagate the ring polymer classically and sample \(\eval{\mathcal{A}_n}\). This will give us \(\eval{A}\) exactly in the \(n\to\infty\) limit.

    \subsection{Kinetic Energy}
    We can also evaluate the thermal average of some other quantities, despite involving a bit more effort. We will take the kinetic energy operator \(\hat{T}=\frac{\hat{p}^2}{2m}\) as an example.

    For symmetry, we move a half extra slice of \(\ee^{-\beta_n\hat{H}}\) after \(\hat{T}\) and get
    \begin{equation}
        \eval{T}=\lim_{n\to\infty}\sum_{j=1}^{n}\int\dd[n]{\vb{q}}\mel{q_1}{\ee^{-\beta_n\hat{H}}}{q_2}\dots\mel{q_j}{\ee^{-\beta_n\hat{H}/2}\hat{T}\ee^{-\beta_n\hat{H}/2}}{q_{j+1}}\dots\mel{q_n}{\ee^{-\beta_n\hat{H}}}{q_1}\,.
    \end{equation}
    Splitting \(\hat{H}=\hat{T}+\hat{V}\) again gives
    \begin{align}
        \mel{q_j}{\ee^{-\beta_n\hat{H}/2}\hat{T}\ee^{-\beta_n\hat{H}/2}}{q_{j+1}}&=\exp\left[-\beta_n\frac{V(q_j)+V(q_{j+1})}{2}\right]\mel{q_j}{\ee^{-\beta_n\hat{T}/2}\hat{T}\ee^{-\beta_n\hat{T}/2}}{q_{j+1}}\notag\\
        &=\exp\left[-\beta_n\frac{V(q_j)+V(q_{j+1})}{2}\right]\mel{q_j}{\hat{T}\ee^{-\beta_n\hat{T}}}{q_{j+1}}\notag \\
        &=-\exp\left[-\beta_n\frac{V(q_j)+V(q_{j+1})}{2}\right]\pdv{}{\beta_n}\mel{q_j}{\ee^{-\beta_n\hat{T}}}{q_{j+1}}\notag \\
        &=-\exp\left[-\beta_n\frac{V(q_j)+V(q_{j+1})}{2}\right]\pdv{}{\beta_n}\left[\left(\frac{m}{2\pi\hbar^2\beta_n}\right)^{\frac{1}{2}}\exp\left(-\frac{m(q_j-q_{j+1})^2}{2\hbar^2\beta_n}\right)\right]\notag \\
        &=\exp\left[-\beta_n\frac{V(q_j)+V(q_{j+1})}{2}\right]\left[\frac{1}{2\beta_n}-\frac{m(q_j-q_{j+1})^2}{2\hbar^2\beta^2}\right]\mel{q_j}{\ee^{-\beta_n\hat{T}}}{q_{j+1}}\notag \\
        &=\left[\frac{1}{2\beta_n}-\frac{1}{2}m\omega_n^2(q_j-q_{j+1})^2\right]\mel{q_j}{\ee^{-\beta_n\hat{H}}}{q_{j+1}}\,.
    \end{align}
    Therefore, the quantum thermal average of kinetic energy is identical to \(n\to\infty\) limit of classical thermal average of the kinetic energy estimator \(T_n\)
    \begin{equation}
        \eval{T}=\lim_{n\to\infty}\frac{1}{(2\pi\hbar)^n Z_n}\int\dd[n]{\vb{q}}\dd[n]{\vb{p}}\mathcal{T}_n\ee^{-\beta_n H_n}=\lim_{n\to\infty}\eval{\mathcal{T}_n}\,,
    \end{equation}
    where
    \begin{equation}
        \mathcal{T}_n=\frac{1}{2\beta_n}-\frac{1}{2n}\sum_{j=1}^{n}m\omega_n^2(q_j-q_{j+1})^2\,.
    \end{equation}

    \subsection{Total Energy}
    We can trivially work out the total energy estimator by summing up the kinetic and potential energy estimators:
    \begin{equation}
        \mathcal{E}_{n, \text{TD}}=\mathcal{T}_n + \mathcal{V}_n=\frac{1}{2\beta_n}-\frac{1}{2n}\sum_{j=1}^{n}m\omega_n^2(q_j-q_{j+1})^2+\frac{1}{n}\sum_{j=1}^{n}V(q_j)\,,
    \end{equation}
    where the extra subscript TD stands for 'thermodynamic' as this estimator is known as the \textit{thermodynamic energy estimator}. This is to distinguish with another total energy estimator that will be introduced later. We than have
    \begin{equation}
        \eval{E}=\lim_{n\to\infty}\frac{1}{(2\pi\hbar)^n Z_n}\int\dd[n]{\vb{p}}\dd{\vb{q}}\mathcal{E}_{n,\text{TD}}\ee^{-\beta_n H_n}=\eval{\mathcal{E}_{n,\text{TD}}}\,.
    \end{equation}

    An alternative approach is to use the thermodynamic relation
    \begin{equation}
        \eval{E}=-\left(\pdv{\ln Z}{\beta}\right)_V\,,
    \end{equation}
    where we already have the ring polymer expression of partition function \(Z_n\). This gives the same thermodynamic energy estimator \(\mathcal{E}_{n, \text{TD}}\).

    \(\mathcal{E}_{n, \text{TD}}\) is not the only estimator that gives the total energy. The \textit{centroid virial energy estimator}
    \begin{equation}
        \mathcal{E}_{n, \text{CV}}=\frac{1}{2\beta}+\frac{1}{2n}\sum_{j=1}^{n}(q_j-\overline{q})\dv{V(q_j)}{q_j}+\frac{1}{n}\sum_{j=1}^{n}V(q_j)\,,
    \end{equation}
    where \(\overline{q}=\frac{1}{n}\sum_{k=1}^{n}q_k\) is the centroid coordinate of the polymer beads, can be shown to have the same average \(\eval{\mathcal{E}_{n, \text{CV}}}=\eval{\mathcal{E}_{n, \text{TD}}}\) as the thermodynamics energy estimator, but with a way smaller variance.
    \begin{figure}[ht!]
        \centering
        \input{files/Energy_estimator.tex}
        \caption{Average energies of a harmonic oscillator with \(\beta\hbar\omega=10\), sampled with 20000 runs using the two estimators. The error bars are the standard deviation of the energies.}
    \end{figure}
    In the example above, both thermodynamic energy estimator and centroid virial estimator converges to the exact \(\eval{E}\) as \(n\to\infty\). However, the standard deviation of the thermodynamic estimator grows asymptotically as \(\sqrt{n}\), so the required number of sample would increase linearly with \(n\) to keep the standard error in the mean constant. By contrast, the standard deviation of the centroid virial estimator is asymmetrically constant of \(n\). 

    \newpage
    \section{Propagating the Ring Polymer Dynamics}
    \subsection{Integrating the Equations of Motion}
    In the previous section, we have established that to sample the equilibrium thermal average of some quantum system, we can instead propagate the dynamics of a classical ring polymer system and sample the thermal average of the corresponding classical estimator. This is known as the \textit{path integral molecular dynamics} (PIMD).

    Given a classical Hamiltonian \(H(\vb{p},\vb{q})\) with initial conditions \(\vb{p}(0)=\vb{p}_0\), \(\vb{q}(0)=\vb{q}_0\), the evolution of the system is governed deterministically by the Hamilton's equation
    \begin{align}
        \dot{\vb{p}}=-\pdv{H}{\vb{q}} \\
        \dot{\vb{q}}=+\pdv{H}{\vb{p}}\,.
    \end{align}
    For our Hamiltonian \(H=\frac{\vb{p}^2}{2m}+V(\vb{q})\), this is
    \begin{align}
        \dot{\vb{p}}=-\pdv{V}{\vb{q}} \\
        \dot{\vb{q}}=+\frac{\vb{p}}{m}
    \end{align}
    as one would expect from Newton's second law.

    These are a set of differential equations, and to work out the trajectory, we need to integrate these equations of motion. The most common way to do this is to use the velocity Verlet algorithm (see my notes on NST Part II C8: \textit{Computer Simulation Methods}), in which the following steps are carried out iteratively to propagate the dynamics:
    \begin{align}
        \vb{p}_{n+\frac{1}{2}}&=\vb{p}_{n}-\frac{\delta t}{2}\pdv{V}{\vb{q}}(\vb{q}_{n})  \\
        \vb{q}_{n+1}&=\vb{q}+\delta t\frac{\vb{p}_{n+\frac{1}{2}}}{m} \\
        \vb{p}_{n+1}&=\vb{p}_{n+\frac{1}{2}}-\frac{\delta t}{2}\pdv{V}{\vb{q}}(\vb{q}_{n+1})\,.
    \end{align}
    This propagates the momenta under \(V\) by half a time step, propagates the coordinates by a full time step, and then propagate the momenta by another time step, corresponding to symmetrically splitting the time evolution operator by
    \begin{equation}
        \ee^{-\mathcal{L}\delta t}\simeq \ee^{-\mathcal{L}_V\delta t/2}\ee^{-\mathcal{L}_T \delta t}\ee^{-\mathcal{L}_V/2}\,.
    \end{equation}
    This is accurate to \(O(\delta t^3)\) for each time step (\(O(\delta t^2)\) globally), and is better than propagating the coordinates and momenta by a full time step simultaneously, which is known as the Euler's algorithm and is accurate to \(O(\delta t^2)\) each step and \(O(\delta t)\) globally.

    For path integral molecular dynamics, we can of course directly use the standard velocity Verlet algorithm with Hamiltonian
    \begin{equation}
        H_n(\vb{p},\vb{q})=\frac{\vb{p}^2}{2m}+V(\vb{q})\,,
    \end{equation}
    where
    \begin{equation}
        V(\vb{q})=\sum_{j=1}^{n}\left[\frac{1}{2}m\omega_n^2(q_j-q_{j+1})^2+V(q_j)\right]\,,
    \end{equation}
    to propagate the dynamics. However, the harmonic springs between the beads are stiff, especially with large \(n\) (\(\omega_n=n/\beta\hbar\)). This requires a very small time step for us to propagate the internal vibrations of the ring polymer beads accurately. (Usually a time step of \(1/20\) of the shortest characteristic vibrational time scale of the system is safe.)

    Luckily, we know how to solve the vibrational motions of systems connected by harmonic springs exactly! We can break them down to normal modes and propagate these internal normal modes exactly. (See NST Part II C8: \textit{Further Quantum Mechanics} or NST Part IB Mathematical Methods.) We break down the Hamiltonian as
    \begin{equation}
        H_{n}(\vb{p},\vb{q})=H_{n,0}(\vb{p},\vb{q})+V_{n}(\vb{q})\,,
    \end{equation}
    where
    \begin{equation}
        H_{n, 0}=\sum_{j=1}^{n}\left[\frac{p_j^2}{2m}+\frac{1}{2}m\omega_n^2(q_j-q_{j+1})^2\right]
    \end{equation}
    is the free ring polymer Hamiltonian without the external potential and
    \begin{equation}
        V_n(\vb{q})=\sum_{j=1}^{n}V(q_j)
    \end{equation}
    is the external potential. Since the potential of the free ring polymer Hamiltonian \(H_0(\vb{p},\vb{q})\) is harmonic, it can be diagonalised with a normal mode transformation
    \begin{equation}\label{normal_mode_transformation}
        \begin{cases}
            \tilde{p}_k=\sum_{j=1}^{n}p_jC_{jk}\\
            \tilde{q}_k=\sum_{j=1}^{n}q_jC_{jk}\,,
        \end{cases}
    \end{equation}
    where
    \begin{equation}
        C_{jk}=\begin{cases}
            \sqrt{1/n} & k=0 \\
            \sqrt{2/n}\cos(2\pi jk/n) & 1\le k\le n/2 -1 \\
            \sqrt{1/2} (-1)^j & k=n/2 \\
            \sqrt{2/n}\sin(2\pi jk/n) &n/2+1 \le k \le n\,,
        \end{cases}
    \end{equation}
    giving
    \begin{equation}
        H_0(\tilde{\vb{p}},\tilde{\vb{q}})=\sum_{k=0}^{n-1}\left[\frac{\tilde{p}_k^2}{2m}+\frac{1}{2}m\omega_k^2\tilde{q}_k^2\right]
    \end{equation}
    with
    \begin{equation}
        \omega_k=2\omega_n\sin\left(\frac{k\pi}{n}\right)\,.
    \end{equation}
    Notice that we have shifted the range of indices from \(1\le j\le n\) to \(0\le k\le n-1\). You should be familiar with this because \(C_{jk}\) and \(\omega_k^2\) are actually exactly the H\"{u}ckel molecular orbital coefficients and the orbital energies of a cyclic polyene. This is because the H\"{u}ckel matrix of a cyclic polyene and the potential energy matrix of a ring polymer are exactly the same:
    \begin{equation}
        \mathsf{H}_{\text{polyene}}=\begin{pmatrix}
            \alpha & \beta & 0 & \cdots & \beta \\
            \beta & \alpha & \beta & \cdots & 0 \\
            0 & \beta & \alpha & \cdots & 0 \\
            \vdots & \vdots & \vdots & \ddots & \vdots \\
            \beta & 0 & 0 & \cdots & \alpha
        \end{pmatrix}\quad\stackrel{\alpha=2,\beta=-1}{\longleftrightarrow}\quad\mathsf{V}=\begin{pmatrix}
            2 & -1 & 0 & \cdots & -1 \\
            -1 & 2 & -1 & \cdots & 0 \\
            0 & -1 & 2 & \cdots & 0 \\
            \vdots & \vdots & \vdots & \ddots & \vdots \\
            -1 & 0 & 0 & \cdots & 2
        \end{pmatrix}
    \end{equation}
    such that \(\sum_{j=1}^{n}(q_j-q_{j+1})^2=\vb{q}\tp \mathsf{V}\vb{q}\). Moreover, the normal mode transformation (\ref{normal_mode_transformation}) is exactly the discrete Fourier transform, which can be efficiently carried out using the Fast Fourier Transform (FFT) algorithm with a scaling no larger than \(O(n\log n)\).

    In the normal mode coordinates, the Hamiltonian \(H_{0,n}\) is broken down into \(n\) independent harmonic oscillators, each evolving sinusoidally
    \begin{equation}
        \begin{cases}
            \tilde{q}_k=A_k\sin(\omega_k t) + B_k\cos(\omega_k t) \\
            \tilde{p}_k=mA_k\omega_k\cos(\omega_k t) - mB_k\omega_k\cos(\omega_k t)\,.
        \end{cases}
    \end{equation} 
    
    To overall idea is therefore breaking down the ring polymer evolution by
    \begin{equation}
        \ee^{-\mathcal{L}\delta t}=\ee^{-\mathcal{L}_V\delta /2}\ee^{-\mathcal{L}_0\delta t}\ee^{-\mathcal{L}_V\delta t/2}\,,
    \end{equation}
    i.e. evolve the momenta by the external potential for half a time step, transform into the normal mode coordinates, evolve the coordinates and momenta by the internal ring normal modes for a full time step, revert back to the real coordinates, and finally evolve the momenta by the external potential for half a time step. The detailed algorithm is
    \begin{align}
        \vb{p}'&=\vb{p}_n-\frac{\delta t}{2}\dv{V}{\vb{q}}(\vb{q}_n)\\
        \tilde{\vb{p}}'&=\mathsf{C}\tp\vb{p}'\\
        \tilde{\vb{q}}'&=\mathsf{C}\tp\vb{q}_n\\
        \begin{pmatrix}
            \tilde{p}_k'' \\
            \tilde{q}_k''
        \end{pmatrix}&=\begin{pmatrix}
            \cos\omega_k\delta t & -m\omega_k \sin\omega_k\delta t \\
            \frac{1}{m\omega_k}\sin\omega_k\delta t & \cos\omega_k\delta t
        \end{pmatrix}\begin{pmatrix}
            \tilde{p}_k' \\
            \tilde{q}_k'
        \end{pmatrix} \\
        \vb{p}''&=\mathsf{C}\tilde{\vb{p}}''\\
        \vb{q}_{n+1}&=\mathsf{C}\tilde{\vb{q}}''\\
        \vb{p}_{n+1}&=\vb{p}''-\frac{\delta t}{2}\dv{V}{\vb{q}}(\vb{q}_{n+1})
    \end{align}

    \subsection{Sampling in Canonical Ensemble}
    The above algorithm well propagates the dynamics of the ring polymer in a microcanonical ensemble, but we can't use them to calculate canonical thermal averages because
    \begin{itemize}
        \item The above algorithm rigorously conserves the energy \(H_n\). Instead in a canonical ensemble with constant energy, the phase space should be sampled with all possible \(H_n\) weighted by their Boltzmann factors.
        \item It is far from ergodic. If the external potential is harmonic, then the whole \(H_n\) is diagonal in the normal mode representation and hence there is no energy flow between the normal modes. If the external potential is instead mildly anharmonic, then the energy exchanges between modes very slowly. It is therefore not even possible to fully sample the microcanonical constant energy hypersurface in the phase space ergodically within the typical timescale of a simulation.
    \end{itemize}

    Therefore to meaningfully work out a thermal average, we need to attach a thermostat to our ring polymer system. Here we will briefly introduce the path integral Langevin equation (PILE) thermostat.

    \subsubsection{The Path Integral Langevin Equation Thermostat}
    The PILE thermostat attaches a separate Langevin thermostat to each internal mode of the free ring polymer, so that the free polymer would evolve by
    \begin{align}
        \dv{}{t}\tilde{q}_k&=\frac{\tilde{p}_k}{m} \\
        \dv{}{t}\tilde{p}_k&=-m\omega_k^2\tilde{q}_k-\gamma_k\tilde{p}_k+\sqrt{\frac{2m\gamma_k}{\beta_n}}\xi_k(t)\,,\label{Langevin_momentum}
    \end{align}
    where \(\gamma_k(t)\) represents an uncorrelated, Gaussian-distributed random form with unit variance and zero mean:
    \begin{equation}
        \eval{\xi_k(t)}=0\qquad \eval{\xi_k(0)\xi_k(t)}=\delta(t)\,,
    \end{equation}
    and the \textit{friction coefficients} \(\gamma_k\) governs the rate at which the velocities are thermalised. The first term in (\ref{Langevin_momentum}) is the free evolution of a microcanonical harmonic oscillator, and the two extra terms are from the Langevin thermostat. Their origins are explained in NST Part II B7: \textit{Statistical Mechanics}.

    The PILE thermostat uses the propagator
    \begin{equation}
        \ee^{-\mathcal{L}_\gamma \delta t/2}\ee^{-\mathcal{L}_V\delta t/2}\ee^{-\mathcal{L}_0\delta t}\ee^{-\mathcal{L}_V\delta t/2}\ee^{-\mathcal{L}_\gamma\delta t/2}\,,
    \end{equation}
    where the extra thermostatting steps (\(\ee^{-\mathcal{L}_\gamma\delta t/2}\)) implements the last two extra terms in (\ref{Langevin_momentum}). They are implemented by
    \begin{align}
        \tilde{p}_k &= \sum_{j=1}^{n} p_j C_{jk} \\
        \tilde{p}_k &= \ee^{-\gamma_k \delta t/2}\tilde{p}_k + \sqrt{\frac{m(1-\ee^{-\gamma_k \delta t})}{\beta_n}}\xi_k \\
        p_j &=\sum_{k=1}^{n}C_{jk}\tilde{p}_k\,,
    \end{align}
    where \(\xi_k\) is a independent Gaussian number randomly drawn from a Gaussian distribution with zero mean and unit variance each time.

    The friction coefficients \(\gamma_k\) governs the rate at which the momenta in each mode is thermalised (randomised). The autocorrelation time
    \begin{equation}
        \tau_V=\frac{1}{\eval{V^2}-\eval{V}^2}\int_{0}^{\infty}\dd{t}\eval{(V(0)-\eval{V})(V(t)-\eval{V})}
    \end{equation}
    of the free ring polymer mode potential \(V=\frac{1}{2}m\omega_k^2\tilde{q}_k^2\) can be worked out analytically to be
    \begin{equation}
        \tau_V=\frac{1}{2\gamma_k}+\frac{\gamma_k}{2\omega_k^2}
    \end{equation}
    for \(\omega_k>0\). The optimum friction coefficient is the one that minimises \(\tau_V\) (and hence samples the most efficiently), which is \(\gamma_k=\omega_k\). This leaves only a single physical parameter \(\tau_0\) to be specified for thermostatting the centroid mode \(k=0\).
    \begin{equation}
        \gamma_k = \begin{cases}
            1/\tau_0 & k=0 \\
            \omega_k & k\ne 0\,.
        \end{cases}
    \end{equation}

    \newpage
    \section{Generalisation for Multipaticle System}
    The above equations are derived for the one-particle one-dimensional quantum mechanical problem with Hamiltonian
    \begin{equation}
        \hat{H}=\frac{\hat{p}^2}{2m}+V(\hat{q})\,.
    \end{equation}
    The generalisation to higher dimensions is trivial, and in the absence of quantum mechanical exchange effects for identical particles (fermionic and bosonic), it is also straightforward to generalise to multiparticle systems. For example, the Hamiltonian
    \begin{equation}
        \hat{H}=\sum_{i=1}^{N}\frac{\hat{\vb{p}}_i^2}{2m_i}+V(\hat{\vb{r}}_i,\hat{\vb{r}}_2,\dots,\hat{\vb{r}}_N^2)
    \end{equation}
    have the ring polymer Hamiltonian
    \begin{equation}
        H_n(\{\vb{p}_i\},\{\vb{r}_i\})=\sum_{i=1}^{N}\sum_{j=1}^{n}\left[\frac{\vb{p}_{i,j}^2}{2m_i}+\frac{1}{2}m_i\omega_n^2\norm{\vb{r}_{i,j}-\vb{r}_{i,j+1}}^2\right]+\sum_{j=1}^{n}V(\vb{r}_{1,j},\dots,\vb{r}_{N,j})\,.
    \end{equation}

    \begin{figure}[ht!]
        \centering
        \begin{tikzpicture}[decoration = {snake,amplitude=1.2pt,segment length=2mm}]
            \fill (0,1) node (A1) {} circle (0.1);
            \fill (-1,0.7) node (A2) {} circle (0.1);
            \fill (-0.6,-0.3) node (A3) {} circle (0.1);
            \fill (0.8,-0.4) node (A4) {} circle (0.1);
            \fill (0.9,0.5) node (A5) {} circle (0.1);
            \draw[decorate] (A1)--(A2)--(A3)--(A4)--(A5)--(A1);

            \fill (5,1.2) node (B1) {} circle (0.1);
            \fill (4.2,0.6) node (B2) {} circle (0.1);
            \fill (4.5,-0.4) node (B3) {} circle (0.1);
            \fill (6,-0.6) node (B4) {} circle (0.1);
            \fill (5.9,0.5) node (B5) {} circle (0.1);
            \draw[decorate] (B1)--(B2)--(B3)--(B4)--(B5)--(B1);

            \draw[dashed] (A1)--(B1);
            \draw[dashed] (A2)--(B2);
            \draw[dashed] (A3)--(B3);
            \draw[dashed] (A4)--(B4);
            \draw[dashed] (A5)--(B5);
        \end{tikzpicture}
        \caption{Two interacting ring polymers with \(n=5\).}
    \end{figure}

    Identical particle exchange effects become important when the de Broglie thermal wavelengths \(\Lambda_i(T)=h/\sqrt{2\pi m_i k_B T}\) exceed the hard sphere diameters of the atoms. These effects can in principle be included by considering dimerisation, trimerisation, etc. of ring polymers (see Chandler and Wolynes). However, it is hardly ever necessary for those of us who work in chemistry departments to have to worry about them, because these effects are almost always negligible, e.g. in liquid para-hydrogen even at its melting temperature (\(13.8\unit{K}\)).






    \newpage
    \section{Ring Polymer Molecular Dynamics}
    Usually we are not just interested with the static thermal average \(\eval{A}\) of a quantum system. Instead we are interested time correlation functions.
    \begin{defn}
        The \textit{correlation function} of two observables \(A\) and \(B\) is
        \begin{equation}
            C_{AB}(t)\coloneqq\frac{1}{Z}\tr[\ee^{-\beta\hat{H}}\hat{A}\ee^{\ii\hat{H}t/\hbar}\hat{B}\ee^{-\ii\hat{H}t/\hbar}]\,.
        \end{equation}
    \end{defn}
    The rationalisation of this is that in the Heisenberg picture, the operator \(\hat{B}\) evolves as
    \begin{equation}
        \hat{B}(t)=\ee^{\ii\hat{H}t/\hbar}\hat{B}(0)\ee^{-\ii\hat{H}t/\hbar}\,,
    \end{equation}
    while the energy eigenstates are not changing, so
    \begin{align}
            C_{AB}(t)&=\frac{1}{Z}\tr[\ee^{-\beta\hat{H}}\hat{A}(0)\hat{B}(t)]\notag\\
            &=\frac{1}{Z}\sum_{\ket{n}}\expval{\ee^{-\beta \hat{H}}\hat{A}(0)\hat{B}(t)}{n}\notag \\
            &=\frac{1}{Z}\sum_{\ket{n}}\ee^{-\beta E_n}\expval{\hat{A}(0)\hat{B}(t)}{n}\notag \\
            &=\eval{A(0)B(t)}\,.
    \end{align}
    These correlation functions are useful because a lot of dynamical properties, like the diffusion coefficient, reaction rate constants and dipole absorption spectra can be related to those correlation functions by Green--Kubo relations. We need to figure out a way to calculate these correlation functions using ring polymers.

    Suppose now we have two coordinate-dependent operators \(\hat{A}\) and \(\hat{B}\) of interest, with classical ring-polymer counterparts \(\mathcal{A}_n\) and \(\mathcal{B}_n\) defined analogous to (\ref{ring_polymer_observable}). What does the \(n\to\infty\) limit of
    \begin{equation}
        \eval{\mathcal{A}_n \mathcal{B}_n}=\frac{1}{Z_n}\int\dd[n]{\vb{p}}\dd[n]{\vb{q}}\mathcal{A}_n \mathcal{B}_n \ee^{-\beta_n H_n}
    \end{equation}
    corresponds to? A naive guess would be
    \begin{equation}
        \eval{AB}\stackrel{?}{=}\lim_{n\to\infty}\eval{\mathcal{A}_n \mathcal{B}_n}\,,
    \end{equation}
    but this is actually wrong. To see this, we expand
    \begin{align}
        \eval{\mathcal{A}_n \mathcal{B}_n}&=\frac{1}{n^2}\sum_{i,j=1}^{n}\eval{A(q_i)B(q_j)}\,,
    \end{align}
    but to get \(\eval{AB}\) in the \(n\to\infty\) limit, we would need
    \begin{equation}
        \eval{AB}=\lim_{n\to\infty}\frac{1}{n}\sum_{i=1}^{n}\eval{A(q_i)B(q_i)}\,.
    \end{equation}
    These two are obviously unequal in general. Instead, rather surprisingly, the \(n\to \infty\) limit of \(\eval{\mathcal{A}_n \mathcal{B}_n}\) actually corresponds to something closely related to the correlation function.
    \begin{defn}
        The \textit{Kubo-transformed correlation function} of two observables \(A\) and \(B\) is
        \begin{equation}
            K_{AB}(t)\coloneqq\frac{1}{\beta Z}\int_{0}^{\beta}\dd{\lambda}\tr[\ee^{-(\beta-\lambda)\hat{H}}\hat{A}\ee^{-\lambda\hat{H}}\ee^{\ii\hat{H}t/\hbar}\hat{B}\ee^{-\ii\hat{H}t/\hbar}]\,.
        \end{equation}
    \end{defn}
    Let's have a closer look at what this means. In addition to the Boltzmann factor \(\ee^{-\lambda\hat{H}}\) and evolved \(\hat{B}\) operator \(\hat{B}(t)=\ee^{\ii\hat{H}t/\hbar}\hat{B}\ee^{-\ii\hat{H}t/\hbar}\) in the trace, we also have changed our \(\hat{A}\) operator by
    \begin{equation}
        \ee^{\lambda\hat{H}}\hat{A}\ee^{-\lambda\hat{H}}
    \end{equation}
    with an averaging over \(\lambda\) from \(0\) to \(\beta\) by the integral \(\frac{1}{\beta}\int_{0}^{\beta}\). Notice that this is similar to the time evolution we've done on \(\hat{B}\), but this time there is no factor of \(\ii\) in the exponent. We can interpret this as \textit{imaginary-time evolution},
    \begin{equation}
        \hat{A}(-\ii\hbar\lambda)=\ee^{\lambda\hat{H}}\hat{A}\ee^{-\lambda\hat{H}}\,.
    \end{equation}
    Hence in the Kubo-transformed correlation function, we are also averaging over the imaginary time of \(\hat{A}\) from \(t=0\) to \(t=-\ii\hbar\beta\). This allows us to compactly denote the Kubo-transformed correlation function as
    \begin{equation}
        K_{AB}(t)=\frac{1}{\beta}\int_{0}^{\beta}\dd{\lambda}\eval{\hat{A}(-i\hbar\lambda)\hat{B}(t)}\,.
    \end{equation}

    The ordinary correlation function and the Kubo-transformed one are more closely related in the Fourier domain. This is easily seen if we work in the basis of energy eigenstates. Inserting the resolution of identity operators in the energy basis,
    \begin{align}
        C_{AB}(t)&=\frac{1}{Z}\sum_{\ket{k}}\sum_{\ket{\ell}}\sum_{\ket{m}}\mel{k}{\ee^{-\beta\hat{H}}\hat{A}}{\ell}\mel{\ell}{\ee^{\ii\hat{H}t/\hbar}}{m}\mel{m}{\hat{B}\ee^{-\ii\hat{H}t/\hbar}}{k}\notag \\
        &=\frac{1}{Z}\sum_{\ket{k}}\sum_{\ket{\ell}}\sum_{\ket{m}}\ee^{-\beta E_k}\ee^{-\ii E_k t/\hbar}\ee^{\ii E_\ell t/\hbar}\delta_{m\ell}A_{km}B_{\ell k}\notag \\
        &=\frac{1}{Z}\sum_{\ket{k}}\sum_{\ket{m}}\ee^{-\beta E_k}\ee^{-\ii(E_k-E_m)t/\hbar}A_{km}B_{mk}\,.
    \end{align}
    Doing the same for the Kubo-transformed correlation function, we get
    \begin{align}
        K_{AB}(t)&=\frac{1}{\beta Z}\int_{0}^{\beta}\dd{\lambda}\sum_{\ket{k}}\sum_{\ket{\ell}}\sum_{\ket{m}}\mel{k}{\ee^{-\beta\hat{H}\ee^{\lambda \hat{H}}}\hat{A}}{\ell}\mel{\ell}{\ee^{-\lambda\hat{H}}\ee^{\ii\hat{H}t/\hbar}}{m}\mel{m}{\hat{B}\ee^{-\ii\hat{H}t/\hbar}}{k}\notag \\
        &=\frac{1}{Z}\sum_{\ket{k}}\sum_{\ket{m}}\ee^{-\beta E_k}\ee^{-\ii(E_k-E_m)t/\hbar}A_{km}B_{mk}\frac{1}{\beta}\int_{0}^{\beta}\dd{\lambda}\ee^{\lambda(E_k-E_m)}\notag\\
        &=\frac{1}{Z}\sum_{\ket{k}}\sum_{\ket{m}}\ee^{-\beta E_k}\ee^{-\ii(E_k-E_m)t/\hbar}A_{km}B_{mk}\frac{\ee^{\beta(E_k-E_m)}-1}{\beta(E_k-E_m)}\,.
    \end{align}
    It has got some extra bit comparing with the normal correlation function --- but it is dependent on \(E_k-E_m\), so we can't easily pull it out from the sum. Nice things happen if we move to the Fourier domain. We get
    \begin{align}
        \tilde{K}_{AB}(\omega)&=\int_{-\infty}^{\infty}\dd{t} \ee^{-\ii\omega t}K_{AB}(t)\notag \\
        &=\frac{1}{Z}\sum_{\ket{k}}\sum_{\ket{m}}\ee^{-\beta E_k}A_{km}B_{mk}\frac{\ee^{\beta(E_k-E_m)}-1}{\beta(E_k-E_m)}\int_{-\infty}^{\infty}\dd{t}\ee^{-\ii\omega t}\ee^{-\ii(E_k-E_m)t/\hbar}\,.
    \end{align}
    If you're familiar with Fourier transform, you should identify that this is exactly the delta function,
    \begin{equation}
        \int_{-\infty}^{\infty}\dd{t}\ee^{-\ii\omega t}\ee^{-\ii(E_k-E_m)t/\hbar}=2\pi\delta\left(\frac{E_m-E_k}{\hbar}-\omega\right)\,,
    \end{equation}
    and so
    \begin{equation}
        \tilde{K}_{AB}(\omega)=\frac{1}{Z}\sum_{\ket{k}}\sum_{\ket{m}}\ee^{-\beta E_k}A_{km}B_{mk}\frac{\ee^{\beta(E_k-E_m)}-1}{\beta(E_k-E_m)}2\pi\delta\left(\frac{E_m-E_k}{\hbar}-\omega\right)\,.
    \end{equation}
    The delta function naturally imposes the condition \(E_m=E_k+\hbar\omega\), so it reduces the double sum to a single sum,
    \begin{equation}
        \tilde{K}_{AB}(\omega)=\frac{1}{Z}\sum_{\ket{k}}\ee^{-\beta E_k}A_{km}B_{mk}\frac{1-\ee^{-\beta\hbar\omega}}{\beta\hbar\omega}2\pi\delta(0)\,.
    \end{equation}
    Now the extra factor from the integral over \(\lambda\) is independent of \(\ket{k}\), so we can pull it out from the sum
    \begin{equation}
        \tilde{K}_{AB}(\omega)=\frac{1-\ee^{-\beta\hbar\omega}}{\beta\hbar\omega}\frac{2\pi}{Z}\sum_{\ket{k}}\ee^{-\beta E_k}A_{km}B_{mk}\delta(0)\,.
    \end{equation}
    The Fourier transform of the normal correlation function is exactly the same except without this extra factor
    \begin{equation}
        \tilde{C}_{AB}(\omega)=\frac{2\pi}{Z}\sum_{\ket{n}}\ee^{-\beta E_k}A_{km}B_{mk}\delta(0)\,,
    \end{equation}
    and so
    \begin{equation}
        \tilde{K}_{AB}(\omega)=\frac{1-\ee^{-\beta\hbar\omega}}{\beta\hbar\omega}\tilde{C}_{AB}(\omega)\,.
    \end{equation}
    Notice also that in the classical limit, the energy spectrum becomes a continuum with \(\beta\hbar\omega\to 0\), and so
    \begin{equation}
        \tilde{K}_{AB}(\omega)\to \tilde{C}_{AB}(\omega)\,.
    \end{equation}
    




    \subsection{Relation to Ring Polymer Average}

    Having established what the Kubo-transformed correlation function is, let's see how it is related to the ring-polymer average of two observables.
    \begin{clm}
        The \(n\to\infty\) limit of \(\eval{\mathcal{A}_n \mathcal{B}_n}\) for the classical ring polymer is the \(t\to 0\) limit of the Kubo-transformed correlation function
        \begin{equation}
            \lim_{n\to\infty}\eval{\mathcal{A}_n \mathcal{B}_n}=K_{AB}(0)\,.
        \end{equation}
    \end{clm}
    \begin{proof}
        At \(t=0\),
        \begin{equation}
            K_{AB}(0)=\frac{1}{\beta Z}\int_{0}^{\beta}\dd{\lambda}\tr[\ee^{-(\beta-\lambda)\hat{H}}\hat{A}\ee^{-\lambda\hat{H}}\hat{B}]\,.
        \end{equation}
        Consider again Trotter-splitting the exponential of the Hamiltonians, but this time
        \begin{equation}
            \ee^{-(\beta-\lambda)\hat{H}}=\left(\ee^{-\beta\hat{H}}\right)^{\frac{\beta-\lambda}{\beta}}=\lim_{n\to\infty}\left(\ee^{-\beta_n\hat{H}}\right)^{n(1-\frac{\lambda}{\beta})}\,,
        \end{equation}
        and similarly
        \begin{equation}
            \ee^{-\lambda\hat{H}}=\lim_{n\to\infty}\left(\ee^{-\beta_n\hat{H}}\right)^{n\frac{\lambda}{\beta}}\,.
        \end{equation}
        Therefore,
        \begin{equation}
            K_{AB}(0)=\lim_{n\to\infty}\frac{1}{\beta Z_n}\int_{0}^{\beta}\dd{\lambda}\tr\left[\left(\ee^{-\beta_n\hat{H}}\right)^{n(1-\frac{\lambda}{\beta})}\hat{A}\left(\ee^{-\beta_n\hat{H}}\right)^{n\frac{\lambda}{\beta}}\hat{B}\right]\,.
        \end{equation}
        Let's consider the effect of the integral averaging over \(\lambda\): \(\frac{1}{\beta}\int_{0}^{\beta}\). There are \(n(1-\frac{\lambda}{\beta})\) pieces of \(\ee^{-\beta_n \hat{H}}\) in front of \(\hat{A}\) and \(n\frac{\lambda}{\beta}\) between \(\hat{A}\) and \(\hat{B}\). What the integral does is averaging over the number of \(\ee^{-\beta_n \hat{H}}\) pieces distributed between these two places, while making sure that there are \(n\) of them in total. When \(n\) is large, this can be replaced by the sum
        \begin{equation}
            \frac{1}{\beta}\int_{0}^{\beta}\dd{\lambda}f(\lambda)\longmapsto \lim_{n\to\infty}\frac{1}{n}\sum_{\lambda=1}^{n}f\left(\lambda\beta_n\right)\,.
        \end{equation}
        Therefore we can write
        \begin{equation}
            K_{AB}(0)=\lim_{n\to\infty}\frac{1}{n Z_n}\sum_{k=1}^{n}\tr\left[\left(\ee^{-\beta_n\hat{H}}\right)^{k}\hat{A}\left(\ee^{-\beta_n\hat{H}}\right)^{n-k}\hat{B}\right]\,.
        \end{equation}
        Now there are \(n+2\) operators in the trace. We again use the trick of inserting identity operators between them, while associating \(\hat{A}\) and \(\hat{B}\) to the \(\ee^{-\beta_n\hat{H}}\) in front of them, giving
        \begin{equation}
            \lim_{n\to\infty}\frac{1}{Z_n}\frac{1}{n}\sum_{k=1}^{n}\int\dd[n]{\vb{q}}\dots\mel{q_k}{\ee^{-\beta_n \hat{H}}\hat{A}}{q_{k+1}}\dots\mel{q_n}{\ee^{-\beta_n\hat{H}}\hat{B}}{q_1}\,.
        \end{equation}
        Another property of the trace we can exploit is its cyclic invariance. This means that we can move any slice of bra-kets at front to the end, and vice versa. This means that
        \begin{align}
            K_{AB}(0)=\int\dd[n]{\vb{q}}\dots\mel{q_k}{\ee^{-\beta_n \hat{H}}\hat{A}}{q_{k+1}}&\dots\mel{q_n}{\ee^{-\beta_n\hat{H}}\hat{B}}{q_1}\notag\\
            &=\int\dd[n]{\vb{q}}\dots\mel{q_i}{\ee^{-\beta_n \hat{H}}\hat{A}}{q_{i+1}}\dots\mel{q_{j}}{\ee^{-\beta_n\hat{H}}\hat{B}}{q_{j+1}}\dots\,,
        \end{align}
        as long as \(\abs{j-i}=k\). We average over all possible cyclic permutations of the trace --- there are \(n\) of them for each interval \(k\). This is effectively putting \(\hat{A}\) and \(\hat{B}\) into all possible slices of bra-kets. Therefore we can write
        \begin{align}
            K_{AB}(0)&=\lim_{n\to\infty}\frac{1}{Z_n}\frac{1}{n^2}\sum_{i,j=1}^{n}\int\dd[n]{\vb{q}}\dots\mel{q_i}{\ee^{-\beta_n \hat{H}}\hat{A}}{q_{i+1}}\dots\mel{q_j}{\ee^{-\beta_n\hat{H}}\hat{B}}{q_{j+1}}\dots\notag\\
            &=\lim_{n\to\infty}\frac{1}{Z_n}\int\dd[n]{\vb{p}}\dd[n]{\vb{q}}\mathcal{A}_n \mathcal{B}_n \ee^{-\beta_n H_n}\notag\\
            &=\lim_{n\to\infty}\eval{\mathcal{A}_n \mathcal{B}_n}\,,
        \end{align}
        which is exactly what we claimed.\qed


    \end{proof}




\end{document}